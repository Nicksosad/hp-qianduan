```
<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>视觉小说游戏</title><link rel="stylesheet" href="https://unpkg.com/@arco-design/web-react/dist/css/arco.css"><script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script><script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script><script src="https://unpkg.com/@arco-design/web-react/dist/arco.min.js"></script><style>:root {
      --global-radius: 16px;
      --dialogue-background: rgba(255,255,255,0.85);
      --dialogue-text-color: #222222;
      --dialogue-font-size: 17px;
      --panel-text-color: #f3f3f3;
      --panel-bg: rgba(26,26,26,0.78);
      --sms-incoming-bg: rgba(255,255,255,0.16);
      --sms-incoming-color: var(--panel-text-color);
      --sms-outgoing-bg: linear-gradient(135deg, rgba(255,255,255,0.94), rgba(204,220,255,0.7));
      --sms-outgoing-color: #1f2330;
      --sms-outgoing-border: rgba(255,255,255,0.55);
      --sms-outgoing-shadow: 0 12px 28px rgba(0,0,0,0.24);
      --sms-name-color: var(--panel-text-color);
      --sms-player-name-color: rgba(245,246,255,0.85);
      --control-icon-bg: rgba(18,18,20,0.76);
      --control-icon-color: #f2f2f2;
      --control-button-size: 44px;
      --control-icon-svg-size: 22px;
      --dialogue-blur: 6px;
      --panel-blur: 14px;
      --panel-blur-strong: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: transparent;
      color: #fff;
      font-family: "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      
      overflow: hidden;
    }
    #responsive-container {
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      position: relative;
      aspect-ratio: 9 / 16;
      overflow: hidden;
      background: rgba(0,0,0,0.55);
      border-radius: 18px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.45);
      transition: aspect-ratio .35s ease, max-width .35s ease;
      will-change: transform;
    }
    #responsive-container.desktop-mode {
      aspect-ratio: 16 / 9;
      max-width: 1280px;
    }
    #content-wrapper {
      position: absolute;
      inset: 0;
      overflow: hidden;
      border-radius: inherit;
      transition: transform .8s ease;
      will-change: transform;
    }
    .background-element,
    .cg-element {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity .35s ease, transform .8s ease;
      will-change: opacity, transform;
      pointer-events: none;
    }
    /* 主背景图保持裁剪填充（cover） */
    #background-img {
      object-fit: cover;
      object-position: center;
    }
    /* 铺底层：使用同一张图 cover + 模糊暗化，填补边缘 */
    .background-fill {
      position: absolute;
      inset: 0;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      filter: blur(2px) brightness(0.9) saturate(1.05);
      transform: scale(1.08);
      will-change: filter, transform;
      pointer-events: none;
      z-index: 0;
    }
    .background-element.visible,
    .cg-element.visible {
      opacity: 1;
    }
    #cg-img {
      z-index: 100;
    }
    #character-layer {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      pointer-events: none;
      padding-bottom: 0px;
      z-index: 90;
      transition: transform .8s ease;
      will-change: transform;
    }
    #character-sprite {
      max-width: 100%;
      max-height: 100%;
      opacity: 0;
      transform: translateY(24px);
      transition: opacity .35s ease, transform .35s ease;
    }
    #character-sprite.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .effect-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 110;
      overflow: hidden;
      border-radius: inherit;
      mix-blend-mode: normal;
    }
    @keyframes vn-violent-shake {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-25px, 20px); }
      20% { transform: translate(22px, -18px); }
      30% { transform: translate(-20px, -22px); }
      40% { transform: translate(18px, 25px); }
      50% { transform: translate(-15px, 12px); }
      60% { transform: translate(10px, -10px); }
      70% { transform: translate(-8px, 8px); }
      80% { transform: translate(4px, -4px); }
      90% { transform: translate(-2px, 2px); }
    }
    #responsive-container.is-violent-shaking {
      animation: vn-violent-shake 1.2s ease-out;
    }
    @keyframes vn-screen-shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    #responsive-container.is-shaking {
      animation: vn-screen-shake 0.4s ease-in-out;
    }
    @keyframes vn-impact {
      0% { transform: scale(1); }
      35% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    #responsive-container.is-impact {
      animation: vn-impact 0.32s ease-out;
    }
    @keyframes vn-jolt {
      0% { transform: translate(0, 0); }
      25% { transform: translate(3px, -2px); }
      50% { transform: translate(-4px, 3px); }
      75% { transform: translate(2px, 4px); }
      100% { transform: translate(0, 0); }
    }
    #responsive-container.is-jolting {
      animation: vn-jolt 0.35s ease-in-out;
    }
    @keyframes vn-running-bob {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-4px); }
      50% { transform: translateY(0); }
      75% { transform: translateY(-4px); }
    }
    #responsive-container.is-running {
      animation: vn-running-bob 0.5s ease-in-out 3;
    }
    @keyframes vn-dizzy {
      0%, 100% { transform: translateX(0) rotate(0); filter: blur(0); }
      25% { transform: translateX(-10px) rotate(-1deg); filter: blur(1px); }
      75% { transform: translateX(10px) rotate(1deg); filter: blur(2px); }
    }
    #responsive-container.is-dizzy {
      animation: vn-dizzy 0.8s ease-in-out 2;
    }
    @keyframes fear-shake {
      0%, 100% { transform: translate(0, 0); }
      20% { transform: translate(1px, -1px); }
      40% { transform: translate(-1px, 1px); }
      60% { transform: translate(1px, 1px); }
      80% { transform: translate(-1px, -1px); }
    }
    @keyframes fear-pulse {
      0%, 100% { opacity: 0.85; }
      50% { opacity: 0.55; }
    }
    #responsive-container.is-fear {
      animation: fear-shake 0.8s linear infinite;
      filter: contrast(1.25);
    }
    #responsive-container.is-fear::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow: inset 0 0 120px rgba(0,0,0,0.75);
      animation: fear-pulse 1.2s ease-in-out infinite;
      z-index: 500;
    }
    @keyframes psychedelic-swirl {
      0% { transform: scale(1) rotate(0deg); filter: blur(0px) contrast(100%); }
      25% { transform: scale(1.03) rotate(-2deg); filter: blur(2px) contrast(110%); }
      50% { transform: scale(1) rotate(0deg); filter: blur(3px) contrast(100%); }
      75% { transform: scale(1.03) rotate(2deg); filter: blur(2px) contrast(110%); }
      100% { transform: scale(1) rotate(0deg); filter: blur(0px) contrast(100%); }
    }
    #responsive-container.is-psychedelic {
      animation: psychedelic-swirl 4s ease-in-out infinite;
    }
    #responsive-container.is-tilted #content-wrapper {
      transform: rotate(-2deg);
    }
    #responsive-container.is-panning-left #background-img,
    #responsive-container.is-panning-left #cg-img,
    #responsive-container.is-panning-left #character-layer {
      transform: translateX(3%);
    }
    #responsive-container.is-panning-right #background-img,
    #responsive-container.is-panning-right #cg-img,
    #responsive-container.is-panning-right #character-layer {
      transform: translateX(-3%);
    }
    #responsive-container.is-panning-up #background-img,
    #responsive-container.is-panning-up #cg-img,
    #responsive-container.is-panning-up #character-layer {
      transform: translateY(-3%);
    }
    #responsive-container.is-panning-down #background-img,
    #responsive-container.is-panning-down #cg-img,
    #responsive-container.is-panning-down #character-layer {
      transform: translateY(3%);
    }
    #responsive-container.is-zoom-in #background-img,
    #responsive-container.is-zoom-in #cg-img {
      transform: scale(1.12);
    }
    #responsive-container.is-zoom-in #character-layer {
      transform: scale(1.03);
    }
    #responsive-container.is-zoom-out #background-img,
    #responsive-container.is-zoom-out #cg-img {
      transform: scale(0.92);
    }
    #responsive-container.is-zoom-out #character-layer {
      transform: scale(0.97);
    }
    #responsive-container.is-dolly-in #background-img,
    #responsive-container.is-dolly-in #cg-img {
      transform: scale(1.08);
    }
    #responsive-container.is-dolly-in #character-layer {
      transform: scale(1.02);
    }
    #responsive-container.is-dolly-out #background-img,
    #responsive-container.is-dolly-out #cg-img {
      transform: scale(0.94);
    }
    #responsive-container.is-dolly-out #character-layer {
      transform: scale(0.98);
    }
    #responsive-container.is-vertigo #background-img,
    #responsive-container.is-vertigo #cg-img {
      transform: scale(1.08);
    }
    #responsive-container.is-vertigo #character-layer {
      transform: scale(0.92);
    }
    .effect-layer.is-speeding::before {
      content: '';
      position: absolute;
      inset: 0;
      /* More, thinner, black speed lines */
      background-image:
        repeating-conic-gradient(from 0deg,   rgba(0,0,0,0.65) 0deg 0.6deg, transparent 0.6deg 12deg),
        repeating-conic-gradient(from 4deg,   rgba(0,0,0,0.50) 0deg 0.4deg, transparent 0.4deg 12deg),
        repeating-conic-gradient(from 8deg,   rgba(0,0,0,0.35) 0deg 0.3deg, transparent 0.3deg 12deg);
      mask-image: radial-gradient(circle at center, transparent 45%, black 70%, black 92%, transparent 100%);
      animation: speed-lines-jitter .25s ease-in-out infinite;
      filter: blur(0.4px);
      opacity: 0.8;
    }
    /* Denser wedge overlay: makes part of the ring look denser */
    .effect-layer.is-speeding::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        repeating-conic-gradient(from 2deg,  rgba(0,0,0,0.85) 0deg 0.6deg, transparent 0.6deg 8deg),
        repeating-conic-gradient(from 6deg,  rgba(0,0,0,0.65) 0deg 0.4deg, transparent 0.4deg 8deg);
      /* Constrain to the same ring */
      mask-image: radial-gradient(circle at center, transparent 45%, black 70%, black 92%, transparent 100%);
      /* Clip to a wedge sector so only part is denser */
      clip-path: polygon(50% 50%, 100% 22%, 100% 78%);
      animation: speed-lines-jitter .25s ease-in-out infinite;
      filter: blur(0.4px);
      opacity: 0.9;
      pointer-events: none;
    }
    @keyframes speed-lines-jitter {
      0% { transform: translate(-1px, 1px) scale(1.02); }
      25% { transform: translate(1px, 2px) scale(1); }
      50% { transform: translate(2px, -1px) scale(1.01); }
      75% { transform: translate(-1px, -2px) scale(1); }
      100% { transform: translate(-1px, 1px) scale(1.02); }
    }
    @keyframes fade-out-anim {
      from { background-color: rgba(0,0,0,0); }
      to { background-color: rgba(0,0,0,1); }
    }
    .effect-layer.is-fadeout {
      animation: fade-out-anim 1.4s ease-out forwards;
    }
    @keyframes fade-in-anim {
      from { background-color: rgba(0,0,0,1); }
      to { background-color: rgba(0,0,0,0); }
    }
    .effect-layer.is-fadein {
      animation: fade-in-anim 1.4s ease-in forwards;
    }
    @keyframes white-flash-anim {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    .effect-layer.is-whiteflash {
      background: #fff;
      /* Quick triple flash, no lingering */
      opacity: 0;
      animation: white-flash-anim 0.3s ease-out 3 both;
    }
    .effect-layer.is-blurring {
      backdrop-filter: blur(4px);
    }
    
    .effect-layer.is-flashback {
      background: rgba(230, 210, 170, 0.12);
      backdrop-filter: sepia(60%) brightness(1.05);
    }
    .effect-layer.is-dokidoki {
      background: radial-gradient(circle at center, rgba(255,182,193,0.35) 0%, rgba(255,182,193,0.05) 65%);
      backdrop-filter: saturate(1.15);
    }
    .effect-layer.is-dreamy {
      background: radial-gradient(circle at center, rgba(200, 160, 255, 0.18), rgba(255, 255, 255, 0));
      backdrop-filter: blur(2px) brightness(1.05) saturate(1.15);
    }
    .effect-layer.is-spotlight {
      background: radial-gradient(circle at center, rgba(255,255,255,0.25) 0%, rgba(0,0,0,0.78) 80%);
      backdrop-filter: brightness(0.92);
    }
    .effect-layer.is-cooltone {
      background: rgba(20, 50, 120, 0.12);
      backdrop-filter: hue-rotate(190deg) saturate(1.05) brightness(0.92);
    }
    .effect-layer.is-warmtone {
      background: rgba(255,140,80,0.12);
      backdrop-filter: hue-rotate(-18deg) saturate(1.05) brightness(1.05);
    }
    
    .effect-layer.is-raining,
    .effect-layer.is-downpour,
    .effect-layer.is-snowing,
    .effect-layer.is-blizzard,
    .effect-layer.is-sandstorm {
      backdrop-filter: brightness(0.95);
    }
    @keyframes rain-scroll {
      from { background-position: 0 0; }
      to { background-position: 0 200vh; }
    }
    .effect-layer.is-downpour::before,
    .effect-layer.is-downpour::after,
    .effect-layer.is-raining::before,
    .effect-layer.is-raining::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.85;
      animation: rain-scroll linear infinite;
    }
    .effect-layer.is-downpour::before {
      background-image:
        radial-gradient(0.7px 60px at 5vw 15vh, rgba(255,255,255,0.95) 0%, transparent 100%),
        radial-gradient(0.7px 70px at 15vw 72vh, rgba(255,255,255,0.9) 0%, transparent 100%),
        radial-gradient(0.7px 50px at 25vw 8vh, rgba(255,255,255,0.95) 0%, transparent 100%),
        radial-gradient(0.7px 80px at 35vw 94vh, rgba(255,255,255,0.85) 0%, transparent 100%),
        radial-gradient(0.7px 65px at 45vw 33vh, rgba(255,255,255,0.95) 0%, transparent 100%),
        radial-gradient(0.7px 55px at 55vw 58vh, rgba(255,255,255,0.9) 0%, transparent 100%),
        radial-gradient(0.7px 90px at 65vw 110vh, rgba(255,255,255,0.95) 0%, transparent 100%);
      background-size: 100% 260vh;
      animation-duration: 0.5s;
    }
    .effect-layer.is-downpour::after {
      background-image:
        radial-gradient(0.6px 50px at 8vw 40vh, rgba(220,240,255,0.75) 0%, transparent 100%),
        radial-gradient(0.6px 60px at 18vw 95vh, rgba(220,240,255,0.65) 0%, transparent 100%),
        radial-gradient(0.6px 45px at 28vw 22vh, rgba(220,240,255,0.8) 0%, transparent 100%),
        radial-gradient(0.6px 70px at 38vw 130vh, rgba(220,240,255,0.55) 0%, transparent 100%);
      background-size: 100% 220vh;
      animation-duration: 0.8s;
      animation-delay: -0.2s;
      opacity: 0.6;
    }
    .effect-layer.is-raining::before {
      background-image:
        radial-gradient(0.5px 35px at 5vw 15vh, rgba(255,255,255,0.9) 0%, transparent 100%),
        radial-gradient(0.5px 42px at 15vw 72vh, rgba(255,255,255,0.8) 0%, transparent 100%),
        radial-gradient(0.5px 28px at 25vw 8vh, rgba(255,255,255,0.9) 0%, transparent 100%);
      background-size: 100% 200vh;
      animation-duration: 0.9s;
    }
    .effect-layer.is-raining::after {
      background-image:
        radial-gradient(0.5px 33px at 8vw 40vh, rgba(220,240,255,0.7) 0%, transparent 100%),
        radial-gradient(0.5px 38px at 18vw 95vh, rgba(220,240,255,0.6) 0%, transparent 100%),
        radial-gradient(0.5px 26px at 28vw 22vh, rgba(220,240,255,0.8) 0%, transparent 100%);
      background-size: 100% 200vh;
      animation-duration: 1.2s;
      opacity: 0.55;
    }
    @keyframes snow-fall-sway {
      from { transform: translateY(-20vh) translateX(-2vw); }
      to { transform: translateY(120vh) translateX(2vw); }
    }
    .effect-layer.is-snowing::before,
    .effect-layer.is-snowing::after,
    .effect-layer.is-blizzard::before,
    .effect-layer.is-blizzard::after {
      content: '';
      position: absolute;
      top: -100vh;
      left: 0;
      border-radius: 50%;
      animation: snow-fall-sway linear infinite;
    }
    .effect-layer.is-snowing::before {
      width: 6px;
      height: 6px;
      box-shadow: 13vw 22vh #fff, 61vw 14vh #fff, 44vw 94vh #fff, 12vw 55vh #fff;
      opacity: 0.8;
      animation-duration: 9s;
    }
    .effect-layer.is-snowing::after {
      width: 4px;
      height: 4px;
      box-shadow: 5vw 60vh #fff, 22vw 14vh #fff, 39vw 39vh #fff, 75vw 77vh #fff;
      opacity: 0.5;
      animation-duration: 13s;
      animation-delay: -2s;
    }
    /* 暴雪*/
    .effect-layer.is-blizzard::before {
      width: 7px;
      height: 7px;
      /* 大片雪：更高密度 */
      box-shadow:
        3vw 8vh #fff,   8vw 26vh #fff,  12vw 52vh #fff,  16vw 12vh #fff,
        18vw 78vh #fff, 22vw 38vh #fff, 26vw 92vh #fff,  30vw 18vh #fff,
        34vw 64vh #fff, 38vw 6vh #fff,  42vw 72vh #fff,  46vw 28vh #fff,
        50vw 88vh #fff, 54vw 46vh #fff, 58vw 16vh #fff,  62vw 58vh #fff,
        66vw 32vh #fff, 70vw 82vh #fff, 74vw 44vh #fff,  78vw 10vh #fff,
        82vw 68vh #fff, 86vw 22vh #fff, 90vw 76vh #fff,  94vw 36vh #fff;
      filter: blur(0.4px);
      opacity: 0.95;
      animation-duration: 5.6s;
    }
    .effect-layer.is-blizzard::after {
      width: 5px;
      height: 5px;
      /* 小片雪：更多、更快，并错相位 */
      box-shadow:
        2vw 20vh #fff,   6vw 40vh #fff,  10vw 70vh #fff, 14vw 30vh #fff,
        18vw 96vh #fff,  20vw 56vh #fff, 24vw 14vh #fff, 28vw 84vh #fff,
        32vw 48vh #fff,  36vw 24vh #fff, 40vw 92vh #fff, 44vw 60vh #fff,
        48vw 34vh #fff,  52vw 12vh #fff, 56vw 78vh #fff, 60vw 44vh #fff,
        64vw 18vh #fff,  68vw 88vh #fff, 72vw 52vh #fff, 76vw 28vh #fff,
        80vw 98vh #fff,  84vw 62vh #fff, 88vw 38vh #fff, 92vw 16vh #fff,
        96vw 74vh #fff;
      filter: blur(0.6px);
      opacity: 0.85;
      animation-duration: 7.2s;
      animation-delay: -2s;
    }
    .effect-layer.is-lightning::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 40% 20%, rgba(255,255,255,0.9), rgba(255,255,255,0));
      animation: lightning-flash 0.8s ease-out;
      opacity: 0; /* 防止动画结束后出现白色停留 */
      pointer-events: none;
    }
    @keyframes lightning-flash {
      0% { opacity: 0; }
      10% { opacity: 1; }
      20% { opacity: 0.1; }
      30% { opacity: 0.8; }
      100% { opacity: 0; }
    }
    
    .effect-layer.is-haze {
      background: linear-gradient(to top, rgba(220,220,220,0.25), rgba(220,220,220,0));
      backdrop-filter: blur(1px);
    }
    .effect-layer.is-foggy {
      background: radial-gradient(circle at center, rgba(255,255,255,0.35), rgba(255,255,255,0));
      backdrop-filter: blur(3px) brightness(0.95);
    }
    @keyframes petal-fall {
      0% { transform: translate3d(0,-10vh,0) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      100% { transform: translate3d(20vw,110vh,0) rotate(360deg); opacity: 0; }
    }
    
    @keyframes sandstorm-drift {
      0% { transform: translateX(-10%); }
      100% { transform: translateX(10%); }
    }
    .effect-layer.is-sandstorm {
      background: rgba(194, 158, 111, 0.25);
      backdrop-filter: brightness(0.85) saturate(0.9);
    }
    .effect-layer.is-sandstorm::before,
    .effect-layer.is-sandstorm::after {
      content: '';
      position: absolute;
      inset: -20% 0;
      background:
        radial-gradient(circle, rgba(222,184,135,0.5) 0%, transparent 55%),
        radial-gradient(circle, rgba(222,184,135,0.35) 0%, transparent 60%);
      animation: sandstorm-drift 6s linear infinite;
      opacity: 0.4;
    }
    .effect-layer.is-sandstorm::after {
      animation-duration: 4s;
      animation-direction: reverse;
      opacity: 0.25;
    }
    /* 流血：顶部血层 + 滴落动画 + 中心SVG标记 */
    .effect-layer .blood-layer { display: none; position: absolute; inset: 0; pointer-events: none; }
    .effect-layer.is-bloody .blood-layer { display: block; }
    .effect-layer.is-bloody .blood-layer { --blood-bg: hsl(0,75%,28%); --blood-height: 0vh; }
    .effect-layer.is-bloody .blood-top { display: none; }
    .effect-layer.is-bloody .drips { position: absolute; left: 0; right: 0; top: 0; height: 100%; }
    .effect-layer.is-bloody .drip {
      position: absolute; top: 0; width: 10px; height: 0; background: var(--blood-bg);
      border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; transform-origin: top center;
      animation-name: bleed-drip; animation-timing-function: cubic-bezier(.37,.01,.25,1);
      animation-iteration-count: infinite; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.25));
    }
    .effect-layer.is-bloody .drip::after {
      content: ''; position: absolute; left: 50%; top: 100%; width: 14px; height: 14px;
      transform: translate(-50%, 0) scale(0); background: var(--blood-bg); border-radius: 50%;
      animation: bleed-drop 6s infinite;
    }
    @keyframes bleed-drip {
      0%   { height: 0; opacity: 0; }
      5%   { opacity: 1; }
      55%  { height: 26vh; }
      75%  { height: 30vh; }
      100% { height: 30vh; opacity: 0; }
    }
    @keyframes bleed-drop {
      0%, 55% { transform: translate(-50%, 0) scale(0); opacity: 1; }
      65%     { transform: translate(-50%, 0) scale(1); opacity: 1; }
      100%    { transform: translate(-50%, 12px) scale(0); opacity: 0; }
    }
    /* 12条滴落，位置/宽度/时间错位，营造随机感 */
    .effect-layer.is-bloody .drip:nth-child(1)  { left: 6%;  width: 12px; animation-duration: 6.2s; animation-delay: -0.2s; }
    .effect-layer.is-bloody .drip:nth-child(2)  { left: 13%; width: 8px;  animation-duration: 5.6s; animation-delay: -1.3s; }
    .effect-layer.is-bloody .drip:nth-child(3)  { left: 21%; width: 10px; animation-duration: 6.8s; animation-delay: -0.9s; }
    .effect-layer.is-bloody .drip:nth-child(4)  { left: 29%; width: 14px; animation-duration: 7.4s; animation-delay: -2.1s; }
    .effect-layer.is-bloody .drip:nth-child(5)  { left: 37%; width: 9px;  animation-duration: 5.2s; animation-delay: -0.6s; }
    .effect-layer.is-bloody .drip:nth-child(6)  { left: 45%; width: 11px; animation-duration: 6.6s; animation-delay: -1.9s; }
    .effect-layer.is-bloody .drip:nth-child(7)  { left: 53%; width: 8px;  animation-duration: 5.8s; animation-delay: -0.4s; }
    .effect-layer.is-bloody .drip:nth-child(8)  { left: 61%; width: 13px; animation-duration: 7.0s; animation-delay: -1.1s; }
    .effect-layer.is-bloody .drip:nth-child(9)  { left: 69%; width: 10px; animation-duration: 6.0s; animation-delay: -2.4s; }
    .effect-layer.is-bloody .drip:nth-child(10) { left: 77%; width: 9px;  animation-duration: 5.4s; animation-delay: -0.7s; }
    .effect-layer.is-bloody .drip:nth-child(11) { left: 84%; width: 12px; animation-duration: 6.4s; animation-delay: -1.6s; }
    .effect-layer.is-bloody .drip:nth-child(12) { left: 92%; width: 8px;  animation-duration: 5.0s; animation-delay: -1.0s; }
    /* 角落SVG标记（更小、暗红），相继出现 + 晕染开 */
    .effect-layer .blood-mark {
      position: absolute;
      opacity: 0;
      transform: scale(0.92);
      filter: blur(10px) drop-shadow(0 12px 28px rgba(0,0,0,0.45));
      transition:
        opacity 1s ease-out,
        transform .9s cubic-bezier(.17,.84,.44,1),
        filter 1.2s ease-out;
      transition-delay: var(--mark-delay, 0s);
      will-change: opacity, transform, filter;
      pointer-events: none;
    }
    .effect-layer.is-bloody .blood-mark { opacity: 0.95; transform: scale(1); filter: blur(0) drop-shadow(0 12px 28px rgba(0,0,0,0.45)); }
    .effect-layer.is-bloody .blood-mark svg { width: min(18vmin, 180px); height: auto; display: block; }
    .effect-layer.is-bloody .blood-mark svg path { fill: var(--blood-bg); }
    .effect-layer .blood-mark.mark-lb { left: 3.5%; bottom: 5.5%; --mark-delay: .1s; }
    .effect-layer .blood-mark.mark-tr { right: 3.5%; top: 5.5%; --mark-delay: .6s; }
    /* 晕染光晕：出现后扩散再淡出 */
    .effect-layer .blood-mark::after {
      content: '';
      position: absolute;
      left: 50%; top: 50%;
      width: 140%; height: 140%;
      transform: translate(-50%, -50%) scale(0.6);
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(120,0,0,0.28), rgba(120,0,0,0) 70%);
      filter: blur(12px);
      opacity: 0;
      pointer-events: none;
    }
    .effect-layer.is-bloody .blood-mark::after {
      animation: blood-bloom 1.4s ease-out both;
      animation-delay: var(--mark-delay, 0s);
    }
    @keyframes blood-bloom {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.6); filter: blur(10px); }
      45% { opacity: 0.35; transform: translate(-50%, -50%) scale(1); filter: blur(18px); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); filter: blur(22px); }
    }

    #dialogue-box {
      position: absolute;
      left: 6%;
      right: 6%;
      bottom: 32px;
      min-height: 120px;
      padding: 22px 24px 34px;
      border-radius: var(--global-radius);
      background: var(--dialogue-background);
      color: var(--dialogue-text-color);
      font-size: var(--dialogue-font-size);
      line-height: 1.8;
      letter-spacing: 0.05em;
      backdrop-filter: blur(var(--dialogue-blur, 6px));
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      z-index: 120;
    }
    #speaker-nameplate {
      position: absolute;
      bottom: calc(100% + 14px);
      left: 24px;
      padding: 6px 16px;
      background: var(--dialogue-background);
      color: var(--dialogue-text-color);
      border-radius: 18px;
      font-size: 15px;
      letter-spacing: 0.08em;
      font-family: inherit;
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.4);
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transform: none;
      transition: opacity .25s ease;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      z-index: 130;
    }
    #speaker-nameplate.visible {
      opacity: 1;
      transform: translateY(0);
    }
    #dialogue-text {
      margin: 0;
      font-family: inherit;
      font-weight: 400;
      /* Remove white glow that makes text look washed out */
      text-shadow: none;
    }
    .dialogue-prompt {
      position: absolute;
      right: 18px;
      bottom: 12px;
      font-size: 13px;
      color: rgba(80,80,90,0.72);
      letter-spacing: 0.1em;
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none;
    }
    .dialogue-prompt.show { opacity: 1; }

    .choice-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 32px 24px;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.78) 100%);
      z-index: 360;
    }
    .choice-overlay--show {
      display: flex;
      animation: choiceFadeIn .25s ease;
    }
    .choice-overlay--custom-only .choice-list {
      display: none;
    }
    .choice-panel {
      width: min(580px, 94%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
      backdrop-filter: blur(var(--panel-blur, 14px));
      background: var(--dialogue-background);
      color: var(--dialogue-text-color);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 30px 32px 36px;
      box-shadow: 0 26px 50px rgba(0, 0, 0, 0.4);
    }
    .choice-close {
      position: absolute;
      top: 6px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.18);
      color: var(--dialogue-text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .18s ease, opacity .18s ease, background .18s ease;
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
    }
    .choice-close:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      background: rgba(255,255,255,0.24);
    }
    .choice-close:active {
      transform: scale(0.94);
    }
    .choice-close svg {
      width: 22px;
      height: 22px;
      pointer-events: none;
    }
    .choice-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .choice-button {
      width: 100%;
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.12);
      color: var(--dialogue-text-color);
      font-size: 16px;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: background .18s ease, transform .18s ease, border-color .18s ease;
    }
    .choice-button:hover {
      background: rgba(255,255,255,0.18);
      transform: translateY(-1px);
    }
    .choice-button:active {
      transform: scale(0.98);
    }
    .choice-custom {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .choice-custom__label {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.72);
    }
    .choice-custom__input-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: stretch;
      width: 100%;
      background: none;
      border: none;
      border-radius: 0;
      padding: 0;
      min-height: 0;
      box-shadow: none;
    }
    .choice-input {
      flex: 1 1 220px;
      border: 1px solid rgba(255,255,255,0.24);
      background: rgba(255,255,255,0.12);
      color: inherit;
      font-size: 16px;
      letter-spacing: 0.04em;
      min-height: 36px;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
    }
    .choice-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 16px 34px rgba(0,0,0,0.24);
    }
    .choice-input.error {
      animation: choiceInputShake .28s ease;
      border-radius: 18px;
      background: rgba(244,67,54,0.16);
      border-color: rgba(244,67,54,0.45);
    }
    .choice-send {
      border: none;
      border-radius: 18px;
      background: rgba(255,255,255,0.26);
      color: var(--dialogue-text-color);
      font-weight: 600;
      font-size: 15px;
      letter-spacing: 0.04em;
      padding: 12px 22px;
      cursor: pointer;
      transition: background .18s ease, transform .18s ease, box-shadow .18s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 46px;
      min-width: 96px;
      flex: 0 0 auto;
      box-shadow: 0 12px 24px rgba(0,0,0,0.16);
      white-space: nowrap;
    }
    .choice-send:hover {
      background: rgba(255,255,255,0.32);
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(0,0,0,0.2);
    }
    .choice-send:active {
      transform: scale(0.98);
    }
    .choice-custom__hint {
      margin: 0;
      font-size: 12px;
      color: rgba(255,255,255,0.56);
      letter-spacing: 0.04em;
    }
    @keyframes choiceFadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes choiceInputShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-2px); }
    }

    #sms-panel {
      position: absolute;
      inset: 6% 8% 12%;
      display: none;
      flex-direction: column;
      gap: 20px;
      padding: 24px 28px 20px;
      background: var(--panel-bg);
      color: var(--panel-text-color);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 24px 48px rgba(0,0,0,0.32);
      z-index: 260; /* 置于视频面板(210)之上 */
    }
    #responsive-container.sms-mode #sms-panel { display: flex; }
    #responsive-container.sms-mode #dialogue-box,
    #responsive-container.sms-mode #character-layer,
    #responsive-container.sms-mode #background-img,
    #responsive-container.sms-mode #cg-img {
      filter: blur(6px) brightness(0.65);
      pointer-events: none;
    }
    /* 短信界面开启时，视频界面也弱化并禁用交互，避免冲突 */
    #responsive-container.sms-mode #video-panel {
      filter: blur(6px) brightness(0.65);
      pointer-events: none;
    }
    .sms-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .sms-header button {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: inherit;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-header button:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-header button svg {
      width: 22px;
      height: 22px;
    }
    #sms-thread {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      scrollbar-width: thin;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-right: 6px;
    }
    .sms-bubble {
      display: grid;
      grid-template-columns: 56px minmax(0, 1fr);
      gap: 16px;
      font-family: inherit;
      align-items: flex-start;
    }
    .sms-bubble .bubble-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
      min-width: 0;
    }
    .sms-bubble .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255,255,255,0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      align-self: flex-start;
      flex-shrink: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--panel-text-color);
      letter-spacing: 0.02em;
    }
    .sms-bubble .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .sms-bubble .name {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--panel-text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    .sms-bubble .bubble-body {
      max-width: 100%;
      display: block;
      padding: 0;
      line-height: 1.7;
      word-break: break-word;
      background: none;
      border: none;
      box-shadow: none;
      border-radius: 0;
      color: var(--panel-text-color);
    }
    .sms-bubble .content {
      font-size: 16px;
      white-space: pre-wrap;
      color: inherit;
    }
    .sms-bubble--image .bubble-body {
      width: 100%;
    }
    .sms-image-message {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .sms-image-card {
      width: 100%;
      padding: 16px 20px;
      border-radius: 18px;
      background: rgba(68, 70, 78, 0.9);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(235,237,243,0.94);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 16px 36px rgba(0,0,0,0.26);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .sms-image-card__description {
      font-size: 15px;
      white-space: pre-wrap;
      line-height: 1.65;
      color: inherit;
      letter-spacing: 0.04em;
    }
    /* 视频邀请卡片 */
    .sms-bubble--video .bubble-body { width: 100%; }
    .sms-video-invite { display: flex; flex-direction: column; gap: 10px; width: 100%; color: inherit; }
    .sms-video-card {
      width: 100%;
      padding: 16px 20px;
      border-radius: 18px;
      background: rgba(68, 70, 78, 0.9);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(235,237,243,0.94);
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 12px;
      box-shadow: 0 16px 36px rgba(0,0,0,0.26);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .sms-video-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #ffb347, #ffcc33);
      color: #1f2330;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: .02em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 8px 18px rgba(0,0,0,0.28);
      user-select: none;
    }
    .sms-video-info { min-width: 0; display: flex; flex-direction: column; gap: 4px; }
    .sms-video-title { font-size: 15px; font-weight: 700; letter-spacing: 0.03em; }
    .sms-video-meta {
      font-size: 13px;
      opacity: 0.9;
      letter-spacing: 0.02em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .sms-bubble.outgoing .sms-video-card {
      background: rgba(214,216,224,0.94);
      border-color: rgba(255,255,255,0.28);
      color: rgba(40,44,54,0.92);
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    }
    .sms-bubble.outgoing .sms-image-card {
      background: rgba(214,216,224,0.94);
      border-color: rgba(255,255,255,0.28);
      color: rgba(40,44,54,0.92);
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    }
    .sms-bubble.outgoing .sms-image-card__description {
      color: inherit;
    }
    .sms-red-envelope {
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: inherit;
    }

    /* 转账卡片 */
    .sms-transfer-message {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      color: inherit;
    }
    .sms-transfer-card {
      width: 100%;
      padding: 16px 20px;
      border-radius: 18px;
      background: rgba(68, 70, 78, 0.9);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(235,237,243,0.94);
      display: grid;
      /* Remove leading icon column; keep info + amount */
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      box-shadow: 0 16px 36px rgba(0,0,0,0.26);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
      position: relative;
    }
    /* 右上角“详”按钮 */
    .sms-transfer-more {
      position: absolute;
      top: 8px;
      right: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      min-height: 36px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.28);
      background: rgba(255,255,255,0.12);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.08em;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      z-index: 1;
      transition: background .2s ease, transform .2s ease, border-color .2s ease, opacity .2s ease, box-shadow .2s ease;
    }
    .sms-transfer-more:hover { background: rgba(255,255,255,0.18); transform: translateY(-1px); }
    .sms-transfer-more:active { background: rgba(255,255,255,0.22); transform: translateY(0); }
    .sms-bubble.outgoing .sms-transfer-more { border-color: rgba(255,255,255,0.3); background: rgba(0,0,0,0.06); }
    /* 当“详”按钮放在标题行内时，改为内联布局，避免覆盖金额 */
    .sms-transfer-title .sms-transfer-more {
      position: static;
      top: auto;
      right: auto;
      margin-left: auto;
      z-index: auto;
    }
    @media (max-width: 560px) {
      .sms-transfer-more {
        min-height: 40px;
        min-width: 48px;
        padding: 10px 14px;
        font-size: 15px;
        top: 10px;
        right: 10px;
      }
    }
    .sms-transfer-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, #ff9a44, #ff5e62);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      letter-spacing: .02em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 8px 18px rgba(0,0,0,0.28);
      user-select: none;
    }
    .sms-transfer-info {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sms-transfer-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sms-transfer-title-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sms-transfer-title svg {
      flex: none;
      width: 20px;
      height: 20px;
      color: #FFD700; /* 金色 */
    }
    .sms-transfer-meta {
      font-size: 13px;
      opacity: 0.9;
      letter-spacing: 0.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sms-transfer-note {
      margin-top: 2px;
      font-size: 13px;
      opacity: 0.84;
      letter-spacing: 0.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sms-transfer-amount {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-left: 6px;
    }
    /* 详情内容排版 */
    .sms-transfer-details { display: flex; flex-direction: column; gap: 10px; }
    .sms-transfer-row { display: flex; align-items: center; gap: 8px; }
    .sms-transfer-label { width: 56px; opacity: 0.86; font-size: 14px; letter-spacing: 0.04em; flex: none; }
    .sms-transfer-value { flex: 1; min-width: 0; font-size: 15px; word-break: break-all; }
    .sms-bubble.outgoing .sms-transfer-card {
      background: rgba(214,216,224,0.94);
      border-color: rgba(255,255,255,0.28);
      color: rgba(40,44,54,0.92);
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    }
    .sms-bubble--transfer .bubble-body {
      width: 100%;
    }
    .sms-red-envelope-button {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 18px;
      border-radius: 18px;
      border: 1px solid rgba(255,198,0,0.55);
      background: linear-gradient(135deg, rgba(255,110,72,0.95), rgba(255,38,63,0.96));
      box-shadow: 0 16px 32px rgba(255,72,0,0.28);
      color: #fff;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease, background .2s ease, border-color .2s ease, color .2s ease;
      /* Ensure inner text never overflows visually */
      overflow: hidden;
    }
    .sms-red-envelope-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 36px rgba(255,72,0,0.32);
      filter: brightness(1.05);
    }
    .sms-bubble.outgoing .sms-red-envelope-button {
      border-color: rgba(255,255,255,0.65);
      background: linear-gradient(135deg, rgba(255,132,83,0.96), rgba(255,60,85,0.98));
    }
    .sms-red-envelope.open .sms-red-envelope-button {
      border-color: rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(92,96,108,0.94), rgba(64,68,80,0.96));
      box-shadow: 0 12px 26px rgba(0,0,0,0.28);
      color: rgba(255,255,255,0.92);
      cursor: default;
      filter: none;
      transform: none;
    }
    .sms-red-envelope.open .sms-red-envelope-button:hover {
      box-shadow: 0 12px 26px rgba(0,0,0,0.28);
      filter: none;
    }
    .sms-red-envelope-icon {
      flex: none;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.16);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .sms-red-envelope-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      min-width: 0;
      flex: 1;
    }
    .sms-red-envelope-title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.04em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .sms-red-envelope-hint {
      font-size: 13px;
      opacity: 0.8;
      letter-spacing: 0.04em;
      transition: opacity .2s ease;
      /* Avoid vertical stacking on small widths */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sms-red-envelope.open .sms-red-envelope-hint {
      opacity: 0.6;
    }
    .sms-red-envelope-amount {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.06em;
      min-width: 84px;
      text-align: right;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    /* When unopened, don't reserve space for the amount */
    .sms-red-envelope:not(.open) .sms-red-envelope-amount { display: none; }
    .sms-red-envelope.open .sms-red-envelope-amount { display: block; }
    .sms-red-envelope.open .sms-red-envelope-amount {
      opacity: 1;
      transform: translateY(0);
    }
    .sms-bubble--red .bubble-body {
      width: 100%;
    }
    .sms-voice-message {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sms-voice-button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.12);
      color: inherit;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    .sms-voice-button:hover {
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.26);
      background: rgba(255,255,255,0.18);
    }
    .sms-voice-icon {
      flex: none;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #5f63ff;
      color: #fff;
      font-size: 18px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
    }
    .sms-voice-icon::before {
      content: '▶';
      margin-left: 2px;
    }
    .sms-voice-wave {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(14, minmax(2px, 1fr));
      gap: 3px;
      align-items: end;
      height: 28px;
    }
    .sms-voice-wave span {
      display: block;
      width: 100%;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.8;
    }
    .sms-voice-wave span:nth-child(4n) {
      height: 72%;
    }
    .sms-voice-wave span:nth-child(4n+1) {
      height: 44%;
    }
    .sms-voice-wave span:nth-child(4n+2) {
      height: 86%;
    }
    .sms-voice-wave span:nth-child(4n+3) {
      height: 58%;
    }
    .sms-voice-duration {
      flex: none;
      font-variant-numeric: tabular-nums;
      font-size: 15px;
      opacity: 0.88;
    }
    .sms-voice-transcript {
      display: none;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .sms-voice-message.open .sms-voice-transcript {
      display: block;
    }
    .sms-bubble.outgoing .sms-voice-button {
      border-color: rgba(255,255,255,0.55);
      background: rgba(255,255,255,0.36);
      color: #1f2330;
      box-shadow: var(--sms-outgoing-shadow, 0 12px 28px rgba(0,0,0,0.24));
    }
    .sms-bubble.outgoing .sms-voice-button:hover {
      border-color: rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.5);
    }
    .sms-bubble.outgoing .sms-voice-icon {
      background: #5f63ff;
      color: #fff;
    }
    .sms-bubble.outgoing .sms-voice-transcript {
      border-color: rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.36);
      color: #1f2330;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .sms-bubble .avatar.avatar--empty {
      background: rgba(255,255,255,0.08);
    }
    .sms-bubble.sms-narration {
      display: flex;
      justify-content: center;
      align-items: center;
      grid-template-columns: none;
      gap: 0;
      text-align: center;
    }
    .sms-bubble.sms-narration .bubble-body {
      margin: 0 auto;
      padding: 10px 16px;
      max-width: 70%;
      border-radius: 16px;
      background: rgba(255,255,255,0.1);
      color: var(--panel-text-color);
      letter-spacing: 0.04em;
    }
    .sms-bubble.sms-narration .content {
      font-size: 14px;
    }
    .sms-settings-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 260;
    }
    .sms-settings-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .sms-settings-dialog {
      position: relative;
      width: min(360px, 100%);
      padding: 26px 24px 20px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 24px 48px rgba(0,0,0,0.36);
      color: var(--panel-text-color);
      /* 固定高度 + 细滚动条 */
      height: min(520px, 80vh);
      overflow: auto;
      scrollbar-width: thin;
    }
    /* WebKit 细滚动条样式（仅限短信设置弹窗） */
    #sms-settings-overlay .sms-settings-dialog::-webkit-scrollbar { width: 6px; }
    #sms-settings-overlay .sms-settings-dialog::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
    }
    #sms-settings-overlay .sms-settings-dialog::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
    }
    #sms-settings-overlay .sms-settings-dialog::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.45);
    }
    .sms-settings-dialog h3 {
      margin: 0 0 18px;
      font-size: 18px;
      letter-spacing: 0.04em;
    }
    .sms-settings-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-settings-close:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-settings-close svg {
      width: 18px;
      height: 18px;
    }
    .sms-image-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 268;
    }
    .sms-image-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .sms-image-dialog {
      position: relative;
      width: min(360px, 100%);
      padding: 28px 26px 24px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .sms-image-dialog h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }
    .sms-image-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-image-close:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-image-close::before {
      content: '×';
      font-size: 18px;
      line-height: 1;
    }
    .sms-image-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sms-image-form label {
      font-size: 14px;
      letter-spacing: 0.03em;
    }
    .sms-image-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      resize: vertical;
      line-height: 1.6;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-image-textarea:focus {
      outline: none;
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
    }
    .sms-image-textarea.error {
      border-color: rgba(255,72,88,0.65);
      box-shadow: 0 0 0 3px rgba(255,72,88,0.2);
    }
    .sms-image-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .sms-image-btn {
      min-width: 88px;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .sms-image-btn:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .sms-image-btn--primary {
      border-color: rgba(104,159,255,0.38);
      background: rgba(104,159,255,0.18);
      color: rgba(223,231,255,0.94);
    }
    .sms-image-btn--primary:hover {
      border-color: rgba(104,159,255,0.52);
      background: rgba(104,159,255,0.26);
    }
    /* 视频头像设置弹窗（与短信弹窗风格一致） */
    .video-user-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 268;
    }
    .video-user-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
    .video-user-dialog {
      position: relative;
      width: min(420px, 100%);
      padding: 28px 26px 24px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .video-user-dialog h3 { margin: 0; font-size: 18px; letter-spacing: 0.04em; }
    .video-user-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .video-user-close:hover { background: rgba(255,255,255,0.16); transform: translateY(-1px); }
    .video-user-close::before { content: '×'; font-size: 18px; line-height: 1; }
    .video-user-form { display: flex; flex-direction: column; gap: 14px; }
    .video-user-form label { font-size: 14px; letter-spacing: 0.03em; }
    .video-user-textarea {
      width: 100%;
      min-height: 140px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      resize: vertical;
      line-height: 1.6;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .video-user-textarea:focus { outline: none; border-color: rgba(255,255,255,0.5); box-shadow: 0 0 0 3px rgba(255,255,255,0.12); }
    .video-user-row { display: flex; align-items: center; gap: 10px; }
    .video-user-row input[type="number"] {
      width: 110px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
    }
    .video-user-actions { display: flex; justify-content: flex-end; gap: 12px; }
    .video-user-btn {
      min-width: 88px;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .video-user-btn:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .video-user-btn--primary { border-color: rgba(104,159,255,0.38); background: rgba(104,159,255,0.18); color: rgba(223,231,255,0.94); }
    .video-user-btn--primary:hover { border-color: rgba(104,159,255,0.52); background: rgba(104,159,255,0.26); }
    /* 视频确认弹窗 */
    .sms-video-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 271;
    }
    .sms-video-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
    .sms-video-dialog {
      position: relative;
      width: min(360px, 100%);
      padding: 24px 22px 20px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex; flex-direction: column; gap: 14px;
    }
    .sms-video-dialog h3 { margin: 0; font-size: 18px; letter-spacing: 0.04em; }
    .sms-video-prompt { margin: 4px 0 6px; font-size: 15px; letter-spacing: 0.02em; }
    .sms-video-field { display: flex; flex-direction: column; gap: 8px; margin: 10px 0 8px; }
    .sms-video-field label { font-size: 14px; letter-spacing: 0.03em; }
    .sms-video-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-video-input:focus { outline: none; border-color: rgba(255,255,255,0.42); box-shadow: 0 0 0 2px rgba(255,255,255,0.16); }
    .sms-video-input::placeholder { color: rgba(243,243,243,0.58); }
    .sms-video-actions { display: flex; justify-content: flex-end; gap: 12px; }
    .sms-video-btn {
      min-width: 88px;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .sms-video-btn:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .sms-video-btn--primary {
      border-color: rgba(255,190,120,0.58);
      background: rgba(255,190,120,0.26);
      color: rgba(255,245,232,0.98);
    }
    .sms-video-btn--primary:hover { border-color: rgba(255,190,120,0.72); background: rgba(255,190,120,0.34); }
    .sms-voice-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 270;
    }
    .sms-voice-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .sms-voice-dialog {
      position: relative;
      width: min(380px, 100%);
      padding: 28px 26px 24px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .sms-voice-dialog h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }
    .sms-voice-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-voice-close:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-voice-close::before {
      content: '×';
      font-size: 18px;
      line-height: 1;
    }
    .sms-voice-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sms-voice-stage {
      display: none;
      flex-direction: column;
      gap: 14px;
    }
    .sms-voice-stage.active {
      display: flex;
    }
    .sms-voice-stage label {
      font-size: 14px;
      letter-spacing: 0.03em;
    }
    .sms-voice-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      resize: vertical;
      line-height: 1.6;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-voice-textarea:focus {
      outline: none;
      border-color: rgba(255,255,255,0.42);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.16);
    }
    .sms-voice-input {
      width: 100%;
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 16px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-voice-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.42);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.16);
    }
    .sms-voice-input::placeholder,
    .sms-voice-textarea::placeholder {
      color: rgba(243,243,243,0.58);
    }
    .sms-voice-input.error,
    .sms-voice-textarea.error {
      border-color: rgba(255,112,112,0.7);
      box-shadow: 0 0 0 2px rgba(255,112,112,0.25);
    }
    .sms-voice-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .sms-voice-btn {
      min-width: 88px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, border-color .2s ease;
    }
    .sms-voice-btn:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .sms-voice-btn--primary {
      border-color: rgba(255,255,255,0.75);
      background: rgba(255,255,255,0.92);
      color: #1f2330;
    }
    .sms-voice-btn--primary:hover {
      background: rgba(255,255,255,0.98);
    }
    /* 转账弹窗样式 */
    .sms-transfer-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 274;
    }
    .sms-transfer-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .sms-transfer-dialog {
      position: relative;
      width: min(360px, 100%);
      padding: 28px 26px 24px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .sms-transfer-dialog h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }
    .sms-transfer-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-transfer-close:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-transfer-close::before {
      content: '×';
      font-size: 18px;
      line-height: 1;
    }
    .sms-transfer-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sms-transfer-stage { display: none; flex-direction: column; gap: 14px; }
    .sms-transfer-stage.active { display: flex; }
    .sms-transfer-stage label { font-size: 14px; letter-spacing: 0.03em; }
    .sms-transfer-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-transfer-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.42);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.16);
    }
    .sms-transfer-input::placeholder { color: rgba(243,243,243,0.58); }
    .sms-transfer-input.error {
      border-color: rgba(255,112,112,0.7);
      box-shadow: 0 0 0 2px rgba(255,112,112,0.25);
    }
    .sms-transfer-tip { font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.68); }
    .sms-transfer-actions { display: flex; justify-content: flex-end; gap: 12px; }
    .sms-transfer-btn {
      min-width: 88px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, border-color .2s ease;
    }
    .sms-transfer-btn:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .sms-transfer-btn--primary { border-color: rgba(255,255,255,0.75); background: rgba(255,255,255,0.92); color: #1f2330; }
    .sms-transfer-btn--primary:hover { background: rgba(255,255,255,0.98); }
    .sms-red-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(12,12,16,0.58);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 272;
    }
    .sms-red-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .sms-red-dialog {
      position: relative;
      width: min(360px, 100%);
      padding: 28px 26px 24px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 28px 54px rgba(0,0,0,0.35);
      color: var(--panel-text-color);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .sms-red-dialog h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }
    .sms-red-close {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-red-close:hover {
      background: rgba(255,255,255,0.16);
      transform: translateY(-1px);
    }
    .sms-red-close::before {
      content: '×';
      font-size: 18px;
      line-height: 1;
    }
    .sms-red-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sms-red-stage {
      display: none;
      flex-direction: column;
      gap: 14px;
    }
    .sms-red-stage.active {
      display: flex;
    }
    .sms-red-stage label {
      font-size: 14px;
      letter-spacing: 0.03em;
    }
    .sms-red-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 15px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-red-input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.42);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.16);
    }
    .sms-red-input::placeholder {
      color: rgba(243,243,243,0.58);
    }
    .sms-red-input.error {
      border-color: rgba(255,112,112,0.7);
      box-shadow: 0 0 0 2px rgba(255,112,112,0.25);
    }
    .sms-red-tip {
      font-size: 13px;
      line-height: 1.6;
      color: rgba(255,255,255,0.68);
    }
    .sms-red-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .sms-red-btn {
      min-width: 88px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
      color: inherit;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, border-color .2s ease;
    }
    .sms-red-btn:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .sms-red-btn--primary {
      border-color: rgba(255,255,255,0.75);
      background: rgba(255,255,255,0.92);
      color: #1f2330;
    }
    .sms-red-btn--primary:hover {
      background: rgba(255,255,255,0.98);
    }
    .sms-avatar-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sms-avatar-form label {
      font-size: 14px;
      letter-spacing: 0.03em;
    }
    .sms-avatar-form input {
      width: 100%;
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.18);
      color: inherit;
      font-size: 15px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .sms-avatar-form input:focus {
      outline: none;
      border-color: rgba(255,255,255,0.46);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.18), inset 0 1px 2px rgba(0,0,0,0.18);
    }
    .sms-avatar-form input::placeholder {
      color: rgba(243,243,243,0.58);
    }
    .sms-avatar-hint {
      margin: -6px 0 0;
      font-size: 12px;
      color: rgba(243,243,243,0.68);
      letter-spacing: 0.02em;
    }
    .sms-avatar-actions {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .sms-avatar-btn {
      min-width: 88px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 14px;
      letter-spacing: 0.03em;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, border-color .2s ease;
    }
    .sms-avatar-btn--primary {
      background: rgba(255,255,255,0.92);
      color: #1f2330;
    }
    .sms-avatar-btn--primary:hover {
      background: rgba(255,255,255,0.98);
      transform: translateY(-1px);
    }
    .sms-avatar-btn--secondary {
      background: transparent;
      border-color: rgba(255,255,255,0.34);
      color: inherit;
    }
    .sms-avatar-btn--secondary:hover {
      background: rgba(255,255,255,0.14);
      transform: translateY(-1px);
    }
    /* 联系人管理（仅在短信设置弹窗内显示） */
    #sms-settings-overlay .contact-manager { display: flex; flex-direction: column; gap: 10px; margin-top: 14px; }
    #sms-settings-overlay .contact-manager h4 { margin: 0; font-size: 16px; letter-spacing: 0.03em; }
    #sms-settings-overlay .contact-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    #sms-settings-overlay .contact-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 8px; }
    #sms-settings-overlay .contact-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.16); }
    #sms-settings-overlay .contact-avatar { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.15); color: #fff; font-size: 14px; }
    #sms-settings-overlay .contact-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    #sms-settings-overlay .contact-name { flex: 1; min-width: 0; }
    #sms-settings-overlay .contact-meta { opacity: 0.75; font-size: 13px; }
    #sms-settings-overlay .contact-actions { display: flex; gap: 8px; }
    #sms-settings-overlay .contact-actions button { min-width: 0; padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.22); background: rgba(255,255,255,0.06); color: inherit; cursor: pointer; transition: background .2s ease, transform .2s ease; }
    #sms-settings-overlay .contact-actions button:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    #sms-settings-overlay .contact-form { display: none; }
    #sms-settings-overlay .contact-form.open { display: block; }
    @media (max-width: 560px) {
      #sms-panel {
        inset: 5% 4% 2%;
        padding: 16px 18px 10px;
        gap: 14px;
      }
      .sms-composer {
        padding: 4px 0 0;
      }
      .sms-settings-dialog {
        padding: 22px 18px 18px;
      }
      .sms-avatar-actions {
        flex-direction: column;
        gap: 10px;
      }
      .sms-avatar-btn {
        width: 100%;
      }
    }
    /* 恢复底部输入框，方便继续回复短信 */
    .sms-composer {
      position: relative;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      padding: 12px 0 0;
      border-top: 1px solid rgba(255,255,255,0.12);
      background: transparent;
    }
    .sms-composer .sms-attach-toggle {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: none;
      background: rgba(255,255,255,0.12);
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: background .2s ease, transform .2s ease;
    }
    .sms-composer .sms-attach-toggle:hover {
      background: rgba(255,255,255,0.18);
      transform: translateY(-1px);
    }
    .sms-composer .sms-attach-toggle svg {
      width: 22px;
      height: 22px;
      transition: transform .2s ease;
    }
    .sms-composer .sms-attach-toggle[aria-expanded="true"] svg {
      transform: rotate(45deg);
    }
    .sms-composer .sms-input {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 6px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.18);
      gap: 8px;
      min-height: 44px;
      min-width: 0;
    }
    .sms-composer .sms-input textarea {
      flex: 1;
      border: none;
      background: transparent;
      color: inherit;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.45;
      resize: none;
      min-height: 32px;
      max-height: 120px;
      outline: none;
      padding: 0;
      min-width: 0;
    }
    .sms-composer .sms-send {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: rgba(255,255,255,0.24);
      color: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .2s, transform .2s cubic-bezier(0.25, 0.8, 0.25, 1);
      flex-shrink: 0;
    }
    .sms-composer .sms-send:hover {
      background: rgba(255,255,255,0.34);
      transform: translateY(-2px);
    }
    .sms-composer .sms-send svg {
      width: 24px;
      height: 24px;
    }
    .sms-action-menu {
      position: absolute;
      left: 0;
      bottom: calc(100% + 12px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 16px;
      background: var(--panel-bg);
      color: var(--panel-text-color);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 24px 48px rgba(0,0,0,0.32);
      backdrop-filter: blur(var(--panel-blur-strong, 16px));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(6px);
      transition: opacity .2s ease, transform .2s ease, visibility .2s ease;
      z-index: 5;
      max-width: min(360px, 88vw);
    }
    .sms-action-menu.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
    }
    .sms-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 72px;
      min-height: 64px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-family: inherit;
      font-size: 13px;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, box-shadow .2s ease;
    }
    .sms-action-btn:hover {
      background: rgba(255,255,255,0.18);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.22);
    }
    .sms-action-icon {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.16);
      color: inherit;
      font-size: 16px;
    }
    .sms-action-label {
      color: var(--panel-text-color);
      opacity: 0.9;
      font-size: 12px;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }
    .sms-input.error {
      border-color: rgba(255,105,105,0.75);
      box-shadow: 0 0 0 2px rgba(255,105,105,0.28), inset 0 1px 3px rgba(0,0,0,0.25);
      animation: smsInputShake .32s ease;
    }
    @keyframes smsInputShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-4px); }
      40% { transform: translateX(4px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }
    #control-bar {
      position: absolute;
      top: 24px;
      right: 24px;
      bottom: auto;
      display: flex;
      flex-direction: row-reverse;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      z-index: 220;
      pointer-events: auto;
    }
    #control-bar button {
      position: relative;
      width: var(--control-button-size, 44px);
      height: var(--control-button-size, 44px);
      border-radius: 10px;
      border: none;
      background: var(--control-icon-bg);
      color: var(--control-icon-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform .2s;
    }
    #control-bar .control-group {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      overflow: hidden;
      transition: opacity .25s ease, transform .25s ease, max-width .25s ease;
      flex: 0 1 360px;
      max-width: 360px;
    }
    #control-bar:not(.control-bar--expanded) .control-group {
      opacity: 0;
      transform: translateX(12px) scale(0.98);
      pointer-events: none;
      visibility: hidden;
      max-width: 0;
    }
    #control-bar.control-bar--expanded .control-group {
      opacity: 1;
      transform: none;
      visibility: visible;
      max-width: 360px;
    }
    #control-toggle {
      width: var(--control-button-size, 44px);
      height: var(--control-button-size, 44px);
      border-radius: 12px;
      background: var(--control-icon-bg);
      color: var(--control-icon-color);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform .2s, background .2s;
    }
    #control-toggle:hover {
      transform: translateY(-3px);
    }
    #control-bar.control-bar--expanded #control-toggle {
      background: var(--control-icon-bg);
    }
    #control-bar button:hover {
      transform: translateY(-3px);
    }
    #control-bar button.active {
      background: var(--control-icon-bg);
    }
    #control-bar button svg {
      width: var(--control-icon-svg-size, 22px);
      height: var(--control-icon-svg-size, 22px);
    }
    /* 音乐开关按钮：在控制条内表现为普通按钮；在无控制条时使用浮动样式 */
    #music-toggle {
      width: var(--control-button-size, 44px);
      height: var(--control-button-size, 44px);
      border-radius: 12px;
      background: var(--control-icon-bg);
      color: var(--control-icon-color);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform .2s ease, background .2s ease;
    }
    /* 浮动样式（当未能挂入控制条时添加该类） */
    #music-toggle.music-float {
      position: absolute;
      top: 24px;
      right: 24px;
      z-index: 240;
    }
    #music-toggle svg { width: var(--control-icon-svg-size, 22px); height: var(--control-icon-svg-size, 22px); }
    #music-toggle:hover { transform: translateY(-3px); }
    #auto-toggle .icon-auto-state {
      display: flex;
    }
    #auto-toggle .icon-auto-playing {
      display: none;
    }
    #auto-toggle.active .icon-auto-playing {
      display: flex;
    }
    #auto-toggle.active .icon-auto-paused {
      display: none;
    }
    #aspect-btn .icon-mobile { display: none; }
    #responsive-container.desktop-mode #aspect-btn .icon-desktop { display: none; }
    #responsive-container.desktop-mode #aspect-btn .icon-mobile { display: block; }

    #settings-panel,
    #history-panel,
    #cg-gallery {
      position: absolute;
      top: 6%;
      bottom: 18%;
      width: 280px;
      background: var(--panel-bg);
      border-radius: 18px;
      padding: 18px 22px;
      color: var(--panel-text-color);
      display: none;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
      z-index: 240;
      backdrop-filter: blur(var(--panel-blur, 14px));
      box-shadow: 0 16px 36px rgba(0,0,0,0.4);
    }
    #settings-panel { left: 24px; }
    #history-panel { left: 24px; }
    #cg-gallery { right: 24px; }
    #settings-panel.panel-open,
    #history-panel.panel-open,
    #cg-gallery.panel-open {
      display: flex;
    }
    #history-list,
    #cg-list {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      scrollbar-width: thin;
      flex: 1;
    }
    #history-list li {
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.6;
    }
    .history-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .history-content {
      flex: 1;
    }
    .history-speaker {
      font-weight: 600;
      color: inherit;
    }
    .history-text {
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .history-jump {
      width: 18px;
      height: 18px;
      border: none;
      padding: 0;
      border-radius: 50%;
      background: transparent;
      position: relative;
      cursor: pointer;
      flex: 0 0 18px;
    }
    .history-jump::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.45);
      transition: transform .2s ease, background .2s ease;
    }
    .history-item.current .history-jump::before {
      background: rgba(255,255,255,0.9);
    }
    .history-jump:hover::before,
    .history-jump:focus-visible::before {
      transform: scale(1.2);
      background: rgba(255,255,255,0.75);
    }
    .history-jump:focus-visible {
      outline: 2px solid rgba(255,255,255,0.6);
      outline-offset: 2px;
    }
    #cg-list li {
      margin-bottom: 14px;
    }
    #cg-list li:last-child {
      margin-bottom: 0;
    }
    .cg-thumb {
      width: 100%;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      display: block;
      border-radius: 12px;
      overflow: hidden;
    }
    .cg-thumb:focus-visible {
      outline: 2px solid rgba(255,255,255,0.6);
      outline-offset: 4px;
    }
    .cg-thumb img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
      filter: brightness(0.92);
      transition: transform .25s ease, filter .25s ease;
    }
    .cg-thumb:hover img,
    .cg-thumb:focus-visible img {
      transform: scale(1.02);
      filter: brightness(1);
    }
    body.no-scroll {
      overflow: hidden;
    }
    #cg-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.65);
      z-index: 320;
      padding: 28px;
    }
    #cg-overlay.cg-overlay--open {
      display: flex;
    }
    .cg-overlay-content {
      position: relative;
      background: var(--panel-bg);
      color: var(--panel-text-color);
      border-radius: 18px;
      max-width: min(960px, 90vw);
      max-height: min(85vh, 720px);
      width: 100%;
      padding: 24px 64px;
      box-shadow: 0 16px 42px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #cg-overlay-image {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      object-fit: contain;
    }
    .cg-overlay-close {
      position: absolute;
      top: 16px;
      right: 16px;
      border: none;
      background: rgba(255,255,255,0.12);
      color: var(--panel-text-color);
      border-radius: 999px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      line-height: 1;
    }
    .cg-overlay-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .cg-overlay-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(255,255,255,0.12);
      color: var(--panel-text-color);
      border-radius: 999px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .cg-overlay-nav svg {
      width: 26px;
      height: 26px;
    }
    .cg-overlay-close span {
      display: inline-block;
      font-size: 24px;
      line-height: 1;
    }
    .cg-overlay-nav:hover {
      background: rgba(255,255,255,0.2);
    }
    .cg-overlay-prev { left: 16px; }
    .cg-overlay-next { right: 16px; }
    .cg-overlay-nav[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
    }
    @media (max-width: 768px) {
      #cg-overlay {
        padding: 12px;
      }
      .cg-overlay-content {
        width: 100%;
        height: 100%;
        max-width: none;
        max-height: none;
        border-radius: 0;
        background: transparent;
        box-shadow: none;
        padding: 0;
      }
      #cg-overlay-image {
        width: 100%;
        max-height: calc(100vh - 80px);
        height: auto;
        border-radius: 12px;
      }
      .cg-overlay-close {
        top: 16px;
        right: 16px;
        background: none;
        border-radius: 0;
        width: auto;
        height: auto;
        padding: 8px;
        color: #ffffff;
      }
      .cg-overlay-close span {
        font-size: 30px;
      }
      .cg-overlay-nav {
        background: none;
        border-radius: 0;
        width: auto;
        height: auto;
        padding: 8px;
        color: #ffffff;
      }
      .cg-overlay-prev { left: 8px; }
      .cg-overlay-next { right: 8px; }
      .cg-overlay-nav svg {
        width: 32px;
        height: 32px;
      }
      .cg-overlay-nav[disabled] {
        opacity: 0.25;
      }
    }
    .setting-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 14px;
    }
    .setting-row label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      gap: 12px;
    }
    .setting-row label small {
      font-weight: 400;
      opacity: 0.7;
    }
    .slider-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-wrap span {
      font-size: 12px;
      opacity: 0.8;
    }
    input[type="range"] {
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: white;
      flex: 1;
      cursor: grab;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid rgba(0,0,0,0.35);
      cursor: grabbing;
    }
    .color-input--hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: 0;
      border: 0;
      overflow: hidden;
      clip: rect(0 0 0 0);
      clip-path: inset(50%);
    }
    .setting-row.color-setting {
      flex-direction: row;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .setting-row.color-setting label {
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      font-weight: 600;
      min-width: 120px;
    }
    .color-picker-host {
      display: inline-flex;
      flex: 0 0 auto;
    }
    .color-picker-host .arco-color-picker-trigger {
      width: auto;
      min-width: 120px;
    }
    .color-picker-host.color-picker-host--fallback {
      flex: 1 1 160px;
    }
    .color-picker-fallback {
      width: 100%;
      min-width: 140px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: inherit;
      padding: 8px 10px;
      font-size: 14px;
      transition: border-color .2s, background .2s;
    }
    .color-picker-fallback:focus {
      outline: none;
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.12);
    }
    input[type="number"] {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: inherit;
      padding: 8px 10px;
      font-size: 14px;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: rgba(255,255,255,0.45);
      background: rgba(255,255,255,0.12);
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    button.secondary {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: inherit;
      cursor: pointer;
      transition: background .2s;
    }
    button.secondary.active {
      background: rgba(255,255,255,0.2);
    }
    button.secondary:hover { background: rgba(255,255,255,0.16); }
    audio { display: none; }

    /* 视频通话界面 */
    #video-panel {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 24px 24px 32px;
      z-index: 210;
      pointer-events: auto;
      color: var(--panel-text-color);
    }
    /* 右侧挂断按钮右边按钮触发的左上角用户小预览 */
    .video-user-preview {
      position: absolute;
      top: calc(var(--control-button-size, 44px) * 0.3);
      left: calc(var(--control-button-size, 44px) * 0.3);
      width: min(240px, calc(var(--control-button-size, 44px) * 3.0));
      aspect-ratio: 3 / 4;
      background: #cccccc center / cover no-repeat;
      border-radius: 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.2);
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      display: none;
      cursor: pointer;
      z-index: 1;
    }
    .video-user-preview.show { display: block; }
    .video-user-preview .user-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .video-user-preview.has-image .user-placeholder { display: none; }
    #responsive-container.video-mode #video-panel { display: flex; }
    #responsive-container.video-mode #dialogue-box,
    #responsive-container.video-mode #background-img,
    #responsive-container.video-mode #cg-img {
      filter: blur(6px) brightness(0.65);
      pointer-events: none;
    }
    /* 视频模式隐藏普通对话框 */
    #responsive-container.video-mode #dialogue-box { display: none; }
    .video-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    }
    .video-contact {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .video-controls {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 28px;
    }
    .video-btn {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: none;
      background: rgba(18,18,20,0.76);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
      transition: transform .18s ease, background .18s ease;
      cursor: pointer;
    }
    .video-btn:hover { transform: translateY(-2px); background: rgba(18,18,20,0.88); }
    .video-btn:active { transform: scale(0.96); }
    .video-btn svg { width: 26px; height: 26px; }
    .video-btn--end {
      width: 66px;
      height: 66px;
      background: #e53935;
    }
    .video-btn--end:hover { background: #d32f2f; }
    .video-btn[aria-pressed="true"] { background: rgba(255,255,255,0.28); color: #1f2330; }
    @media (max-width: 560px) {
      .video-controls { gap: 22px; }
      .video-btn { width: 50px; height: 50px; }
      .video-btn--end { width: 60px; height: 60px; }
    }
    /* 视频通话文本气泡 */
    .video-bubble {
      display: none;
      max-width: 86%;
      padding: 12px 16px;
      border-radius: 18px;
      background: var(--dialogue-background);
      color: var(--dialogue-text-color);
      font-size: var(--dialogue-font-size);
      line-height: 1.6;
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 16px 36px rgba(0,0,0,0.26);
      backdrop-filter: blur(var(--dialogue-blur, 6px));
      text-align: left;
      /* 将气泡推到底部靠近控制栏 */
      margin: 8px 0 14px;
      margin-top: auto;
      align-self: center;
      position: relative;
    }
    .video-bubble::after { content: none; }
    @media (max-width: 820px) {
      #control-bar {
        top: 12px;
        right: 12px;
        bottom: auto;
        gap: 8px;
        min-width: 0;
        align-items: flex-start;
      }
      #control-bar button {
        width: calc(var(--control-button-size, 44px) * 0.86);
        height: calc(var(--control-button-size, 44px) * 0.86);
      }
      #control-bar button svg {
        width: calc(var(--control-icon-svg-size, 22px) * 0.82);
        height: calc(var(--control-icon-svg-size, 22px) * 0.82);
      }
      #control-bar .control-group {
        flex: 1 1 276px;
        max-width: 100%;
        gap: 8px;
        margin-left: 8px;
        flex-wrap: wrap;
      }
      #control-bar:not(.control-bar--expanded) .control-group {
        margin-left: 8px;
      }
      .sms-bubble {
        gap: 10px;
        margin: 12px 0;
      }
      .sms-bubble .bubble-body {
        max-width: 82%;
      }
      .sms-composer {
        padding: 10px 16px 14px;
        gap: 8px;
      }
      .sms-composer .sms-input {
        padding: 8px 12px;
        border-radius: 12px;
      }
      .sms-composer .sms-send {
        width: 40px;
        height: 40px;
        border-radius: 12px;
      }
      #settings-panel,
      #history-panel,
      #cg-gallery {
        top: 10%;
        bottom: 10%;
        width: 86%;
        left: 50%;
        transform: translateX(-50%);
      }
      .choice-panel {
        width: calc(100% - 20px);
        max-width: 600px;
        padding: 28px 22px 34px;
        gap: 18px;
      }
      .choice-close {
        top: 6px;
        right: 8px;
        width: 28px;
        height: 28px;
      }
      .choice-custom__input-wrap {
        gap: 10px;
      }
      .choice-input {
        font-size: 15px;
      }
      .choice-send {
        min-width: 86px;
        padding: 10px 18px;
        font-size: 15px;
      }
    }
    @media (max-width: 560px) {
      .choice-panel {
        padding: 26px 20px 32px;
        gap: 16px;
      }
      .choice-custom__input-wrap {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }
      .choice-input {
        flex: 0 0 auto;
        width: 100%;
        min-height: 0;
        padding: 10px 14px;
      }
      .choice-send {
        width: 100%;
        min-width: 0;
      }
    }</style></head><body><div id="responsive-container" class="offline-mode"><div id="background-fill" class="background-fill" aria-hidden="true"></div><img id="background-img" class="background-element" alt=""><div id="content-wrapper"><img id="cg-img" class="cg-element" alt=""><div id="character-layer"><img id="character-sprite" alt=""></div><div id="effect-layer" class="effect-layer"><div class="blood-layer" aria-hidden="true"><div class="blood-top"></div><div class="drips"><span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span> <span class="drip"></span></div><div class="blood-mark mark-lb"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 700 700" style="overflow: hidden; display: block;" width="700" height="700"><defs></defs><g id="two-0" transform="matrix(1 0 0 1 0 0)" opacity="1"><path transform="matrix(1 0 0 1 350 350)" id="two-576" d="M 191.012055 45.270688 C 183.665409 71.721218 227.805727 90.103959 233.061646 117.047958 C 237.528672 139.947765 227.244677 164.093156 222.871002 187.010975 C 217.451893 215.406808 226.290464 255.565639 202.68611 272.254695 C 178.455703 289.386391 142.176043 255.85752 113.280158 262.612926 C 90.344221 267.97499 75.654017 307.601511 53.062871 300.934496 C 5.517057 286.902952 39.817851 168.619152 -9.574931 164.395214 C -50.527263 160.89308 -39.071814 271.160379 -79.976546 267.140265 C -106.3548 264.547811 -105.380401 219.075416 -111.608901 193.312285 C -117.038774 170.852537 -96.999024 135.888107 -116.479756 123.461328 C -167.235624 91.084108 -253.842844 239.012721 -286.861403 188.671712 C -320.054555 138.064515 -137.668793 114.513012 -158.493873 57.687051 C -179.751438 -0.319045 -310.553439 91.667347 -344.893631 40.312283 C -359.831511 17.972984 -338.086604 -16.847746 -320.901148 -37.507965 C -299.617312 -63.095224 -251.404796 -57.568064 -231.544436 -84.275283 C -219.438234 -100.5551 -234.403598 -130.436895 -219.921383 -144.644569 C -202.766597 -161.474149 -172.179124 -156.232367 -148.161076 -157.041566 C -127.877807 -157.724935 -102.349203 -137.406882 -86.992191 -150.674895 C -56.32997 -177.166165 -99.278939 -236.782307 -81.837975 -273.357873 C -69.963036 -298.26089 -45.8917 -335.422901 -19.142597 -328.665685 C 29.108836 -316.476665 -10.32918 -211.637501 33.000889 -187.157344 C 48.221384 -178.558232 68.494098 -191.44975 85.03002 -197.121744 C 119.896681 -209.081372 147.69561 -246.595736 184.534266 -247.872537 C 210.900238 -248.786363 238.749616 -234.504999 258.094878 -216.567318 C 276.898093 -199.132245 290.446066 -172.984353 293.827419 -147.565677 C 297.484878 -120.071423 279.398409 -92.952576 276.033069 -65.42104 C 273.412449 -43.981991 285.379017 -18.403639 274.073861 -0.000001 C 257.734148 26.599381 199.366382 15.192149 191.012055 45.270688 Z " fill="hsl(10, 75%, 40%)" stroke="undefined" stroke-width="1" stroke-opacity="1" fill-opacity="1" visibility="visible" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4"></path></g></svg></div><div class="blood-mark mark-tr"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 700 700" style="overflow: hidden; display: block;" width="700" height="700"><defs></defs><g id="two-0" transform="matrix(1 0 0 1 0 0)" opacity="1"><path transform="matrix(1 0 0 1 350 350)" id="two-576" d="M 191.012055 45.270688 C 183.665409 71.721218 227.805727 90.103959 233.061646 117.047958 C 237.528672 139.947765 227.244677 164.093156 222.871002 187.010975 C 217.451893 215.406808 226.290464 255.565639 202.68611 272.254695 C 178.455703 289.386391 142.176043 255.85752 113.280158 262.612926 C 90.344221 267.97499 75.654017 307.601511 53.062871 300.934496 C 5.517057 286.902952 39.817851 168.619152 -9.574931 164.395214 C -50.527263 160.89308 -39.071814 271.160379 -79.976546 267.140265 C -106.3548 264.547811 -105.380401 219.075416 -111.608901 193.312285 C -117.038774 170.852537 -96.999024 135.888107 -116.479756 123.461328 C -167.235624 91.084108 -253.842844 239.012721 -286.861403 188.671712 C -320.054555 138.064515 -137.668793 114.513012 -158.493873 57.687051 C -179.751438 -0.319045 -310.553439 91.667347 -344.893631 40.312283 C -359.831511 17.972984 -338.086604 -16.847746 -320.901148 -37.507965 C -299.617312 -63.095224 -251.404796 -57.568064 -231.544436 -84.275283 C -219.438234 -100.5551 -234.403598 -130.436895 -219.921383 -144.644569 C -202.766597 -161.474149 -172.179124 -156.232367 -148.161076 -157.041566 C -127.877807 -157.724935 -102.349203 -137.406882 -86.992191 -150.674895 C -56.32997 -177.166165 -99.278939 -236.782307 -81.837975 -273.357873 C -69.963036 -298.26089 -45.8917 -335.422901 -19.142597 -328.665685 C 29.108836 -316.476665 -10.32918 -211.637501 33.000889 -187.157344 C 48.221384 -178.558232 68.494098 -191.44975 85.03002 -197.121744 C 119.896681 -209.081372 147.69561 -246.595736 184.534266 -247.872537 C 210.900238 -248.786363 238.749616 -234.504999 258.094878 -216.567318 C 276.898093 -199.132245 290.446066 -172.984353 293.827419 -147.565677 C 297.484878 -120.071423 279.398409 -92.952576 276.033069 -65.42104 C 273.412449 -43.981991 285.379017 -18.403639 274.073861 -0.000001 C 257.734148 26.599381 199.366382 15.192149 191.012055 45.270688 Z " fill="hsl(10, 75%, 40%)" stroke="undefined" stroke-width="1" stroke-opacity="1" fill-opacity="1" visibility="visible" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4"></path></g></svg></div></div></div><section id="dialogue-box"><div id="speaker-nameplate"><span id="character-name"></span></div><p id="dialogue-text"></p><div class="dialogue-prompt">点击继续 ▸</div></section><div id="choice-overlay" class="choice-overlay"><div class="choice-panel"><button id="choice-close" type="button" class="choice-close" title="关闭回复面板" aria-label="关闭回复面板"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 48 48"><path fill="currentColor" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="m6 11l5-5l13 13L37 6l5 5l-13 13l13 13l-5 5l-13-13l-13 13l-5-5l13-13z" clip-rule="evenodd"/></svg></button><ul id="choice-list" class="choice-list"></ul><form id="choice-custom" class="choice-custom" autocomplete="off"><label class="choice-custom__label" for="choice-input">自定义回复</label><div class="choice-custom__input-wrap"><input id="choice-input" class="choice-input" placeholder="在这里输入..." maxlength="80"> <button id="choice-send" type="button" class="choice-send">发送</button></div><p class="choice-custom__hint">留空无法发送哦</p></form></div></div><section id="sms-panel"><header class="sms-header"><button class="sms-back" title="关闭消息">←</button> <span id="sms-contact"></span> <button class="sms-settings" title="设置"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="m9.25 22l-.4-3.2q-.325-.125-.612-.3t-.563-.375L4.7 19.375l-2.75-4.75l2.575-1.95Q4.5 12.5 4.5 12.338v-.675q0-.163.025-.338L1.95 9.375l2.75-4.75l2.975 1.25q.275-.2.575-.375t.6-.3l.4-3.2h5.5l.4 3.2q.325.125.613.3t.562.375l2.975-1.25l2.75 4.75l-2.575 1.95q.025.175.025.338v.674q0 .163-.05.338l2.575 1.95l-2.75 4.75l-2.95-1.25q-.275.2-.575.375t-.6.3l-.4 3.2zm2.8-6.5q1.45 0 2.475-1.025T15.55 12t-1.025-2.475T12.05 8.5q-1.475 0-2.488 1.025T8.55 12t1.013 2.475T12.05 15.5"/></svg></button></header><ul id="sms-thread"></ul><form id="sms-composer-form" class="sms-composer" autocomplete="off"><button type="button" class="sms-attach-toggle" aria-label="更多功能" aria-haspopup="true" aria-expanded="false"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V5a1 1 0 1 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2z"/></svg></button><div class="sms-action-menu" role="menu" aria-hidden="true"><button type="button" class="sms-action-btn" data-action="voice" role="menuitem"><span class="sms-action-icon">语</span> <span class="sms-action-label">语音</span></button> <button type="button" class="sms-action-btn" data-action="red" role="menuitem"><span class="sms-action-icon">红</span> <span class="sms-action-label">红包</span></button> <button type="button" class="sms-action-btn" data-action="transfer" role="menuitem"><span class="sms-action-icon">转</span> <span class="sms-action-label">转账</span></button> <button type="button" class="sms-action-btn" data-action="video" role="menuitem"><span class="sms-action-icon">视</span> <span class="sms-action-label">视频</span></button> <button type="button" class="sms-action-btn" data-action="image" role="menuitem"><span class="sms-action-icon">图</span> <span class="sms-action-label">图片</span></button></div><div class="sms-input"><textarea id="sms-input" rows="1" placeholder="输入回复..." autocomplete="off"></textarea></div><button type="button" class="sms-send" aria-label="发送"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><g fill="none"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M20.235 5.686c.432-1.195-.726-2.353-1.921-1.92L3.709 9.048c-1.199.434-1.344 2.07-.241 2.709l4.662 2.699l4.163-4.163a1 1 0 0 1 1.414 1.414L9.544 15.87l2.7 4.662c.638 1.103 2.274.957 2.708-.241z"/></g></svg></button></form></section><section id="video-panel" aria-hidden="true"><header class="video-header"><span id="video-contact" class="video-contact"></span></header><div id="video-user-preview" class="video-user-preview" role="button" aria-label="用户头像预览" title="点击设置头像图片（可多张）" tabindex="0"><div class="user-placeholder" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><circle cx="12" cy="6" r="4" fill="#606060"/><path fill="#606060" d="M20 17.5c0 2.485 0 4.5-8 4.5s-8-2.015-8-4.5S7.582 13 12 13s8 2.015 8 4.5"/></svg></div></div><div id="video-bubble" class="video-bubble" aria-live="polite"></div><div class="video-controls" role="group" aria-label="视频通话控制"><button type="button" id="video-mic-btn" class="video-btn" aria-pressed="false" title="麦克风"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3m5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-4.08A7 7 0 0 0 19 11z"/></svg></button> <button type="button" id="video-hangup-btn" class="video-btn video-btn--end" title="挂断"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6.62 10.79a15.53 15.53 0 0 1 10.76 0l.8.32a1.5 1.5 0 0 1 .89 1.92l-.67 1.86a1.5 1.5 0 0 1-1.9.93l-2.1-.75a1.5 1.5 0 0 1-.96-1.03l-.12-.43a12.7 12.7 0 0 0-2.62 0l-.12.43c-.14.49-.52.88-1 .99l-2.06.74a1.5 1.5 0 0 1-1.9-.93L4.17 13a1.5 1.5 0 0 1 .9-1.92z"/></svg></button> <button type="button" id="video-cam-btn" class="video-btn" aria-pressed="false" title="摄像头"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M17 10.5V7a2 2 0 0 0-2-2H5A2 2 0 0 0 3 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3.5l4 4v-11z"/></svg></button></div></section><div id="sms-settings-overlay" class="sms-settings-overlay" aria-hidden="true"><div class="sms-settings-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-avatar-heading"><button type="button" class="sms-settings-close" aria-label="关闭头像设置"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="currentColor" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="m6 11l5-5l13 13L37 6l5 5l-13 13l13 13l-5 5l-13-13l-13 13l-5-5l13-13z" clip-rule="evenodd"/></svg></button><h3 id="sms-avatar-heading">头像与昵称</h3><form id="sms-avatar-form" class="sms-avatar-form" autocomplete="off"><label for="sms-avatar-input">头像图片 URL</label> <input id="sms-avatar-input" type="url" placeholder="https://example.com/avatar.png" spellcheck="false" inputmode="url"><p class="sms-avatar-hint">填写图片地址后保存，仅保存在本地浏览器。</p><label for="sms-nickname-input">我的昵称</label> <input id="sms-nickname-input" placeholder="例如：{{user}} / 小明" maxlength="24" autocomplete="off" spellcheck="false"><p class="sms-avatar-hint">用于短信界面展示，默认是 {{user}}，仅保存在本地。</p><div class="sms-avatar-actions"><button type="button" id="sms-avatar-clear" class="sms-avatar-btn sms-avatar-btn--secondary">清除头像</button> <button type="button" id="sms-nickname-clear" class="sms-avatar-btn sms-avatar-btn--secondary">清除昵称</button> <button type="submit" class="sms-avatar-btn sms-avatar-btn--primary">保存</button></div></form></div></div><div id="sms-image-overlay" class="sms-image-overlay" aria-hidden="true"><div class="sms-image-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-image-heading"><button type="button" class="sms-image-close" aria-label="关闭图片描述输入"></button><h3 id="sms-image-heading">发送图片</h3><form id="sms-image-form" class="sms-image-form" autocomplete="off"><label for="sms-image-text">输入这张图片的内容</label> <textarea id="sms-image-text" class="sms-image-textarea" rows="4" maxlength="160" placeholder="例如：一只穿着红色雨衣的小狗站在雨巷里"></textarea><div class="sms-image-actions"><button type="button" class="sms-image-btn sms-image-cancel">取消</button> <button type="submit" class="sms-image-btn sms-image-btn--primary">完成</button></div></form></div></div><div id="video-user-overlay" class="video-user-overlay" aria-hidden="true"><div class="video-user-dialog" role="dialog" aria-modal="true" aria-labelledby="video-user-heading"><button type="button" class="video-user-close" aria-label="关闭视频头像设置"></button><h3 id="video-user-heading">视频头像设置</h3><form id="video-user-form" class="video-user-form" autocomplete="off"><label for="video-user-urls">图片链接（每行一条）</label> <textarea id="video-user-urls" class="video-user-textarea" rows="5" placeholder="https://example.com/a.jpg&#10;https://example.com/b.png"></textarea><div class="video-user-row"><label for="video-user-interval">轮播间隔（秒）</label> <input id="video-user-interval" type="number" min="1" max="60" step="1" inputmode="numeric" placeholder="3"></div><div class="video-user-actions"><button type="button" class="video-user-btn video-user-clear" title="清空所有头像">清空头像</button> <button type="button" class="video-user-btn video-user-cancel">取消</button> <button type="submit" class="video-user-btn video-user-btn--primary">保存</button></div></form></div></div><div id="sms-red-overlay" class="sms-red-overlay" aria-hidden="true"><div class="sms-red-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-red-heading"><button type="button" class="sms-red-close" aria-label="关闭红包输入"></button><h3 id="sms-red-heading">发红包</h3><form id="sms-red-form" class="sms-red-form" autocomplete="off"><div class="sms-red-stage active" data-step="label"><label for="sms-red-label">红包封面留言</label> <input id="sms-red-label" class="sms-red-input" placeholder="例如：我爱你bb" maxlength="24"><div class="sms-red-actions"><button type="button" class="sms-red-btn sms-red-cancel">取消</button> <button type="submit" class="sms-red-btn sms-red-btn--primary">完成</button></div></div><div class="sms-red-stage" data-step="amount"><label for="sms-red-amount">红包金额（元）</label> <input id="sms-red-amount" class="sms-red-input" type="number" min="0.01" step="0.01" placeholder="例如：520"><div class="sms-red-actions"><button type="button" class="sms-red-btn sms-red-back">返回</button> <button type="submit" class="sms-red-btn sms-red-btn--primary">完成</button></div></div></form></div></div><div id="sms-voice-overlay" class="sms-voice-overlay" aria-hidden="true"><div class="sms-voice-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-voice-heading"><button type="button" class="sms-voice-close" aria-label="关闭语音输入"></button><h3 id="sms-voice-heading">语音消息</h3><form id="sms-voice-form" class="sms-voice-form" autocomplete="off"><div class="sms-voice-stage sms-voice-stage--content active" data-step="content"><label for="sms-voice-content">输入你想说的话</label> <textarea id="sms-voice-content" class="sms-voice-textarea" rows="4" placeholder="在这里输入语音内容..." maxlength="180"></textarea><div class="sms-voice-actions"><button type="button" class="sms-voice-btn sms-voice-cancel">取消</button> <button type="submit" class="sms-voice-btn sms-voice-btn--primary">完成</button></div></div><div class="sms-voice-stage sms-voice-stage--duration" data-step="duration"><label for="sms-voice-duration">语音时长（秒）</label> <input id="sms-voice-duration" class="sms-voice-input" type="number" min="1" step="1" placeholder="例如：29"><div class="sms-voice-actions"><button type="button" class="sms-voice-btn sms-voice-back">返回</button> <button type="submit" class="sms-voice-btn sms-voice-btn--primary">完成</button></div></div></form></div></div><div id="sms-video-overlay" class="sms-video-overlay" aria-hidden="true"><div class="sms-video-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-video-heading"><h3 id="sms-video-heading">视频通话</h3><p id="sms-video-prompt" class="sms-video-prompt">你是否要拨打给{{char}}？</p><div class="sms-video-field"><label for="sms-video-target">拨打对象</label> <input id="sms-video-target" class="sms-video-input" placeholder="例如：陈宵鸣 / 蒋再再" maxlength="24" autocomplete="off" spellcheck="false"></div><div class="sms-video-actions"><button type="button" class="sms-video-btn sms-video-cancel">否</button> <button type="button" class="sms-video-btn sms-video-btn--primary sms-video-confirm">是</button></div></div></div><div id="sms-transfer-overlay" class="sms-transfer-overlay" aria-hidden="true"><div class="sms-transfer-dialog" role="dialog" aria-modal="true" aria-labelledby="sms-transfer-heading"><button type="button" class="sms-transfer-close" aria-label="关闭转账输入"></button><h3 id="sms-transfer-heading">转账</h3><form id="sms-transfer-form" class="sms-transfer-form" autocomplete="off"><div class="sms-transfer-stage active" data-step="target"><label for="sms-transfer-target">转账对象</label> <input id="sms-transfer-target" class="sms-transfer-input" placeholder="例如：陈宵鸣/蒋再再 " maxlength="24"><div class="sms-transfer-actions"><button type="button" class="sms-transfer-btn sms-transfer-cancel">取消</button> <button type="submit" class="sms-transfer-btn sms-transfer-btn--primary">下一步</button></div></div><div class="sms-transfer-stage" data-step="amount"><label for="sms-transfer-amount">转账金额（元）</label> <input id="sms-transfer-amount" class="sms-transfer-input" type="number" min="0.01" step="0.01" placeholder="例如：13.14"><div class="sms-transfer-actions"><button type="button" class="sms-transfer-btn sms-transfer-back">返回</button> <button type="submit" class="sms-transfer-btn sms-transfer-btn--primary">下一步</button></div></div><div class="sms-transfer-stage" data-step="note"><label for="sms-transfer-note">备注（可选）</label> <input id="sms-transfer-note" class="sms-transfer-input" placeholder="例如：聚餐/购物"><div class="sms-transfer-actions"><button type="button" class="sms-transfer-btn sms-transfer-back">返回</button> <button type="submit" class="sms-transfer-btn sms-transfer-btn--primary">完成</button></div></div></form></div></div></div><nav id="control-bar"><button id="control-toggle" class="control-toggle" title="展开控制栏" aria-expanded="false" aria-controls="control-group"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="M8.75 13A2.25 2.25 0 0 1 11 15.25v3.5A2.25 2.25 0 0 1 8.75 21h-3.5A2.25 2.25 0 0 1 3 18.75v-3.5A2.25 2.25 0 0 1 5.25 13zm10-10A2.25 2.25 0 0 1 21 5.25v3.5A2.25 2.25 0 0 1 18.75 11h-3.5A2.25 2.25 0 0 1 13 8.75v-3.5A2.25 2.25 0 0 1 15.25 3z" opacity=".3"/><path fill="currentColor" d="M8.75 3A2.25 2.25 0 0 1 11 5.25v3.5A2.25 2.25 0 0 1 8.75 11h-3.5A2.25 2.25 0 0 1 3 8.75v-3.5A2.25 2.25 0 0 1 5.25 3z"/><path fill="currentColor" d="M18.75 13A2.25 2.25 0 0 1 21 15.25v3.5A2.25 2.25 0 0 1 18.75 21h-3.5A2.25 2.25 0 0 1 13 18.75v-3.5A2.25 2.25 0 0 1 15.25 13z" opacity=".3"/></svg></button><div id="control-group" class="control-group" role="group" aria-label="系统控制"><button id="settings-btn" title="设置"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="m9.25 22l-.4-3.2q-.325-.125-.612-.3t-.563-.375L4.7 19.375l-2.75-4.75l2.575-1.95Q4.5 12.5 4.5 12.338v-.675q0-.163.025-.338L1.95 9.375l2.75-4.75l2.975 1.25q.275-.2.575-.375t.6-.3l.4-3.2h5.5l.4 3.2q.325.125.613.3t.562.375l2.975-1.25l2.75 4.75l-2.575 1.95q.025.175.025.338v.674q0 .163-.05.338l2.575 1.95l-2.75 4.75l-2.95-1.25q-.275.2-.575.375t-.6.3l-.4 3.2zm2.8-6.5q1.45 0 2.475-1.025T15.55 12t-1.025-2.475T12.05 8.5q-1.475 0-2.488 1.025T8.55 12t1.013 2.475T12.05 15.5"/></svg></button> <button id="history-btn" title="历史"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21q-3.45 0-6.012-2.287T3.05 13H5.1q.35 2.6 2.313 4.3T12 19q2.925 0 4.963-2.037T19 12t-2.037-4.962T12 5q-1.725 0-3.225.8T6.25 8H9v2H3V4h2v2.35q1.275-1.6 3.113-2.475T12 3q1.875 0 3.513.713t2.85 1.924t1.925 2.85T21 12t-.712 3.513t-1.925 2.85t-2.85 1.925T12 21m2.8-4.8L11 12.4V7h2v4.6l3.2 3.2z"/></svg></button> <button id="sms-btn" title="打开短信" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 18.75h-10.5l-6 4.5v-4.5h-3a1.5 1.5 0 0 1-1.5-1.5v-15a1.5 1.5 0 0 1 1.5-1.5h19.5a1.5 1.5 0 0 1 1.5 1.5v15a1.5 1.5 0 0 1-1.5 1.5"/><path d="M12 10.125a.375.375 0 0 1 0-.75m0 .75a.375.375 0 0 0 0-.75m-4.5.75a.375.375 0 1 1 0-.75m0 .75a.375.375 0 1 0 0-.75m9 .75a.375.375 0 0 1 0-.75m0 .75a.375.375 0 0 0 0-.75"/></g></svg></button> <button id="cg-btn" title="CG"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2z"/><path d="M19 6h1a2 2 0 0 1 2 2a5 5 0 0 1-5 5h-5v2m-2 1a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/></g></svg></button> <button id="jump-last-btn" title="跳到最后一幕" aria-label="跳到最后一幕"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" d="M12.089 3.634A2 2 0 0 0 11 5.414l-.001 2.585L9 8a1 1 0 0 0-1 1v6l.007.117A1 1 0 0 0 9 16l1.999-.001l.001 2.587A2 2 0 0 0 14.414 20L21 13.414a2 2 0 0 0 0-2.828L14.414 4a2 2 0 0 0-2.18-.434zM3 8a1 1 0 0 1 .993.883L4 9v6a1 1 0 0 1-1.993.117L2 15V9a1 1 0 0 1 1-1m3 0a1 1 0 0 1 .993.883L7 9v6a1 1 0 0 1-1.993.117L5 15V9a1 1 0 0 1 1-1"/></svg></button> <button id="auto-toggle" title="自动播放：关闭" aria-pressed="false"><span class="icon-auto-state icon-auto-playing" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 15L8 18L8 6L13 9L13 9M13 9L18 12L18 12L13 15L13 15"><animate fill="freeze" attributeName="d" dur="0.6s" keyTimes="0;0.33;1" values="M13 15L8 18L8 6L13 9L13 9M13 9L18 12L18 12L13 15L13 15;M13 15L8 18L8 6L13 9L13 15M13 9L18 12L18 12L13 15L13 9;M9 18L7 18L7 6L9 6L9 18M15 6L17 6L17 18L15 18L15 6"/></path></svg> </span><span class="icon-auto-state icon-auto-paused" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><path fill="currentColor" fill-opacity="0" stroke="currentColor" stroke-dasharray="40" stroke-dashoffset="40" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6l10 6l-10 6Z"><animate fill="freeze" attributeName="fill-opacity" begin="0.5s" dur="0.5s" values="0;1"/><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="40;0"/></path></svg></span></button> <button id="aspect-btn" title="手机/电脑切换"><span class="icon-desktop"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 21h5M12 21h-5"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="6;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 21v-4"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="6;0"/></path><path stroke-dasharray="64" stroke-dashoffset="64" d="M12 17h-9v-12h18v12Z"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.3s" dur="0.6s" values="64;0"/></path></g></svg> </span><span class="icon-mobile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 19H7V5h10m0-4H7c-1.11 0-2 .89-2 2v18a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2"/></svg></span></button></div></nav><aside id="settings-panel"><div class="setting-row color-setting"><label for="dialogue-text-color">对话文字颜色</label> <input id="dialogue-text-color" type="hidden" value="#222222" data-format="hex"><div class="color-picker-host" data-target="dialogue-text-color" data-format="hex"></div></div><div class="setting-row color-setting"><label for="dialogue-bg-color">对话框颜色</label> <input id="dialogue-bg-color" type="hidden" value="rgba(255,255,255,0.85)" data-format="rgb"><div class="color-picker-host" data-target="dialogue-bg-color" data-format="rgb" data-alpha="true"></div></div><div class="setting-row color-setting"><label for="panel-text-color">面板字体颜色</label> <input id="panel-text-color" type="hidden" value="#f3f3f3" data-format="hex"><div class="color-picker-host" data-target="panel-text-color" data-format="hex"></div></div><div class="setting-row color-setting"><label for="panel-bg-color">面板框颜色</label> <input id="panel-bg-color" type="hidden" value="rgba(26,26,26,0.78)" data-format="rgb"><div class="color-picker-host" data-target="panel-bg-color" data-format="rgb" data-alpha="true"></div></div><div class="setting-row color-setting"><label for="control-icon-color">控制栏图标颜色</label> <input id="control-icon-color" type="hidden" value="#f2f2f2" data-format="hex"><div class="color-picker-host" data-target="control-icon-color" data-format="hex"></div></div><div class="setting-row color-setting"><label for="control-icon-bg-color">控制栏背景颜色</label> <input id="control-icon-bg-color" type="hidden" value="rgba(18,18,20,0.76)" data-format="rgb"><div class="color-picker-host" data-target="control-icon-bg-color" data-format="rgb" data-alpha="true"></div></div><div class="setting-row"><label for="control-button-size">控制按钮大小 <small id="control-button-size-label">44px</small></label><div class="slider-wrap"><span>小</span> <input id="control-button-size" type="range" min="32" max="80" value="44"> <span>大</span></div></div><div class="setting-row"><label for="dialogue-blur">对话框模糊 <small id="dialogue-blur-label">6px</small></label><div class="slider-wrap"><span>0</span> <input id="dialogue-blur" type="range" min="0" max="100" value="6"> <span>100</span></div></div><div class="setting-row"><label for="panel-blur">面板模糊 <small id="panel-blur-label">14px</small></label><div class="slider-wrap"><span>0</span> <input id="panel-blur" type="range" min="0" max="100" value="14"> <span>100</span></div></div><div class="setting-row"><label for="typing-speed">打字机速度 <small id="typing-speed-label">中等</small></label><div class="slider-wrap"><span>慢</span> <input id="typing-speed" type="range" min="0" max="100" value="40"> <span>快</span></div></div><div class="setting-row"><label for="font-size-input">字体大小 (px)</label> <input id="font-size-input" type="number" min="12" max="64" step="1" value="17"></div><div class="setting-row"><label for="auto-wait-seconds">自动播放停留（秒）</label> <input id="auto-wait-seconds" type="number" min="0" max="10" step="0.5" value="1.6"></div><button id="reset-settings" class="secondary">重置默认</button></aside><aside id="history-panel"><h3>历史记录</h3><ul id="history-list"></ul></aside><aside id="cg-gallery"><h3>CG</h3><ul id="cg-list"></ul></aside><div id="cg-overlay" role="dialog" aria-modal="true" aria-hidden="true"><div class="cg-overlay-content"><button type="button" class="cg-overlay-close" aria-label="关闭 CG"><span aria-hidden="true">×</span></button> <button type="button" class="cg-overlay-nav cg-overlay-prev" aria-label="上一张"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6l6 6zM6 6h2v12H6z"/></svg></button> <img id="cg-overlay-image" alt="CG 预览"> <button type="button" class="cg-overlay-nav cg-overlay-next" aria-label="下一张"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6l-6-6zM16 6h2v12h-2z"/></svg></button></div></div></div><script>const scriptText = `
<VN>
  $1
</VN>
`.trim();

    const CATBOX_BASE = 'https://files.catbox.moe/';

    // 背景资源键解析：支持“白天卧室/卧室白天/黑夜花店/花店夜晚/花店”等写法；
    // 未命中字典时，保持现有短码拼接规则（code → https://files.catbox.moe/code.png）。
    const catbox = (code, ext = 'png') => `${CATBOX_BASE}${code}.${ext}`;
    const 是URL = (s) => /^(https?:)?\/\//i.test(s) || String(s).startsWith('data:') || String(s).startsWith('blob:');
    const 是短码 = (s) => /^[a-z0-9]{5,12}$/i.test(String(s || ''));
    // 将字典里的值解析成最终可用的链接：支持 直接URL / catbox短码 / 带扩展名文件名
    function 解析映射值(v) {
      if (!v) return null;
      const s = String(v).trim();
      if (!s) return null;
      if (是URL(s)) return s;
      if (是短码(s)) return catbox(s);
      // 如果是文件名（带扩展名），保留原样（允许相对路径）
      if (/\.[a-z0-9]+$/i.test(s)) return s;
      return null;
    }
    const 归一时段 = (v) => (v === '夜晚' || v === '晚上' ? '黑夜' : v);

    // 为背景选择提供与立绘/CG一致的“会话稳定随机”支持
    const BG_SESSION_SALT = (Math.random().toString(36).slice(2)) + '-' + Date.now().toString(36);
    const BG_SESSION_CACHE = Object.create(null); // key: 背景键 → 已选中的 URL 或短码

    // 中文背景键 → 直接链接或 { 白天/黑夜: 链接 }
    const 背景表 = {// —— 其他地区 ——
      '女贞路街道':       { '白天': 'https://files.catbox.moe/htgr44.jpg', '黑夜': 'https://files.catbox.moe/vmybil.jpg' },
      '女贞路四号餐桌':        'https://files.catbox.moe/u0yu17.jpg',
      '女贞路四号楼梯下的储物间':        'https://files.catbox.moe/jeilot.jpg',
      '女贞路四号哈利卧室':        'https://files.catbox.moe/8tvlz7.jpg',
      '女贞路四号客厅':        'https://files.catbox.moe/fts769.jpg',
      '汽车内部':        'https://files.catbox.moe/tuiyto.jpg',
      '爬虫馆':        'https://files.catbox.moe/2jgrah.jpg',
      '旅馆':        'https://files.catbox.moe/h10be4.jpg',
      '动物园':        'https://files.catbox.moe/f8yiyp.png',
      '海边':        'https://files.catbox.moe/6ahuxa.jpg',
      '海上小木屋内部':        'https://files.catbox.moe/mewt27.jpg',
      '普通列车里':        'https://files.catbox.moe/vt0mi8.jpg',
      '车站':        'https://files.catbox.moe/upd69d.jpg',
      '街道':       { '白天': 'https://files.catbox.moe/x527eo.jpg', '黑夜': 'https://files.catbox.moe/ma3j5c.jpg' },
      '通用酒吧':        'https://files.catbox.moe/a3dq0z.jpg',
      '破釜酒吧内小天井':        'https://files.catbox.moe/jsecvr.jpg',
      '对角巷':        'https://files.catbox.moe/8aw4dn.jpg',
      '通用动物商店':        'https://files.catbox.moe/m4jbyy.jpg',
      '古灵阁大厅':        'https://files.catbox.moe/ckxtnn.jpg',
      '古灵阁地下通道':        'https://files.catbox.moe/tr2axb.jpg',
      '古灵阁地下金库':        'https://files.catbox.moe/c1r954.jpg',
      '通用服装店':        'https://files.catbox.moe/smkgiw.jpg',
      '丽痕书店':        'https://files.catbox.moe/41tfa0.jpg',
      '对角巷药店':        'https://files.catbox.moe/so0vfs.jpg',
      '奥利凡德魔杖店':        'https://files.catbox.moe/hvs1qp.jpg',
      '国王十字车站第9和10站台间的隔墙':        'https://files.catbox.moe/gfr94x.jpg',
      '帕笛芙夫人茶馆':        'https://files.catbox.moe/raqvmk.jpg',
      '尖叫棚屋':        'https://files.catbox.moe/h6zkti.jpg',
      '霍格莫德街道':       { '白天': 'https://files.catbox.moe/j7l8yg.jpg', '黑夜': 'https://files.catbox.moe/yiv6f7.jpg' },
      '蜂蜜公爵糖果店':        'https://files.catbox.moe/1mskr4.jpg',
      '通用商店':        'https://files.catbox.moe/eakbr1.jpg',
      '帕特奇坩埚店':        'https://files.catbox.moe/i80hht.jpg',
      '韦斯莱魔法把戏坊':        'https://files.catbox.moe/7a9ts0.jpg',
      '魁地奇精品店':        'https://files.catbox.moe/vge72u.jpg',
      '福斯科冰淇淋店':        'https://files.catbox.moe/1h4wl5.jpg',
      '翻倒巷街道':        'https://files.catbox.moe/mnbake.jpg',
      '博金-博克商店':        'https://files.catbox.moe/zvyhcj.jpg',
      '陋居':       { '白天': 'https://files.catbox.moe/tbwb3j.jpg', '黑夜': 'https://files.catbox.moe/c1ztp6.jpg' },
      '陋居厨房':        'https://files.catbox.moe/lhr23n.jpg',
      '陋居客厅':        'https://files.catbox.moe/vl594y.jpg',
      '陋居房间':        'https://files.catbox.moe/kmmr5k.jpg',
      '罗恩的房间':        'https://files.catbox.moe/y8lirm.jpg',
      '格里莫广场12号':        'https://files.catbox.moe/7zzq8k.jpg',
      '格里莫广场12号门厅':        'https://files.catbox.moe/57isum.jpg',
      '格里莫广场12号餐厅':        'https://files.catbox.moe/eqz3d1.jpg',
      '格里莫广场卧室':        'https://files.catbox.moe/xm6piy.jpg',
      '格里莫广场客厅':        'https://files.catbox.moe/20upyp.jpg',
      '圣芒戈医院':        'https://files.catbox.moe/wfwylo.jpg',
      '圣芒戈医院走廊':        'https://files.catbox.moe/mcaobk.jpg',
      '圣芒戈医院病房':        'https://files.catbox.moe/t84hg0.jpg',
      '戈德里克山谷街道':       { '白天': 'https://files.catbox.moe/twg37p.jpg', '黑夜': 'https://files.catbox.moe/xm60x4.jpg' },
      '巴沙特的家':        'https://files.catbox.moe/zm4l6u.jpg',
      '教堂墓地':        'https://files.catbox.moe/a0q394.jpg',
      '通用山岭':       { '白天': 'https://files.catbox.moe/xf1ni5.jpg', '黑夜': 'https://files.catbox.moe/a9nm0i.jpg' },
      '洛夫古德家外部':        'https://files.catbox.moe/h79m3h.jpg',
      '洛夫古德家内部':        'https://files.catbox.moe/cy5s3z.jpg',
      '魔法部电话亭':        'https://files.catbox.moe/c8tl15.jpg',
      '魔法部正厅':        'https://files.catbox.moe/7cjcab.jpg',
      '魔法部审判室':        'https://files.catbox.moe/qhyi0f.jpg',
      '魔法部电梯':        'https://files.catbox.moe/0zwegp.jpg',
      '魔法部走廊1':        'https://files.catbox.moe/r578zv.jpg',
      '魔法部走廊2':        'https://files.catbox.moe/8t13ef.jpg',
      '魔法部乌姆里奇办公室':        'https://files.catbox.moe/m6efb1.jpg',
      '地下公共厕所':        'https://files.catbox.moe/lre0n6.jpg',
      '魔法部通用办公室':        'https://files.catbox.moe/u0ekbp.jpg',
      '预言厅':        'https://files.catbox.moe/xgzg22.jpg',
      '死亡厅':        'https://files.catbox.moe/86oq1a.jpg',
      '马尔福庄园':       { '白天': 'https://files.catbox.moe/ucoy2y.jpg', '黑夜': 'https://files.catbox.moe/q3uno6.jpg' },
      '冬天马尔福庄园':        'https://files.catbox.moe/tmugx3.jpg',
      '通用平房':        'https://files.catbox.moe/xgqnyj.jpg',
      '通用庄园':        'https://files.catbox.moe/1msc9c.jpg',
      '通用公寓':        'https://files.catbox.moe/gl5uzy.jpg',
      '花园':        'https://files.catbox.moe/oncf0a.jpg',
      '草坪':        'https://files.catbox.moe/twvhou.jpg',
      '庭院':        'https://files.catbox.moe/1z8h48.jpg',
      '湖畔':        'https://files.catbox.moe/c6z1gc.jpg',
      '冬季室外':        'https://files.catbox.moe/u91u27.jpg',
      '黑夜室外':        'https://files.catbox.moe/7thf4z.jpg',
      '欧式客厅':        'https://files.catbox.moe/mdprd5.jpg',
      '现代客厅':        'https://files.catbox.moe/7ry98c.jpg',
      '欧式通用厨房':        'https://files.catbox.moe/dx79ez.jpg',
      '现代通用厨房':        'https://files.catbox.moe/jebxco.jpg',
      '欧式卧室1':        'https://files.catbox.moe/0xvzpe.jpg',
      '欧式卧室2':        'https://files.catbox.moe/mhv75o.jpg',
      '现代卧室1':        'https://files.catbox.moe/341hr0.jpg',
      '现代卧室2':        'https://files.catbox.moe/ott216.jpg',
      '贫穷卧室':        'https://files.catbox.moe/v05hkw.jpg',
      '书房':        'https://files.catbox.moe/hgzyez.jpg',
      '浴室':        'https://files.catbox.moe/u03sk4.jpg',
      '餐厅':        'https://files.catbox.moe/jlp9ry.jpg',
      '阳台':        'https://files.catbox.moe/5vrx9r.jpg',
      '楼梯':        'https://files.catbox.moe/1j3qgw.jpg',
      '走廊':        'https://files.catbox.moe/8emgh9.jpg',
      // —— 霍格沃茨 ——
      '霍格沃茨特快列车':        'https://files.catbox.moe/cjfbcy.jpg',
      '9¾站台':        'https://files.catbox.moe/qofi4k.jpg',
      '行驶的霍格沃茨特快列车':        'https://files.catbox.moe/20hskr.jpg',
      '霍格沃茨列车零食手推车':        'https://files.catbox.moe/cv461d.jpg',
      '霍格沃茨列车包厢1':        'https://files.catbox.moe/vqqiox.jpg',
      '霍格沃茨列车包厢2':        'https://files.catbox.moe/xd8hg7.jpg',
      '霍格沃茨列车走廊':        'https://files.catbox.moe/p4u3h5.png',
      '格兰芬多休息室':        'https://files.catbox.moe/nkgmiv.jpg',
      '格兰芬多寝室':        'https://files.catbox.moe/tzke02.jpg',
      '斯莱特林休息室':        'https://files.catbox.moe/3r4nyr.jpg',
      '通用办公室1':        'https://files.catbox.moe/cwz5f4.jpg',
      '魔咒课教室':        'https://files.catbox.moe/1swssz.jpg',
      '奖品陈列室':        'https://files.catbox.moe/dq6fso.jpg',
      '黑魔法防御术课教室':        'https://files.catbox.moe/ye6iiq.jpg',
      '魔药课教室':        'https://files.catbox.moe/tq8b6r.jpg',
      '霍格沃茨草坪':       { '白天': 'https://files.catbox.moe/tzo7r4.jpg', '黑夜': 'https://files.catbox.moe/t4tjr7.jpg' },
      '魁地奇球场':       { '白天': 'https://files.catbox.moe/7eezna.jpg', '黑夜': 'https://files.catbox.moe/ijpuwt.jpg' },
      '扫帚棚':        'https://files.catbox.moe/f0uvyz.jpg',
      '猫头鹰棚屋':        'https://files.catbox.moe/kv6btw.jpg',
      '霍格沃茨楼梯1':        'https://files.catbox.moe/091w6j.jpg',
      '霍格沃茨楼梯2':        'https://files.catbox.moe/l18hov.jpg',
      '黑夜霍格沃茨楼梯':        'https://files.catbox.moe/2q1uo5.jpg',
      '霍格沃茨窗边':       { '白天': 'https://files.catbox.moe/e6axrg.jpg', '黑夜': 'https://files.catbox.moe/g4jg7d.jpg' },
      '医疗翼':       { '黑夜': 'https://files.catbox.moe/ao1p44.jpg', '白天': 'https://files.catbox.moe/xdstpe.jpg' },
      '大厅长桌':        'https://files.catbox.moe/csikhj.jpg',
      '礼堂（宴会）':        'https://files.catbox.moe/zgy95p.jpg',
      '礼堂（平时）':        'https://files.catbox.moe/ogcgye.jpg',
      '图书馆':       { '白天': 'https://files.catbox.moe/i0ba9z.jpg', '黑夜': 'https://files.catbox.moe/06utxh.jpg' },
      '温室':       { '白天': 'https://files.catbox.moe/2d4gbn.jpg', '黑夜': 'https://files.catbox.moe/jq9lac.jpg' },
      '学院计分沙漏':        'https://files.catbox.moe/r4pnu0.jpg',
      '炉火':        'https://files.catbox.moe/ztkczj.jpg',
      '天文塔':       { '黑夜': 'https://files.catbox.moe/pc2f23.jpg', '白天': 'https://files.catbox.moe/ohom3g.jpg' },
      '斯内普储藏室':        'https://files.catbox.moe/qjgmy9.jpg',
      '斯莱特林寝室':        'https://files.catbox.moe/ohywl5.jpg',
      '胖夫人画像':        'https://files.catbox.moe/bxwbig.jpg',
      '魔法史教室':        'https://files.catbox.moe/tnd0r0.jpg',
      '冥想盆':        'https://files.catbox.moe/mbog4h.jpg',
      '礼堂大门':        'https://files.catbox.moe/bb946x.jpg',
      '拉文克劳寝室':        'https://files.catbox.moe/h1ualv.jpg',
      '禁林':       { '白天': 'https://files.catbox.moe/80lte4.jpg', '黑夜': 'https://files.catbox.moe/tdnvnp.jpg' },
      '通用办公室2':        'https://files.catbox.moe/uqerb5.jpg',
      '通用教室':       { '白天': 'https://files.catbox.moe/wmfsbm.jpg', '黑夜': 'https://files.catbox.moe/uhhtrd.jpg' },
      '级长浴室':        'https://files.catbox.moe/m6rq4c.jpg',
      '走廊':       { '白天': 'https://files.catbox.moe/3gino9.jpg', '黑夜': 'https://files.catbox.moe/8urr1k.jpg' },
      '通用走廊':        'https://files.catbox.moe/ugtkiu.jpg',
      '霍格沃茨庭院':       { '白天': 'https://files.catbox.moe/t6qgcy.jpg', '黑夜': 'https://files.catbox.moe/j6jg2j.jpg' },
      '冬天霍格沃茨庭院':        'https://files.catbox.moe/gfosjh.jpg',
      '扫帚间':        'https://files.catbox.moe/i3si4j.jpg',
      '黑湖':       { '白天': 'https://files.catbox.moe/tkar0g.jpg', '黑夜': 'https://files.catbox.moe/t6l1nf.jpg' },
      '霍格沃茨厨房':        'https://files.catbox.moe/b1phm0.jpg',
      '海格小屋':       { '白天': 'https://files.catbox.moe/9bcd7d.jpg', '黑夜': 'https://files.catbox.moe/qig4hj.jpg' },
      '海格小屋内部':        'https://files.catbox.moe/7kftjh.jpg',
      '赫奇帕奇休息室':        'https://files.catbox.moe/0up8h0.jpg',
      '赫奇帕奇宿舍':        'https://files.catbox.moe/2crmb4.jpg',
      '校长办公室':        'https://files.catbox.moe/td9gpt.jpg',
      '冬天打人柳':        'https://files.catbox.moe/l44a88.jpg',
      '打人柳':       { '白天': 'https://files.catbox.moe/mnba3b.jpg', '黑夜': 'https://files.catbox.moe/mvemmm.jpg' },
      '变形课教室':        'https://files.catbox.moe/8dtw9w.jpg',
      '拉文克劳休息室':        'https://files.catbox.moe/aym707.jpg',
      '盥洗室1':        'https://files.catbox.moe/xiarb2.jpg',
      '盥洗室2':        'https://files.catbox.moe/gs58v0.jpg',
      '霍格莫德车站':       { '白天': 'https://files.catbox.moe/1pbukv.jpg', '黑夜': 'https://files.catbox.moe/dyr23a.jpg' },
      '魔法石房间':        'https://files.catbox.moe/uqogof.jpg',
      '棋盘房间':        'https://files.catbox.moe/xlkcrj.jpg',
      '小鸟钥匙':        'https://files.catbox.moe/tu1cju.jpg',
      '魔鬼网':        'https://files.catbox.moe/1fa254.jpg',
      '四楼房间（三头犬）':        'https://files.catbox.moe/7t92ug.jpg',
      '霍格沃茨道路（有人）':        'https://files.catbox.moe/95ypcr.jpg',
      '黑夜废弃教室（厄里斯魔镜）':        'https://files.catbox.moe/pbt5un.jpg',
      '球场看台（斯莱特林）':        'https://files.catbox.moe/6kt6uc.jpg',
      '球场看台（格兰芬多）':        'https://files.catbox.moe/kxgfyr.jpg',
      '白天霍格沃茨大路':        'https://files.catbox.moe/gyqoch.jpg',
      '校长办公室入口':        'https://files.catbox.moe/f4c3h6.jpg',
      '大厅分院帽':        'https://files.catbox.moe/th18ac.jpg',
      '大厅教师长桌':        'https://files.catbox.moe/3yonsl.jpg',
      '霍格沃茨门厅':        'https://files.catbox.moe/ys4yaz.jpg',
      '船屋':        'https://files.catbox.moe/pcymrt.jpg',
      '密室管道':        'https://files.catbox.moe/8m5ny0.jpg',
      '密室':        'https://files.catbox.moe/wm83eb.jpg',
    };

    // 用法：背景URL('白天卧室') / 背景URL('卧室白天') / 背景URL('花店黑夜') / 背景URL('电影院') / 背景URL('gpn9m2')
    function 背景URL(token, 默认时段 = '白天') {
      if (!token || token === '暂无' || token === '-') return null;
      if (是URL(token)) return token;

      // 先尝试精确键，避免把“白天户外”误拆
      const exact = 背景表[token];
      if (exact) {
        if (Array.isArray(exact)) {
          const cached = BG_SESSION_CACHE[token];
          if (cached) return 解析映射值(cached);
          const pick = stablePick(exact, `bg|${token}|sess:${BG_SESSION_SALT}`);
          BG_SESSION_CACHE[token] = pick;
          return 解析映射值(pick);
        }
        if (typeof exact === 'string') return 解析映射值(exact);
        const code = exact[默认时段] || exact['白天'] || exact['黑夜'];
        const url = 解析映射值(code);
        return url || null;
      }

      let 键 = String(token).trim();
      let 时段 = 默认时段;
      let base = '';

      // 前缀：白天卧室 / 夜晚花店 / 晚上花店
      let m = 键.match(/^(白天|黑夜|夜晚|晚上)(.+)$/);
      if (m) {
        时段 = 归一时段(m[1]);
        base = m[2].trim();
      } else {
        // 后缀：卧室白天 / 花店黑夜 / 花店夜晚
        m = 键.match(/^(.+?)(白天|黑夜|夜晚|晚上)$/);
        if (m) {
          base = m[1].trim();
          时段 = 归一时段(m[2]);
        }
      }

      if (base) {
        const rec = 背景表[base];
        if (rec) {
          if (typeof rec === 'string') return 解析映射值(rec);
          const code = rec[时段] || rec['白天'] || rec['黑夜'];
          const url = 解析映射值(code);
          return url || null;
        }
        // 尝试“组合键”
        const combined = 背景表[`${时段}${base}`];
        if (combined) {
          if (typeof combined === 'string') return 解析映射值(combined);
          const code = combined[时段] || combined['白天'] || combined['黑夜'];
          const url = 解析映射值(code);
          return url || null;
        }
      } else {
        // 没写时段就按基础键解析
        const rec = 背景表[键];
        if (rec) {
          if (typeof rec === 'string') return 解析映射值(rec);
          const code = rec[默认时段] || rec['白天'] || rec['黑夜'];
          const url = 解析映射值(code);
          return url || null;
        }
      }

      // 短码兜底
      if (是短码(token)) return catbox(token);
      return null;
    }

    // 针对“背景”字段的专用解析，支持中文键与短码；保持与 normalizeAsset 的返回语义一致
    function normalizeBackgroundAsset(value) {
      if (value === undefined) return undefined;
      const trimmed = String(value).trim();
      if (!trimmed) return undefined;
      const lower = trimmed.toLowerCase();
      if (lower === 'null' || lower === 'none') return null;
      if (是URL(trimmed)) return trimmed;
      const resolved = 背景URL(trimmed);
      if (resolved) return resolved;
      // 继续保留旧的短码拼接逻辑（与 normalizeAsset 对齐）
      const filename = /\.[a-z0-9]+$/i.test(trimmed) ? trimmed : `${trimmed}.png`;
      return CATBOX_BASE + filename;
    }

    // —— 立绘表（支持单链接或多链接；多链接按“会话盐 + 表情键”稳定随机） ——
    // 每次刷新生成一次性的会话随机盐，使刷新后可能选到另一张；
    // 在同一次渲染内，同一个表情键始终使用同一张（会话缓存）。
    const SPRITE_SESSION_SALT = (Math.random().toString(36).slice(2)) + '-' + Date.now().toString(36);
    const SPRITE_SESSION_CACHE = Object.create(null); // key: 表情键 → 已选中的 URL 或短码
    const 立绘表 = {
      // —— 一年级立绘 ——
      '哈利Muggle clothes': 'https://files.catbox.moe/3yzrdb.png',
      '哈利Quidditch robes': 'https://files.catbox.moe/btd724.png',
      '哈利House robes': 'https://files.catbox.moe/5k8pqp.png',
      '德拉科Muggle clothes': 'https://files.catbox.moe/3e0ikd.png',
      '德拉科House robes': 'https://files.catbox.moe/m6o5wq.png',
      '德拉科formal wear': 'https://files.catbox.moe/9of7mj.png',
      '赫敏Muggle clothes': 'https://files.catbox.moe/x911cn.png',
      '赫敏House robes': 'https://files.catbox.moe/jrfung.png',
      '罗恩Muggle clothes': 'https://files.catbox.moe/jldal0.png',
      '罗恩House robes': 'https://files.catbox.moe/7sfvrn.png',
      '达力': 'https://files.catbox.moe/zed29a.png',
      '珀西': 'https://files.catbox.moe/rkkm4h.png',
      '弗雷德House robes': 'https://files.catbox.moe/h4wuhp.png',
      '弗雷德Muggle clothes': 'https://files.catbox.moe/bljhga.png',
      '乔治House robes': 'https://files.catbox.moe/8w60h8.png',
      '乔治Muggle clothes': 'https://files.catbox.moe/9ynt7k.png',
      '纳威': 'https://files.catbox.moe/qhq9jw.png',
      '高尔': 'https://files.catbox.moe/ybsb9s.png',
      '克拉布': 'https://files.catbox.moe/kmro3h.png',
      '西莫': 'https://files.catbox.moe/f768lz.png',
      '潘西·帕金森': 'https://files.catbox.moe/dc9qrl.png',
      '伍德Muggle clothes': 'https://files.catbox.moe/wsiixh.png',
      '伍德Quidditch robes': 'https://files.catbox.moe/3m5ygd.png',
      '伍德House robes': 'https://files.catbox.moe/m02k7t.png',
      '马库斯': 'https://files.catbox.moe/6znbq1.png',
      '拉文德·布朗': 'https://files.catbox.moe/vjgojq.png',
      '迪安': 'https://files.catbox.moe/xkbt5y.png',
      '金妮Muggle clothes': 'https://files.catbox.moe/4qenm2.png',
      '金妮House robes': 'https://files.catbox.moe/psg9fj.png',
      '凯蒂': 'https://files.catbox.moe/l0ra8q.png',
      '苏珊': 'https://files.catbox.moe/y06wk4.png',
      // —— 其他角色 ——
      '邓布利多': 'https://files.catbox.moe/96zqbq.png',
      '海格': 'https://files.catbox.moe/6ugh3i.png',
      '麦格': 'https://files.catbox.moe/h74mwp.png',
      '德思礼': 'https://files.catbox.moe/ay0tko.png',
      '佩妮': 'https://files.catbox.moe/wsku5g.png',
      '奇洛': 'https://files.catbox.moe/ct5x08.png',
      '奥利凡德': 'https://files.catbox.moe/4w5uew.png',
      '分院帽': 'https://files.catbox.moe/7kg9rm.png',
      '差点没头的尼克': 'https://files.catbox.moe/ioknmn.png',
      '斯内普': 'https://files.catbox.moe/1yoe61.png',
      '费尔奇': 'https://files.catbox.moe/108c21.png',
      '皮皮鬼': 'https://files.catbox.moe/lcfob6.png',
      '牙牙': 'https://files.catbox.moe/nvj34k.png',
      '奇洛脑后的伏地魔': 'https://files.catbox.moe/f55ktr.png',
      '霍琦女士': 'https://files.catbox.moe/f7houa.png',
      '弗立维教授': 'https://files.catbox.moe/h5bdvn.png',
      '庞弗雷女士': 'https://files.catbox.moe/rh92e8.png',
      '平斯夫人': 'https://files.catbox.moe/54hc3v.png',
      '宾斯教授': 'https://files.catbox.moe/tqsx3m.png',
      '血人巴罗': 'https://files.catbox.moe/8ume1d.png',
      '韦斯莱夫人': 'https://files.catbox.moe/3xfr9r.png',
      '拉环': 'https://files.catbox.moe/j3pd24.png',
      '斯普劳特': 'https://files.catbox.moe/tt3pj7.png',
      '比尔': 'https://files.catbox.moe/zx5id8.png',
      '福吉': 'https://files.catbox.moe/5z4v87.png',
      // —— NPC立绘 ——
      'NPC男学生': 'https://files.catbox.moe/th3cwe.png',
      'NPC女学生': 'https://files.catbox.moe/hk10nu.png',
      'NPC小女孩': 'https://files.catbox.moe/o4k9if.png',
      'NPC小男孩': 'https://files.catbox.moe/urhe4r.png',
      'NPC女': 'https://files.catbox.moe/1fbnzr.png',
      'NPC男': 'https://files.catbox.moe/9jjmfq.png',
      '妖精': 'https://files.catbox.moe/sg8ehb.png',
      'NPC幽灵': 'https://files.catbox.moe/w8ktuq.png',
      '猫': 'https://files.catbox.moe/rvx2fe.png',
      '马人': 'https://files.catbox.moe/47xpbx.png',
    };

    // FNV-1a 哈希 + 稳定选择（同一场景索引得到同一个变体）
    function fnv1a(str) {
      let h = 0x811c9dc5 >>> 0;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return h >>> 0;
    }
    function stablePick(list, seed) {
      if (!Array.isArray(list) || list.length === 0) return null;
      const idx = fnv1a(String(seed || '')) % list.length;
      return list[idx];
    }

    // 将“立绘资源键/URL/短码”解析为最终 URL；
    // 当键在 立绘表 中是数组时，按 (键 + 会话盐) 稳定随机挑选，并在会话内缓存，保证同一键全局一致。
    function 立绘URL(token, sceneIndex) {
      if (!token || token === '暂无' || token === '-') return null;
      const t = String(token).trim();
      if (!t) return null;
      if (是URL(t)) return t;
      const rec = 立绘表[t];
      if (rec) {
        if (Array.isArray(rec)) {
          // 会话缓存：同一轮内同一表情键固定同一张
          const cached = SPRITE_SESSION_CACHE[t];
          if (cached) return 解析映射值(cached);
          const pick = stablePick(rec, `sprite|${t}|sess:${SPRITE_SESSION_SALT}`);
          SPRITE_SESSION_CACHE[t] = pick;
          return 解析映射值(pick);
        }
        // 单链接也可以直接返回（无需缓存）
        return 解析映射值(rec);
      }
      // 未命中字典：保持与旧逻辑一致（支持短码/文件名）
      if (是短码(t)) return catbox(t);
      if (/\.[a-z0-9]+$/i.test(t)) return t;
      return CATBOX_BASE + `${t}.png`;
    }

    // —— CG 表（支持单链接或多链接；多链接按“会话盐 + 键”稳定随机） ——
    // 与立绘一致，保证同一会话中同一键固定挑选到同一张；刷新后可能变化。
    const CG_SESSION_SALT = (Math.random().toString(36).slice(2)) + '-' + Date.now().toString(36);
    const CG_SESSION_CACHE = Object.create(null);
    const CG表 = {
      // 一年级
      '婴儿哈利在夜晚女贞路': ['https://files.catbox.moe/ppq63z.jpg'],
      '哈利被关储物间': ['https://files.catbox.moe/eivcs4.jpg'],
      '信涌进女贞路四号客厅': ['https://files.catbox.moe/tmjaqt.jpg'],
      '爬虫馆巨蟒': ['https://files.catbox.moe/v0omty.jpg'],
      '给哈利的蛋糕': ['https://files.catbox.moe/46r2qu.jpg'],
      '达力的猪尾巴': ['https://files.catbox.moe/dm1hgt.jpg'],
      '奥利凡德挑选魔杖': ['https://files.catbox.moe/22fond.jpg'],
      '哈利在对角巷': ['https://files.catbox.moe/v06p0v.jpg'],
      '哈利在破釜酒吧和别人握手': ['https://files.catbox.moe/urxwen.jpg'],
      '古灵阁713地下金库': ['https://files.catbox.moe/poctzf.jpg'],
      '哈利在车站': ['https://files.catbox.moe/ytesj4.jpg'],
      '哈利在9¾站台': ['https://files.catbox.moe/7inc4w.jpg'],
      '哈利在列车包厢露出伤疤': ['https://files.catbox.moe/4y5685.jpg'],
      '赫敏在列车包厢门口': ['https://files.catbox.moe/4y5685.jpg'],
      '德拉科戴分院帽': ['https://files.catbox.moe/5oxznw.jpg'],
      '哈利戴分院帽': ['https://files.catbox.moe/1ll8kq.jpg'],
      '马尔福在礼堂宴会': ['https://files.catbox.moe/qbgecv.jpg'],
      '晚上哈利望向寝室窗外': ['https://files.catbox.moe/bj06f9.jpg'],
      '记忆球': ['https://files.catbox.moe/dnhseh.jpg'],
      '赫敏在室内': ['https://files.catbox.moe/j6x8vr.jpg'],
      '马尔福在教室': ['https://files.catbox.moe/tmk897.jpg'],
      '斯内普低头写字': ['https://files.catbox.moe/dfykj3.jpg'],
      '纳威扫帚失控': ['https://files.catbox.moe/gtipzq.jpg'],
      '马尔福空中扔记忆球': ['https://files.catbox.moe/m1cy3b.jpg'],
      '伍德在室内': ['https://files.catbox.moe/9tv2ki.jpg'],
      '醒着的路威': ['https://files.catbox.moe/lpebl6.jpg'],
      '哈利在室外': ['https://files.catbox.moe/8edkyj.jpg'],
      '伍德在草坪': ['https://files.catbox.moe/8wkzp4.jpg'],
      '奇洛闯进礼堂': ['https://files.catbox.moe/zbs4gj.jpg'],
      '室内巨怪': ['https://files.catbox.moe/zln9lw.jpg'],
      '室内巨怪昏迷': ['https://files.catbox.moe/17qnyl.jpg'],
      '哈利在礼堂': ['https://files.catbox.moe/4neq2a.jpg'],
      '袍子着火': ['https://files.catbox.moe/1srg4o.jpg'],
      '哈利扫帚失控': ['https://files.catbox.moe/dl76kh.jpg'],
      '哈利吐出金色飞贼': ['https://files.catbox.moe/xuwcib.jpg'],
      '哈利和罗恩下巫师棋': ['https://files.catbox.moe/9l5mt8.jpg'],
      '德拉科球场看台失落捂脸': ['https://files.catbox.moe/ax6qj1.jpg'],
      '哈利寝室穿隐身衣': ['https://files.catbox.moe/xs9xml.jpg'],
      '厄里斯魔镜里的哈利一家人': ['https://files.catbox.moe/e8t5zy.jpg'],
      '哈利冬天室外': ['https://files.catbox.moe/j5apcr.jpg'],
      '德拉科偷看海格小屋': ['https://files.catbox.moe/k1szu4.jpg'],
      '德拉科害怕': ['https://files.catbox.moe/06200o.jpg'],
      '兜帽人喝独角兽的血': ['https://files.catbox.moe/9hrx6e.jpg'],
      '哈利晚上侧身坐着': ['https://files.catbox.moe/f1u9zl.jpg'],
      '罗恩受伤倒地': ['https://files.catbox.moe/wrm55z.jpg'],
      '奇洛在地下房间': ['https://files.catbox.moe/nm3fhz.jpg'],
      '哈利在医疗翼': ['https://files.catbox.moe/ygc9h6.jpg'],
      '马尔福大厅宴会失落': ['https://files.catbox.moe/bbe066.jpg'],
      '贴满哈利父母照片的书': ['https://files.catbox.moe/5uowad.jpg'],
      '火龙诺伯': ['https://files.catbox.moe/5uowad.jpg'],
    };

    // 将带“/”或“／”的键拆成多个同义键，便于用任一别名触发同一组CG
    (function 扩展CG别名() {
      const keys = Object.keys(CG表);
      for (const key of keys) {
        if (key.includes('/') || key.includes('／')) {
          const parts = key.split(/[\/／]/).map(s => s.trim()).filter(Boolean);
          for (const p of parts) {
            if (!(p in CG表)) {
              CG表[p] = CG表[key];
            }
          }
        }
        // 以“许魏洲”开头的键，派生出“{{char}}...”占位别名，便于任意角色名触发
        if (key.startsWith('许魏洲')) {
          const placeholderKey = `{{char}}${key.slice('许魏洲'.length)}`;
          if (!(placeholderKey in CG表)) {
            CG表[placeholderKey] = CG表[key];
          }
        }
      }
    })();

    function CGURL(token, sceneIndex, speaker) {
      if (!token || token === '暂无' || token === '-') return null;
      const t = String(token).trim();
      if (!t) return null;
      if (是URL(t)) return t;
      const candidates = [];
      candidates.push(t);
      if (speaker && typeof speaker === 'string' && speaker.trim()) {
        const sp = speaker.trim();
        if (t.includes('{{char}}')) candidates.push(t.replace(/\{\{char\}\}/g, sp));
        if (t.startsWith(sp)) candidates.push(`{{char}}${t.slice(sp.length)}`);
      }
      const tried = new Set();
      for (const key of candidates) {
        if (!key || tried.has(key)) continue;
        tried.add(key);
        const rec = CG表[key];
        if (!rec) continue;
        if (Array.isArray(rec)) {
          const cached = CG_SESSION_CACHE[key];
          if (cached) return 解析映射值(cached);
          const pick = stablePick(rec, `cg|${key}|sess:${CG_SESSION_SALT}`);
          CG_SESSION_CACHE[key] = pick;
          return 解析映射值(pick);
        }
        return 解析映射值(rec);
      }
      // 占位通配匹配：当 t 已被外部替换为任意人名/用户名时，尝试与包含占位的键做模式匹配
      // 例如 key = "{{char}}穿西装打{{user}}屁股" 可以匹配 "某某穿西装打小明屁股"
      const esc = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      for (const key of Object.keys(CG表)) {
        if (!(key.includes('{{char}}') || key.includes('{{user}}'))) continue;
        // 先把占位替换成占位符，转义其余字符，再还原为通配片段
        let src = key.replace(/\{\{char\}\}/g, '___CHAR___').replace(/\{\{user\}\}/g, '___USER___');
        src = esc(src).replace(/___CHAR___/g, '.+?').replace(/___USER___/g, '.+?');
        const re = new RegExp('^' + src + '$');
        if (re.test(t)) {
          const rec = CG表[key];
          if (Array.isArray(rec)) {
            const cached = CG_SESSION_CACHE[key];
            if (cached) return 解析映射值(cached);
            const pick = stablePick(rec, `cg|${key}|sess:${CG_SESSION_SALT}`);
            CG_SESSION_CACHE[key] = pick;
            return 解析映射值(pick);
          }
          return 解析映射值(rec);
        }
      }
      if (是短码(t)) return catbox(t);
      if (/\.[a-z0-9]+$/i.test(t)) return t;
      return CATBOX_BASE + `${t}.png`;
    }

    const { scenes, options } = parseVNScript(scriptText);

    const refs = {};
    const PLAYER_AVATAR_STORAGE_KEY = 'vn.smsPlayerAvatarUrl';
    const PLAYER_NAME_STORAGE_KEY = 'vn.smsPlayerName';
    const SMS_VIDEO_TARGET_KEY = 'vn.smsVideoTarget';
    const VIDEO_USER_IMAGES_KEY = 'vn.videoUserImages';
    const VIDEO_USER_INTERVAL_KEY = 'vn.videoUserInterval';
    const SMS_LONG_PRESS_THRESHOLD = 600;
    const SMS_ACTION_TEMPLATES = {
      voice: '[语音消息]',
      red: '[红包]',
      transfer: '[转账]',
      video: '[视频请求]',
      image: '[图片]'
    };
    const EFFECT_DEFINITIONS = {
      '震动': { target: 'container', className: 'is-shaking' },
      '冲击': { target: 'container', className: 'is-impact' },
      '摇晃': { target: 'container', className: 'is-jolting' },
      '剧烈摇晃': { target: 'container', className: 'is-violent-shaking' },
      '跑步': { target: 'container', className: 'is-running' },
      '眩晕': { target: 'container', className: 'is-dizzy' },
      '加速': { target: 'effectLayer', className: 'is-speeding' },
      '苏醒': { target: 'effectLayer', className: 'is-fadein' },
      '昏迷': { target: 'effectLayer', className: 'is-fadeout' },
      '闪烁': { target: 'effectLayer', className: 'is-whiteflash' },
      '恐惧': { target: 'container', className: 'is-fear' },
      '恍惚': { target: 'container', className: 'is-psychedelic' },
      '模糊': { target: 'effectLayer', className: 'is-blurring' },
      '回忆': { target: 'effectLayer', className: 'is-flashback' },
      '爱恋': { target: 'effectLayer', className: 'is-dokidoki' },
      '梦境': { target: 'effectLayer', className: 'is-dreamy' },
      '聚光': { target: 'effectLayer', className: 'is-spotlight' },
      '冷色': { target: 'effectLayer', className: 'is-cooltone' },
      '暖色': { target: 'effectLayer', className: 'is-warmtone' },
      
      '近看': { target: 'container', className: 'is-zoom-in' },
      '远看': { target: 'container', className: 'is-zoom-out' },
      '左看': { target: 'container', className: 'is-panning-left' },
      '右看': { target: 'container', className: 'is-panning-right' },
      '上移': { target: 'container', className: 'is-panning-up' },
      '下移': { target: 'container', className: 'is-panning-down' },
      '倾斜': { target: 'container', className: 'is-tilted' },
      '慢推': { target: 'container', className: 'is-dolly-in' },
      '慢拉': { target: 'container', className: 'is-dolly-out' },
      '推拉镜': { target: 'container', className: 'is-vertigo' },
      '小雨': { target: 'effectLayer', className: 'is-raining' },
      '暴雨': { target: 'effectLayer', className: 'is-downpour' },
      '雷电': { target: 'effectLayer', className: 'is-lightning' },
      '流血': { target: 'effectLayer', className: 'is-bloody' },
      '血': { target: 'effectLayer', className: 'is-bloody' },
      '血腥': { target: 'effectLayer', className: 'is-bloody' },
      
      '下雪': { target: 'effectLayer', className: 'is-snowing' },
      '小雪': { target: 'effectLayer', className: 'is-snowing' },
      '大雪': { target: 'effectLayer', className: 'is-blizzard' },
      '暴雪': { target: 'effectLayer', className: 'is-blizzard' },
      '薄雾': { target: 'effectLayer', className: 'is-haze' },
      '浓雾': { target: 'effectLayer', className: 'is-foggy' },
      '风沙': { target: 'effectLayer', className: 'is-sandstorm' }
    };

    function sanitizeAvatarUrl(value) {
      if (typeof value !== 'string') return '';
      const trimmed = value.trim();
      if (!trimmed) return '';
      if (/^https?:\/\//i.test(trimmed)) return trimmed;
      if (/^data:image\//i.test(trimmed)) return trimmed;
      if (/^\.{0,2}\//.test(trimmed)) return trimmed;
      if (trimmed.startsWith('/')) return trimmed;
      return '';
    }

    function sanitizeNickname(value) {
      if (typeof value !== 'string') return '{{user}}';
      const trimmed = value.trim();
      if (!trimmed) return '{{user}}';
      // limit to a sensible length
      return trimmed.slice(0, 24);
    }

    // —— 联系人覆盖（仅用于短信界面） ——
    const CONTACT_OVERRIDES_STORAGE_KEY = 'vn.smsContactOverrides';
    function normalizeContactKey(name) {
      return (typeof name === 'string' ? name : '').trim();
    }
    function loadContactOverrides() {
      const raw = loadJSON(CONTACT_OVERRIDES_STORAGE_KEY, []);
      if (!Array.isArray(raw)) return [];
      return raw
        .map(item => ({
          original: normalizeContactKey(item?.original || item?.key || ''),
          nickname: (item?.nickname || '').toString().trim(),
          avatar: sanitizeAvatarUrl(item?.avatar || item?.avatarUrl || ''),
          enabled: item?.enabled !== false
        }))
        .filter(item => !!item.original);
    }
    function saveContactOverrides(list) {
      try {
        const payload = Array.isArray(list) ? list : [];
        localStorage.setItem(CONTACT_OVERRIDES_STORAGE_KEY, JSON.stringify(payload));
      } catch {}
    }
    function findContactOverride(name) {
      const key = normalizeContactKey(name);
      if (!key) return null;
      const list = loadContactOverrides();
      for (const item of list) {
        if (!item.enabled) continue;
        if (normalizeContactKey(item.original) === key) {
          return item;
        }
      }
      return null;
    }
    function resolveContactDisplay(name, spriteUrl) {
      const override = findContactOverride(name);
      if (!override) return { displayName: name, avatarUrl: spriteUrl };
      const displayName = (override.nickname || '').trim() || name;
      const avatarUrl = override.avatar || spriteUrl || '';
      return { displayName, avatarUrl };
    }

    const storedAutoMode = localStorage.getItem('vn.autoEnabled');
    const prefersExpanded = typeof window !== 'undefined' && typeof window.matchMedia === 'function'
      ? window.matchMedia('(min-width: 821px)').matches
      : false;
    const state = {
      index: 0,
      typing: false,
      auto: storedAutoMode === 'true',
      autoTimer: null,
      firstInteraction: false,
      unlockedCG: new Set(loadJSON('vn.cgUnlocked', [])),
      history: [],
      typeDelay: 60,
      lastBackground: undefined,
      lastSprite: undefined,
      controlBarExpanded: prefersExpanded,
      desktopMode: localStorage.getItem('vn.aspectMode') === 'desktop',
      playerAvatarUrl: sanitizeAvatarUrl(localStorage.getItem(PLAYER_AVATAR_STORAGE_KEY) || ''),
      playerName: sanitizeNickname(localStorage.getItem(PLAYER_NAME_STORAGE_KEY) || '{{user}}'),
      choices: Array.isArray(options) ? options : [],
      awaitingChoice: false,
      controlBarMediaQuery: typeof window !== 'undefined' && typeof window.matchMedia === 'function'
        ? window.matchMedia('(min-width: 821px)')
        : null,
      cgOverlayOpen: false,
      cgOverlayIndex: 0,
      manualSmsOpen: false,
      pendingSmsMessages: [],
      smsLongPressTimer: null,
      smsLongPressHandled: false,
      smsActionMenuOpen: false,
      voiceComposer: {
        open: false,
        step: 'content',
        content: '',
        durationInput: '',
        durationSeconds: 0
      },
      imageComposer: {
        open: false,
        description: ''
      },
      redComposer: {
        open: false,
        step: 'label',
        label: '',
        amountInput: ''
      },
      transferComposer: {
        open: false,
        step: 'target',
        target: '',
        amountInput: '',
        note: ''
      },
      videoUserComposer: { open: false },
      videoConfirmOpen: false,
      userPreview: {
        visible: false,
        images: [],
        index: 0,
        timer: null,
        intervalMs: 3000,
        currentUrl: '',
        cache: {}
      }
    };
    const DEFAULT_SETTINGS = {
      typeSpeedValue: 40,
      fontSize: 17,
      dialogueTextColor: '#222222',
      dialogueBgColor: 'rgba(255,255,255,0.85)',
      panelTextColor: '#f3f3f3',
      panelBgColor: 'rgba(26,26,26,0.78)',
      controlIconColor: '#f2f2f2',
      controlIconBgColor: 'rgba(18,18,20,0.76)',
      controlButtonSize: 44,
      dialogueBlur: 6,
      panelBlur: 14,
      autoPauseSeconds: 1.6
    };
    const legacyDialogueBgAlpha = readLegacyOpacity('vn.dialogueBgOpacity');
    const legacyPanelBgAlpha = readLegacyOpacity('vn.panelBgOpacity');
    const legacyControlIconBgAlpha = readLegacyOpacity('vn.controlIconBgOpacity');
    const settings = {
      typeSpeedValue: getStoredNumber('vn.typeSpeedValue', DEFAULT_SETTINGS.typeSpeedValue),
      fontSize: getStoredNumber('vn.fontSize', DEFAULT_SETTINGS.fontSize),
      dialogueTextColor: normalizeHexColor(localStorage.getItem('vn.dialogueTextColor'), DEFAULT_SETTINGS.dialogueTextColor),
      dialogueBgColor: normalizeRgbaColor(localStorage.getItem('vn.dialogueBgColor'), DEFAULT_SETTINGS.dialogueBgColor, legacyDialogueBgAlpha),
      panelTextColor: normalizeHexColor(localStorage.getItem('vn.panelTextColor'), DEFAULT_SETTINGS.panelTextColor),
      panelBgColor: normalizeRgbaColor(localStorage.getItem('vn.panelBgColor'), DEFAULT_SETTINGS.panelBgColor, legacyPanelBgAlpha),
      controlIconColor: normalizeHexColor(localStorage.getItem('vn.controlIconColor'), DEFAULT_SETTINGS.controlIconColor),
      controlIconBgColor: normalizeRgbaColor(localStorage.getItem('vn.controlIconBgColor'), DEFAULT_SETTINGS.controlIconBgColor, legacyControlIconBgAlpha),
      controlButtonSize: getStoredNumber('vn.controlButtonSize', DEFAULT_SETTINGS.controlButtonSize),
      dialogueBlur: getStoredNumber('vn.dialogueBlur', DEFAULT_SETTINGS.dialogueBlur),
      panelBlur: getStoredNumber('vn.panelBlur', DEFAULT_SETTINGS.panelBlur),
      autoPauseSeconds: getStoredNumber('vn.autoPauseSeconds', DEFAULT_SETTINGS.autoPauseSeconds)
    };
    ['vn.dialogueBgOpacity', 'vn.panelBgOpacity', 'vn.controlIconBgOpacity'].forEach(key => localStorage.removeItem(key));

    const COLOR_INPUT_VALUE_DESCRIPTOR = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');

    const typewriter = {
      timer: null,
      text: '',
      index: 0,
      isRunning: false,
      speed: mapSliderToDelay(settings.typeSpeedValue),
      target: null,
      setTarget(el) {
        this.target = (el && el.nodeType === 1) ? el : null;
      },
      getTarget() {
        return this.target || refs.dialogueText;
      },
      start(text, onDone) {
        this.stop();
        const out = this.getTarget();
        if (out) out.textContent = '';
        this.text = text || '';
        this.index = 0;
        this.isRunning = true;
        const step = () => {
          if (!this.isRunning) return;
          const target = this.getTarget();
          if (target) target.textContent += this.text[this.index];
          this.index += 1;
          if (this.index < this.text.length) {
            this.timer = setTimeout(step, this.speed);
          } else {
            this.isRunning = false;
            onDone && onDone();
          }
        };
        if (!this.text) {
          this.isRunning = false;
          onDone && onDone();
          return;
        }
        step();
      },
      finish() {
        if (!this.isRunning) return;
        clearTimeout(this.timer);
        this.isRunning = false;
        const out = this.getTarget();
        if (out) out.textContent = this.text;
      },
      stop() {
        clearTimeout(this.timer);
        this.isRunning = false;
      },
      setSpeed(ms) {
        this.speed = ms;
        if (this.isRunning) {
          this.finish();
        }
      }
    };

    // —— 音乐库（中文名 → URL）。可在此处添加条目：'花店主题': 'https://...mp3' ——
    const 音乐库 = Object.freeze({
      // 项目内置音乐映射（中文名 → 直链 URL）
      '万圣节': 'https://files.catbox.moe/ygybmd.mp3',
      '平静暧昧': 'https://files.catbox.moe/0gujn8.mp3',
      '梦幻': 'https://files.catbox.moe/7msehf.mp3'
      // 可继续追加：'花店主题': 'https://...mp3'
    });

    // 解析 <VN> 中的 <music> 内容；返回去除首尾空白的字符串或 null
    function 提取VN音乐(text) {
      if (typeof text !== 'string' || !text) return null;
      const m = text.match(/<\s*VN[\s\S]*?<\s*music[^>]*>([\s\S]*?)<\s*\/music\s*>[\s\S]*?<\s*\/VN\s*>/i);
      return m ? (m[1] || '').trim() : null;
    }

    // 将中文名或 URL 解析为可播放的 URL
    function 解析音乐源(value) {
      if (!value) return null;
      const raw = String(value).trim();
      if (!raw) return null;
      // 直链
      if (/^[a-z]+:\/\//i.test(raw) || raw.startsWith('data:') || raw.startsWith('blob:')) {
        return raw;
      }
      // 中文名映射
      if (Object.prototype.hasOwnProperty.call(音乐库, raw)) {
        const url = 音乐库[raw];
        return typeof url === 'string' && url.trim() ? url.trim() : null;
      }
      return null;
    }

    // 全局背景音乐控制器（M2：静音时仍跟随最新曲目）
    const BGM = {
      audio: null,
      button: null,
      iconOn: null,
      iconOff: null,
      currentSrc: '',
      muted: localStorage.getItem('vn.audioMuted') === 'true',
      init() {
        // 建立音频实例（隐藏）
        if (!this.audio) {
          const audio = document.createElement('audio');
          audio.id = 'bgm-audio';
          audio.preload = 'auto';
          // iOS/Safari 需要 playsinline 属性以便通过手势解锁后正常播放
          try { audio.setAttribute('playsinline', ''); } catch {}
          audio.loop = true;
          audio.style.display = 'none';
          document.body.appendChild(audio);
          this.audio = audio;
          audio.addEventListener('play', () => this.updateIcon());
          audio.addEventListener('pause', () => this.updateIcon());
          audio.addEventListener('ended', () => this.updateIcon());
          audio.addEventListener('error', () => this.updateIcon());
        }
        // 挂载按钮
        this.mountButton();
        // 绑定一次性手势解锁，避免自动播放策略导致不响
        this.bindAutoplayUnlock();
        this.updateIcon();
      },
      bindAutoplayUnlock() {
        // 在首次用户交互后，若存在曲目且未静音则尝试播放，并移除监听
        const tryUnlock = () => {
          if (this.currentSrc && !this.muted && this.audio && this.audio.paused) {
            this.safePlay();
          }
          window.removeEventListener('pointerdown', tryUnlock, true);
          window.removeEventListener('touchstart', tryUnlock, true);
          window.removeEventListener('keydown', tryUnlock, true);
        };
        window.addEventListener('pointerdown', tryUnlock, true);
        window.addEventListener('touchstart', tryUnlock, true);
        window.addEventListener('keydown', tryUnlock, true);
      },
      mountButton() {
        if (this.button) return;
        const btn = document.createElement('button');
        btn.id = 'music-toggle';
        btn.type = 'button';
        btn.title = '背景音乐 开/关';
        // 使用用户提供的 SVG 图标（正在播放/被关闭），颜色跟随 currentColor
        btn.innerHTML = `
          <span class="icon-music-on" aria-hidden="true" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path fill="currentColor" d="M10 21q-1.65 0-2.825-1.175T6 17t1.175-2.825T10 13q.575 0 1.063.138t.937.412V4q0-.425.288-.712T13 3h4q.425 0 .713.288T18 4v2q0 .425-.288.713T17 7h-3v10q0 1.65-1.175 2.825T10 21"/>
            </svg>
          </span>
          <span class="icon-music-off" aria-hidden="true" style="display:none">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path fill="currentColor" d="M19.8 22.6L1.4 4.2l1.4-1.4l18.4 18.4zM14 11.15l-2-2V3h6v4h-4zM10 21q-1.65 0-2.825-1.175T6 17t1.175-2.825T10 13q.575 0 1.063.138t.937.412V12l2 2v3q0 1.65-1.175 2.825T10 21"/>
            </svg>
          </span>
        `;
        const tryAttachToControlBar = () => {
          const group = document.querySelector('#control-bar .control-group');
          if (!group) return false;
          group.appendChild(btn);
          btn.classList.remove('music-float');
          return true;
        };
        if (!tryAttachToControlBar()) {
          // 未找到控制条：先以浮动按钮显示；待控制条出现后迁移
          const container = document.getElementById('responsive-container') || document.body;
          container.appendChild(btn);
          btn.classList.add('music-float');
          const mo = new MutationObserver(() => {
            if (tryAttachToControlBar()) {
              mo.disconnect();
            }
          });
          mo.observe(document.body, { childList: true, subtree: true });
        }
        btn.addEventListener('click', () => this.toggle());
        this.button = btn;
        this.iconOn = btn.querySelector('.icon-music-on');
        this.iconOff = btn.querySelector('.icon-music-off');
        this.updateIcon();
      },
      toggle() {
        this.setMuted(!this.muted);
      },
      setMuted(flag) {
        this.muted = !!flag;
        try { localStorage.setItem('vn.audioMuted', String(this.muted)); } catch {}
        if (this.muted) {
          // 仅暂停，不清空 currentSrc（M2 跟随最新）
          try { this.audio?.pause(); } catch {}
        } else {
          // 取消静音：若已有曲目，立即尝试播放
          if (this.currentSrc) this.safePlay();
        }
        this.updateIcon();
      },
      safePlay() {
        if (!this.audio) return;
        const p = this.audio.play();
        if (p && typeof p.then === 'function') {
          p.then(() => {
            this.updateIcon();
          }).catch(() => {
            // 自动播放限制；保持图标与实际一致
            this.updateIcon();
          });
        }
      },
      setTrack(src) {
        if (!src || typeof src !== 'string') return;
        if (this.audio && this.audio.src !== src) {
          this.audio.src = src;
        }
        this.currentSrc = src;
        if (!this.muted) {
          this.safePlay();
        } else {
          // 静音时保持暂停
          try { this.audio?.pause(); } catch {}
        }
        this.updateIcon();
      },
      applyDeclaration(nameOrUrl) {
        const src = 解析音乐源(nameOrUrl);
        if (!src) return; // 未识别则忽略
        // 同一曲目重复声明：若未静音且已播放则直接保持
        if (this.currentSrc === src) {
          if (!this.muted && this.audio?.paused) this.safePlay();
          this.updateIcon();
          return;
        }
        this.setTrack(src);
      },
      applyFromText(text) {
        const token = 提取VN音乐(text);
        if (!token) return; // 无 <music>：继续上一首
        this.applyDeclaration(token);
      },
      updateIcon() {
        if (!this.button) return;
        // 图标以“是否静音”为准，点击即刻切换，避免无曲目时看起来不变
        const soundOn = !this.muted;
        if (this.iconOn) this.iconOn.style.display = soundOn ? 'inline' : 'none';
        if (this.iconOff) this.iconOff.style.display = soundOn ? 'none' : 'inline';
        this.button.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
        this.button.classList.toggle('active', soundOn);
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      bindRefs();
      setAspectMode(state.desktopMode);
      initializeColorPickers();
      bindEvents();
      updateAutoToggleUI();
      // 初始化全局 BGM 控制与图标
      try { BGM.init(); } catch (e) { console.warn('[VN] BGM init failed:', e); }
      // 读取脚本中的 <VN><music>…</music> 初始曲目
      try { BGM.applyFromText(scriptText); } catch {}
      applySettings();
      // 加载本地保存的视频头像与间隔
      const savedVideoImages = loadJSON(VIDEO_USER_IMAGES_KEY, []);
      if (Array.isArray(savedVideoImages) && savedVideoImages.length > 0) {
        setUserPreviewImages(savedVideoImages);
      }
      const savedVideoMs = getStoredNumber(VIDEO_USER_INTERVAL_KEY, state.userPreview.intervalMs);
      if (Number.isFinite(savedVideoMs) && savedVideoMs >= 500) {
        state.userPreview.intervalMs = savedVideoMs;
      }
      renderHistory();
      renderCGGallery();
      loadScene(0);
    });

    function bindRefs() {
      refs.container = document.getElementById('responsive-container');
      refs.backgroundFill = document.getElementById('background-fill');
      refs.background = document.getElementById('background-img');
      refs.cg = document.getElementById('cg-img');
      refs.sprite = document.getElementById('character-sprite');
      refs.effectLayer = document.getElementById('effect-layer');
      refs.dialogueBox = document.getElementById('dialogue-box');
      refs.name = document.getElementById('character-name');
      refs.nameplate = document.getElementById('speaker-nameplate');
      refs.dialogueText = document.getElementById('dialogue-text');
      refs.prompt = document.querySelector('.dialogue-prompt');
      refs.smsPanel = document.getElementById('sms-panel');
      refs.smsThread = document.getElementById('sms-thread');
      refs.smsContact = document.getElementById('sms-contact');
      refs.smsForm = document.getElementById('sms-composer-form');
      refs.smsInput = document.getElementById('sms-input');
      refs.smsAttachToggle = document.querySelector('.sms-attach-toggle');
      refs.smsActionMenu = document.querySelector('.sms-action-menu');
      refs.smsImageOverlay = document.getElementById('sms-image-overlay');
      refs.smsImageForm = document.getElementById('sms-image-form');
      refs.smsImageTextarea = document.getElementById('sms-image-text');
      refs.smsImageClose = document.querySelector('.sms-image-close');
      refs.smsImageCancel = document.querySelector('.sms-image-cancel');
      refs.smsVoiceOverlay = document.getElementById('sms-voice-overlay');
      refs.smsVoiceForm = document.getElementById('sms-voice-form');
      refs.smsVoiceContent = document.getElementById('sms-voice-content');
      refs.smsVoiceDuration = document.getElementById('sms-voice-duration');
      refs.smsVoiceClose = document.querySelector('.sms-voice-close');
      refs.smsVoiceCancel = document.querySelector('.sms-voice-cancel');
      refs.smsVoiceBack = document.querySelector('.sms-voice-back');
      refs.smsRedOverlay = document.getElementById('sms-red-overlay');
      refs.smsRedForm = document.getElementById('sms-red-form');
      refs.smsRedLabel = document.getElementById('sms-red-label');
      refs.smsRedAmount = document.getElementById('sms-red-amount');
      refs.smsRedClose = document.querySelector('.sms-red-close');
      refs.smsRedCancel = document.querySelector('.sms-red-cancel');
      refs.smsRedBack = document.querySelector('.sms-red-back');
      refs.smsTransferOverlay = document.getElementById('sms-transfer-overlay');
      refs.smsTransferForm = document.getElementById('sms-transfer-form');
      refs.smsTransferTarget = document.getElementById('sms-transfer-target');
      refs.smsTransferAmount = document.getElementById('sms-transfer-amount');
      refs.smsTransferNote = document.getElementById('sms-transfer-note');
      refs.smsTransferClose = document.querySelector('.sms-transfer-close');
      refs.smsTransferCancel = document.querySelector('.sms-transfer-cancel');
      refs.smsTransferBackButtons = document.querySelectorAll('.sms-transfer-back');
      refs.smsSendBtn = document.querySelector('.sms-send');
      refs.smsSettingsBtn = document.querySelector('.sms-settings');
      refs.smsSettingsOverlay = document.getElementById('sms-settings-overlay');
      refs.smsAvatarForm = document.getElementById('sms-avatar-form');
      refs.smsAvatarInput = document.getElementById('sms-avatar-input');
      refs.smsAvatarClear = document.getElementById('sms-avatar-clear');
      refs.smsNicknameInput = document.getElementById('sms-nickname-input');
      refs.smsNicknameClear = document.getElementById('sms-nickname-clear');
      refs.smsSettingsClose = document.querySelector('.sms-settings-close');
      refs.choiceOverlay = document.getElementById('choice-overlay');
      refs.choiceList = document.getElementById('choice-list');
      refs.choiceForm = document.getElementById('choice-custom');
      refs.choiceInput = document.getElementById('choice-input');
      refs.choiceSend = document.getElementById('choice-send');
      refs.choiceClose = document.getElementById('choice-close');
      refs.controlBar = document.getElementById('control-bar');
      refs.settingsPanel = document.getElementById('settings-panel');
      refs.historyPanel = document.getElementById('history-panel');
      refs.cgPanel = document.getElementById('cg-gallery');
      refs.historyList = document.getElementById('history-list');
      refs.cgList = document.getElementById('cg-list');
      refs.cgOverlay = document.getElementById('cg-overlay');
      refs.cgOverlayImage = document.getElementById('cg-overlay-image');
      refs.cgOverlayClose = document.querySelector('.cg-overlay-close');
      refs.cgOverlayPrev = document.querySelector('.cg-overlay-prev');
      refs.cgOverlayNext = document.querySelector('.cg-overlay-next');
      refs.typingSlider = document.getElementById('typing-speed');
      refs.typingLabel = document.getElementById('typing-speed-label');
      refs.dialogueColor = document.getElementById('dialogue-text-color');
      refs.dialogueBgColor = document.getElementById('dialogue-bg-color');
      refs.panelColor = document.getElementById('panel-text-color');
      refs.panelBgColor = document.getElementById('panel-bg-color');
      refs.controlIconColor = document.getElementById('control-icon-color');
      refs.controlIconBgColor = document.getElementById('control-icon-bg-color');
      refs.controlSizeInput = document.getElementById('control-button-size');
      refs.controlSizeLabel = document.getElementById('control-button-size-label');
      refs.dialogueBlurInput = document.getElementById('dialogue-blur');
      refs.dialogueBlurLabel = document.getElementById('dialogue-blur-label');
      refs.panelBlurInput = document.getElementById('panel-blur');
      refs.panelBlurLabel = document.getElementById('panel-blur-label');
      refs.fontInput = document.getElementById('font-size-input');
      refs.autoWaitInput = document.getElementById('auto-wait-seconds');
      refs.settingsBtn = document.getElementById('settings-btn');
      refs.historyBtn = document.getElementById('history-btn');
      refs.smsBtn = document.getElementById('sms-btn');
      refs.cgBtn = document.getElementById('cg-btn');
      refs.jumpLastBtn = document.getElementById('jump-last-btn');
      refs.autoToggleBtn = document.getElementById('auto-toggle');
      refs.aspectBtn = document.getElementById('aspect-btn');
      refs.resetBtn = document.getElementById('reset-settings');
      refs.smsBack = document.querySelector('.sms-back');
      refs.controlToggle = document.getElementById('control-toggle');
      refs.sfx = document.getElementById('sfx-player');
      // 视频通话
      refs.videoPanel = document.getElementById('video-panel');
      refs.videoBubble = document.getElementById('video-bubble');
      refs.videoContact = document.getElementById('video-contact');
      refs.videoUserPreview = document.getElementById('video-user-preview');
      // 视频头像设置弹窗
      refs.videoUserOverlay = document.getElementById('video-user-overlay');
      refs.videoUserForm = document.getElementById('video-user-form');
      refs.videoUserTextarea = document.getElementById('video-user-urls');
      refs.videoUserInterval = document.getElementById('video-user-interval');
      refs.videoUserClose = document.querySelector('.video-user-close');
      refs.videoUserCancel = document.querySelector('.video-user-cancel');
      refs.videoUserClear = document.querySelector('.video-user-clear');
      refs.videoMicBtn = document.getElementById('video-mic-btn');
      refs.videoCamBtn = document.getElementById('video-cam-btn');
      refs.videoHangupBtn = document.getElementById('video-hangup-btn');
      // 短信内“视频邀请”确认弹窗
      refs.smsVideoOverlay = document.getElementById('sms-video-overlay');
      refs.smsVideoPrompt = document.getElementById('sms-video-prompt');
      refs.smsVideoTargetInput = document.getElementById('sms-video-target');
      refs.smsVideoConfirm = document.querySelector('.sms-video-confirm');
      refs.smsVideoCancel = document.querySelector('.sms-video-cancel');
    }

    function initializeColorPickers() {
      const React = window.React;
      const ReactDOM = window.ReactDOM;
      const arcoLib = window.arco || window.ArcoDesign || window.ArcoDesignReact;
      const hasAdvancedPicker = Boolean(
        React &&
        ReactDOM &&
        arcoLib &&
        arcoLib.ColorPicker &&
        COLOR_INPUT_VALUE_DESCRIPTOR
      );
      const ColorPicker = hasAdvancedPicker ? arcoLib.ColorPicker : null;
      const resolveColorString = (...candidates) => {
        for (const candidate of candidates) {
          if (!candidate) continue;
          if (typeof candidate === 'string' && candidate.trim()) {
            return candidate.trim();
          }
          if (typeof candidate === 'object') {
            if (typeof candidate.css === 'string' && candidate.css.trim()) {
              return candidate.css.trim();
            }
            if (typeof candidate.rgba === 'string' && candidate.rgba.trim()) {
              return candidate.rgba.trim();
            }
            if (typeof candidate.rgb === 'string' && candidate.rgb.trim()) {
              return candidate.rgb.trim();
            }
            if (typeof candidate.value === 'string' && candidate.value.trim()) {
              return candidate.value.trim();
            }
            if (typeof candidate.hex === 'string' && candidate.hex.trim()) {
              return candidate.hex.trim();
            }
            if (candidate.color && candidate.color !== candidate) {
              const nested = resolveColorString(candidate.color);
              if (nested) return nested;
            }
            if (typeof candidate.toRgbString === 'function') {
              const result = candidate.toRgbString();
              if (typeof result === 'string' && result.trim()) {
                return result.trim();
              }
            }
            if (typeof candidate.toHexString === 'function') {
              const result = candidate.toHexString();
              if (typeof result === 'string' && result.trim()) {
                return result.trim();
              }
            }
          }
        }
        return null;
      };
      document.querySelectorAll('.color-picker-host[data-target]').forEach(host => {
        const targetId = host.getAttribute('data-target');
        const input = targetId ? document.getElementById(targetId) : null;
        if (!input || input.dataset.arcoPickerAttached === 'true') return;
        input.dataset.arcoPickerAttached = 'true';
        const format = host.getAttribute('data-format') || input.dataset.format || 'hex';
        const showAlphaAttr = host.getAttribute('data-alpha');
        const showAlpha = showAlphaAttr === 'true' || (format !== 'hex' && showAlphaAttr !== 'false');
        const fallback = format === 'rgb'
          ? (input.value || input.getAttribute('value') || 'rgba(22,93,255,1)')
          : (input.value || input.getAttribute('value') || '#165DFF');
        const normalizeValue = (raw) => format === 'rgb'
          ? normalizeRgbaColor(raw, fallback)
          : normalizeHexColor(raw, fallback);
        let currentValue = normalizeValue(input.value || fallback);
        const descriptor = COLOR_INPUT_VALUE_DESCRIPTOR;
        const applyNativeValue = (value) => {
          if (descriptor && typeof descriptor.set === 'function') {
            descriptor.set.call(input, value);
          } else {
            input.setAttribute('value', value);
          }
        };
        applyNativeValue(currentValue);

        if (!hasAdvancedPicker) {
          // Fallback: present a plain text input if the Arco ColorPicker is unavailable.
          const fallbackInput = document.createElement('input');
          fallbackInput.type = 'text';
          fallbackInput.className = 'color-picker-fallback';
          fallbackInput.value = currentValue;
          fallbackInput.placeholder = format === 'rgb' ? 'rgba(255, 255, 255, 1)' : '#ffffff';
          fallbackInput.autocomplete = 'off';
          fallbackInput.spellcheck = false;
          fallbackInput.title = format === 'rgb'
            ? '请输入 RGBA 颜色（例如：rgba(255, 255, 255, 0.85)）'
            : '请输入十六进制颜色（例如：#165dff）';

          const isValidColor = (value) => {
            const trimmed = typeof value === 'string' ? value.trim() : '';
            if (!trimmed) return false;
            if (format === 'rgb') {
              return Boolean(parseColorValue(trimmed));
            }
            return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(trimmed);
          };
          const commitValue = (raw) => {
            const normalized = normalizeValue(raw);
            if (normalized === currentValue) {
              fallbackInput.value = normalized;
              return;
            }
            currentValue = normalized;
            applyNativeValue(normalized);
            fallbackInput.value = normalized;
            input.dispatchEvent(new Event('input', { bubbles: true }));
          };

          fallbackInput.addEventListener('input', () => {
            const raw = fallbackInput.value;
            if (!isValidColor(raw)) return;
            commitValue(raw);
          });
          fallbackInput.addEventListener('blur', () => {
            const raw = fallbackInput.value;
            if (!isValidColor(raw)) {
              fallbackInput.value = currentValue;
              return;
            }
            commitValue(raw);
          });

          Object.defineProperty(input, 'value', {
            configurable: true,
            enumerable: descriptor ? descriptor.enumerable : true,
            get() {
              return descriptor && typeof descriptor.get === 'function'
                ? descriptor.get.call(this)
                : currentValue;
            },
            set(newValue) {
              const normalized = normalizeValue(newValue);
              if (normalized === currentValue) return;
              currentValue = normalized;
              applyNativeValue(normalized);
              fallbackInput.value = normalized;
            }
          });

          host.classList.add('color-picker-host--fallback');
          while (host.firstChild) {
            host.removeChild(host.firstChild);
          }
          host.appendChild(fallbackInput);
          input.dataset.format = format;
          input.classList.add('color-input--hidden');
          return;
        }

        let isInternalUpdate = false;

        const renderPicker = () => {
          ReactDOM.render(
            React.createElement(ColorPicker, {
              value: currentValue,
              format,
              size: 'small',
              showText: true,
              showAlpha,
              onChange: (...args) => {
                const candidate = resolveColorString(...args, currentValue);
                if (!candidate) return;
                const normalized = normalizeValue(candidate);
                if (normalized === currentValue) return;
                isInternalUpdate = true;
                currentValue = normalized;
                input.value = normalized;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                isInternalUpdate = false;
                renderPicker();
              }
            }),
            host
          );
        };

        Object.defineProperty(input, 'value', {
          configurable: true,
          enumerable: COLOR_INPUT_VALUE_DESCRIPTOR.enumerable,
          get() {
            return COLOR_INPUT_VALUE_DESCRIPTOR.get.call(this);
          },
          set(newValue) {
            const normalized = normalizeValue(newValue);
            const previous = currentValue;
            COLOR_INPUT_VALUE_DESCRIPTOR.set.call(this, normalized);
            currentValue = normalized;
            if (!isInternalUpdate && normalized !== previous) {
              renderPicker();
            }
          }
        });

        input.dataset.format = format;
        input.classList.add('color-input--hidden');
        renderPicker();
      });
    }

    function bindEvents() {
      refs.dialogueBox.addEventListener('click', handleAdvance);
      refs.smsPanel.addEventListener('click', handleAdvance);
      refs.videoPanel?.addEventListener('click', handleAdvance);
      refs.smsForm?.addEventListener('submit', handleSMSSubmit);
      refs.smsInput?.addEventListener('keydown', handleSMSKeydown);
      refs.smsInput?.addEventListener('input', autoResizeSMSInput);
      refs.smsAttachToggle?.addEventListener('click', handleSmsAttachToggleClick);
      refs.smsActionMenu?.addEventListener('click', handleSmsActionMenuClick);
      refs.smsImageForm?.addEventListener('submit', handleImageComposerSubmit);
      refs.smsImageClose?.addEventListener('click', handleImageComposerCancel);
      refs.smsImageCancel?.addEventListener('click', handleImageComposerCancel);
      refs.smsImageOverlay?.addEventListener('click', handleImageComposerOverlayBackdrop);
      refs.smsImageTextarea?.addEventListener('input', () => refs.smsImageTextarea.classList.remove('error'));
      refs.smsVoiceForm?.addEventListener('submit', handleVoiceComposerSubmit);
      refs.smsVoiceClose?.addEventListener('click', handleVoiceComposerCancel);
      refs.smsVoiceCancel?.addEventListener('click', handleVoiceComposerCancel);
      refs.smsVoiceBack?.addEventListener('click', handleVoiceComposerBack);
      refs.smsVoiceOverlay?.addEventListener('click', handleVoiceComposerOverlayBackdrop);
      refs.smsVoiceContent?.addEventListener('input', () => refs.smsVoiceContent.classList.remove('error'));
      refs.smsVoiceDuration?.addEventListener('input', () => refs.smsVoiceDuration.classList.remove('error'));
      refs.smsRedForm?.addEventListener('submit', handleRedComposerSubmit);
      refs.smsRedClose?.addEventListener('click', handleRedComposerCancel);
      refs.smsRedCancel?.addEventListener('click', handleRedComposerCancel);
      refs.smsRedBack?.addEventListener('click', handleRedComposerBack);
      refs.smsRedOverlay?.addEventListener('click', handleRedComposerOverlayBackdrop);
      refs.smsRedLabel?.addEventListener('input', () => refs.smsRedLabel.classList.remove('error'));
      refs.smsRedAmount?.addEventListener('input', () => refs.smsRedAmount.classList.remove('error'));
      refs.smsTransferForm?.addEventListener('submit', handleTransferComposerSubmit);
      refs.smsTransferClose?.addEventListener('click', handleTransferComposerCancel);
      refs.smsTransferCancel?.addEventListener('click', handleTransferComposerCancel);
      (refs.smsTransferBackButtons || []).forEach(btn => btn.addEventListener('click', handleTransferComposerBack));
      refs.smsTransferOverlay?.addEventListener('click', handleTransferComposerOverlayBackdrop);
      refs.smsTransferTarget?.addEventListener('input', () => refs.smsTransferTarget.classList.remove('error'));
      refs.smsTransferAmount?.addEventListener('input', () => refs.smsTransferAmount.classList.remove('error'));
      // 视频邀请确认
      refs.smsVideoOverlay?.addEventListener('click', handleSmsVideoOverlayBackdrop);
      refs.smsVideoTargetInput?.addEventListener('input', updateSmsVideoPromptByInput);
      refs.smsVideoConfirm?.addEventListener('click', handleSmsVideoConfirm);
      refs.smsVideoCancel?.addEventListener('click', handleSmsVideoCancel);
      refs.smsSendBtn?.addEventListener('click', handleSmsSendClick);
      refs.smsSendBtn?.addEventListener('pointerdown', handleSmsSendPointerDown);
      refs.smsSendBtn?.addEventListener('pointerup', handleSmsSendPointerUp);
      refs.smsSendBtn?.addEventListener('pointerleave', handleSmsSendPointerCancel);
      refs.smsSendBtn?.addEventListener('pointercancel', handleSmsSendPointerCancel);
      refs.smsSettingsBtn?.addEventListener('click', openSmsSettingsOverlay);
      refs.smsAvatarForm?.addEventListener('submit', handleSmsAvatarSubmit);
      refs.smsAvatarClear?.addEventListener('click', handleSmsAvatarClear);
      refs.smsNicknameClear?.addEventListener('click', handleSmsNicknameClear);
      refs.smsSettingsOverlay?.addEventListener('click', handleSmsSettingsOverlayBackdrop);
      refs.smsSettingsClose?.addEventListener('click', closeSmsSettingsOverlay);
      // 视频通话按钮
      refs.videoHangupBtn?.addEventListener('click', handleVideoHangup);
      refs.videoMicBtn?.addEventListener('click', toggleVideoMic);
      refs.videoCamBtn?.addEventListener('click', toggleVideoCam);
      refs.videoUserPreview?.addEventListener('click', (e) => { e?.stopPropagation?.(); openVideoUserOverlay(); });
      refs.videoUserPreview?.addEventListener('keydown', (e) => {
        const key = e?.key?.toLowerCase?.();
        if (key === 'enter' || key === ' ') {
          e.preventDefault();
          openVideoUserOverlay();
        }
      });
      // 视频头像设置弹窗事件
      refs.videoUserForm?.addEventListener('submit', handleVideoUserSubmit);
      refs.videoUserClose?.addEventListener('click', handleVideoUserCancel);
      refs.videoUserCancel?.addEventListener('click', handleVideoUserCancel);
      refs.videoUserClear?.addEventListener('click', handleVideoUserClear);
      refs.videoUserOverlay?.addEventListener('click', handleVideoUserOverlayBackdrop);
      refs.settingsBtn.addEventListener('click', () => togglePanel(refs.settingsPanel));
      refs.historyBtn.addEventListener('click', () => togglePanel(refs.historyPanel));
      refs.historyList?.addEventListener('click', handleHistoryClick);
      refs.smsBtn?.addEventListener('click', handleSMSButtonClick);
      refs.cgBtn.addEventListener('click', () => togglePanel(refs.cgPanel));
      refs.jumpLastBtn?.addEventListener('click', jumpToFinalScene);
      refs.cgList?.addEventListener('click', handleCGThumbClick);
      refs.autoToggleBtn?.addEventListener('click', handleAutoToggle);
      refs.aspectBtn.addEventListener('click', toggleAspect);
      refs.resetBtn.addEventListener('click', resetSettings);
      refs.typingSlider.addEventListener('input', handleTypingSlider);
      refs.fontInput.addEventListener('change', handleFontInput);
      refs.fontInput.addEventListener('blur', handleFontInput);
      refs.dialogueColor.addEventListener('input', handleDialogueColor);
      refs.dialogueBgColor.addEventListener('input', handleDialogueBgColor);
      refs.panelColor.addEventListener('input', handlePanelTextColor);
      refs.panelBgColor.addEventListener('input', handlePanelBgColor);
      refs.controlIconColor.addEventListener('input', handleControlIconColor);
      refs.controlIconBgColor.addEventListener('input', handleControlIconBgColor);
      refs.controlSizeInput.addEventListener('input', handleControlSizeChange);
      refs.dialogueBlurInput.addEventListener('input', handleDialogueBlurChange);
      refs.panelBlurInput.addEventListener('input', handlePanelBlurChange);
      refs.autoWaitInput.addEventListener('change', handleAutoPauseChange);
      refs.autoWaitInput.addEventListener('blur', handleAutoPauseChange);
      refs.smsBack.addEventListener('click', closeSMSPanel);
      refs.controlToggle?.addEventListener('click', handleControlToggle);
      refs.choiceForm?.addEventListener('submit', handleChoiceSubmit);
      refs.choiceSend?.addEventListener('click', handleChoiceSend);
      refs.choiceClose?.addEventListener('click', handleChoiceClose);
      // 点击回复面板外的空白区域关闭
      refs.choiceOverlay?.addEventListener('click', handleChoiceOverlayBackdropClick);
      refs.cgOverlayClose?.addEventListener('click', closeCGOverlay);
      refs.cgOverlayPrev?.addEventListener('click', () => stepCGOverlay(-1));
      refs.cgOverlayNext?.addEventListener('click', () => stepCGOverlay(1));
      refs.cgOverlay?.addEventListener('click', handleCGOverlayBackdropClick);
      window.addEventListener('resize', recalcSMSAvatarAlignments);
      window.addEventListener('resize', () => { if (state.userPreview.visible) recalcVideoUserPreviewSize(); });
      if (state.controlBarMediaQuery?.addEventListener) {
        state.controlBarMediaQuery.addEventListener('change', handleControlBarMediaChange);
      } else if (state.controlBarMediaQuery?.addListener) {
        state.controlBarMediaQuery.addListener(handleControlBarMediaChange);
      }
      document.addEventListener('click', handleGlobalDocumentClick, true);
      updateAutoToggleUI();
      setControlBarExpanded(state.controlBarExpanded);
      autoResizeSMSInput();
      setSmsActionMenuOpen(false);
    }

    function handleGlobalDocumentClick(event) {
      if (!state.firstInteraction) {
        state.firstInteraction = true;
      }
      closePanelsOnOutsideClick(event);
      maybeCloseSmsActionMenu(event);
    }

    function closePanelsOnOutsideClick(event) {
      const panels = [refs.settingsPanel, refs.historyPanel, refs.cgPanel];
      const buttons = [refs.settingsBtn, refs.historyBtn, refs.cgBtn];
      panels.forEach((panel, idx) => {
        if (!panel.contains(event.target) && !buttons[idx].contains(event.target)) {
          panel.classList.remove('panel-open');
        }
      });
    }

    function maybeCloseSmsActionMenu(event) {
      if (!state.smsActionMenuOpen) return;
      const target = event?.target;
      if (target instanceof Element) {
        if (refs.smsActionMenu?.contains(target)) return;
        if (refs.smsAttachToggle?.contains(target)) return;
      }
      setSmsActionMenuOpen(false);
    }

    function parseVNScript(raw) {
      if (typeof raw !== 'string') {
        return { scenes: [], options: [] };
      }
      const match = raw.match(/<VN>[\s\S]*?<gametext>([\s\S]*?)<\/gametext>(?:[\s\S]*?<options>([\s\S]*?)<\/options>)?[\s\S]*?<\/VN>/i);
      if (!match) {
        return { scenes: [], options: [] };
      }
      const [, gametextRaw = '', optionsRaw = ''] = match;
      const scenes = gametextRaw
        .split('\n')
        .map(line => line.trim())
        .filter(Boolean)
        .map((line, idx) => parseSceneLine(line, idx));
      const options = optionsRaw
        .split('\n')
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => line.replace(/^\[|\]$/g, '').trim())
        .filter(Boolean);
      return { scenes, options };
    }

    function parseSceneLine(line, index) {
      const parts = line.split('|').map(part => part.trim());
      let modeToken = '';
      let speakerToken = '';
      let bg;
      let cg;
      let sprite;
      let text = '';
      let effectsToken;
      if (parts.length >= 7) {
        [modeToken, speakerToken, bg, cg, sprite, text, effectsToken] = parts;
      } else if (parts.length >= 6) {
        [modeToken, speakerToken, bg, cg, sprite, text] = parts;
      } else {
        [speakerToken = '', bg, cg, sprite, text] = parts;
      }

      const isSMSBySpeaker = speakerToken.startsWith('@');
      const speaker = isSMSBySpeaker ? speakerToken.slice(1) : speakerToken;

      return {
        speaker,
        bg: normalizeBackgroundAsset(bg),
        cg: normalizeCGAsset(cg, index, speaker),
        sprite: normalizeSpriteAsset(sprite, index),
        text: text ?? '',
        mode: normalizeMode(modeToken, isSMSBySpeaker),
        effects: normalizeEffectList(effectsToken)
      };
    }

    // 针对“CG”字段：与立绘一致，优先使用 CG表 + 稳定随机；
    // 语义与 normalizeAsset 保持一致：undefined/空 → undefined；'null'/'none' → null；URL 原样；
    // 资源键/短码/文件名 => 走 CGURL（含短码/文件名兜底）。
    function normalizeCGAsset(value, index, speaker) {
      if (value === undefined) return undefined;
      const trimmed = String(value).trim();
      if (!trimmed) return undefined;
      const lower = trimmed.toLowerCase();
      if (lower === 'null' || lower === 'none') return null;
      if (是URL(trimmed)) return trimmed;
      const resolved = CGURL(trimmed, index, speaker);
      if (resolved !== null && resolved !== undefined) return resolved;
      const filename = /\.[a-z0-9]+$/i.test(trimmed) ? trimmed : `${trimmed}.png`;
      return CATBOX_BASE + filename;
    }

    // 针对“立绘”字段：优先使用立绘表 + 稳定随机；
    // 语义与 normalizeAsset 保持一致：
    // - undefined/空字符串 => undefined（不变）
    // - 'null'/'none' => null（清空）
    // - 直接 URL => 原样
    // - 资源键/短码/文件名 => 走立绘URL（含短码/文件名兜底）
    function normalizeSpriteAsset(value, index) {
      if (value === undefined) return undefined;
      const trimmed = String(value).trim();
      if (!trimmed) return undefined;
      const lower = trimmed.toLowerCase();
      if (lower === 'null' || lower === 'none') return null;
      if (是URL(trimmed)) return trimmed;
      const resolved = 立绘URL(trimmed, index);
      if (resolved !== null && resolved !== undefined) return resolved;
      // 理论上 立绘URL 已经包含短码/文件名兜底，这里仅作最终兜底
      const filename = /\.[a-z0-9]+$/i.test(trimmed) ? trimmed : `${trimmed}.png`;
      return CATBOX_BASE + filename;
    }

    function normalizeMode(modeToken, isSMSFallback) {
      const token = (modeToken || '').toLowerCase();
      if (token.includes('短信') || token === 'sms') return 'sms';
      if (token.includes('线下') || token === 'offline') return 'offline';
      if (token.includes('视频') || token === 'video') return 'video';
      return isSMSFallback ? 'sms' : 'offline';
    }

    function normalizeAsset(value) {
      if (value === undefined) return undefined;
      const trimmed = value.trim();
      if (!trimmed) return undefined;
      const lower = trimmed.toLowerCase();
      if (lower === 'null' || lower === 'none') return null;
      if (/^(https?:)?\/\//i.test(trimmed) || trimmed.startsWith('data:') || trimmed.startsWith('blob:') || trimmed.includes('/')) {
        return trimmed;
      }
      const filename = /\.[a-z0-9]+$/i.test(trimmed) ? trimmed : `${trimmed}.png`;
      return CATBOX_BASE + filename;
    }
    function normalizeEffectList(raw) {
      if (typeof raw !== 'string') return undefined;
      const trimmed = raw.trim();
      if (!trimmed || trimmed === '无' || trimmed.toLowerCase() === 'null') {
        return undefined;
      }
      const items = trimmed
        .split(/[,，]/)
        .map(item => item.trim())
        .filter(Boolean);
      return items.length ? items : undefined;
    }

    function getEffectTargetElement(target) {
      if (!refs) return null;
      switch (target) {
        case 'container':
          return refs.container;
        case 'background':
          return refs.background;
        case 'effectLayer':
          return refs.effectLayer;
        case 'character':
          return refs.sprite;
        default:
          return null;
      }
    }

    function clearAllEffects() {
      const seen = new Set();
      Object.values(EFFECT_DEFINITIONS).forEach(definition => {
        const key = `${definition.target}:${definition.className}`;
        if (seen.has(key)) return;
        seen.add(key);
        const target = getEffectTargetElement(definition.target);
        if (target) {
          target.classList.remove(definition.className);
        }
      });
    }

    function applySceneEffects(scene) {
      clearAllEffects();
      if (!scene || !Array.isArray(scene.effects) || scene.effects.length === 0) {
        return;
      }
      scene.effects.forEach(effectName => {
        const definition = EFFECT_DEFINITIONS[effectName];
        if (!definition) {
          console.warn(`[VN] 未识别的特效：${effectName}`);
          return;
        }
        const target = getEffectTargetElement(definition.target);
        if (!target) return;
        target.classList.remove(definition.className);
        // 强制重绘以确保动画重新触发
        void target.offsetWidth;
        target.classList.add(definition.className);
      });
    }

    function loadScene(index, options = {}) {
      const scene = scenes[index];
      if (!scene) return;
      // 应用脚本顶部声明的 <VN><music>…</music></VN>（同一首重复声明将被忽略）
      try { BGM.applyFromText(scriptText); } catch (e) { /* 忽略解析失败 */ }
      const {
        instant = false,
        skipAuto = false,
        skipSMSAppend = false
      } = options;
      state.index = index;
      if (refs.choiceOverlay?.classList.contains('choice-overlay--show')) {
        hideChoices();
      }
      state.awaitingChoice = false;
      setManualSMSOpen(false);
      applySceneEffects(scene);
      if (scene.mode === 'sms') {
        refs.container.classList.add('sms-mode');
        refs.container.classList.remove('video-mode');
        setControlBarExpanded(false);
        renderSMSScene(scene, { skipAuto, skipAppend: skipSMSAppend });
        showPrompt();
      } else if (scene.mode === 'video') {
        refs.container.classList.remove('sms-mode');
        refs.container.classList.add('video-mode');
        setControlBarExpanded(false);
        renderVideoScene(scene);
        hidePrompt();
      } else {
        refs.container.classList.remove('sms-mode');
        refs.container.classList.remove('video-mode');
        const fallbackExpanded = state.controlBarMediaQuery?.matches ?? true;
        setControlBarExpanded(fallbackExpanded);
        renderOfflineScene(scene, { instant, skipAuto });
      }
      updateHistory();
      if (scene.cg && scene.cg !== scene.bg && scene.cg !== scene.sprite) {
        unlockCG(scene.cg, scene.text);
      }
    }

    function renderOfflineScene(scene, options = {}) {
      const { instant = false, skipAuto = false } = options;
      hidePrompt();
      setSpeaker(scene.speaker);
      applyBackgroundFromScene(scene.bg);
      applyCG(scene.cg);
      applySpriteForScene(scene);
      // 文字输出到普通对话框
      typewriter.setTarget(refs.dialogueText);
      if (instant) {
        typewriter.stop();
        if (refs.dialogueText) refs.dialogueText.textContent = scene.text || '';
        showPrompt();
        if (state.auto && !skipAuto) {
          scheduleAutoAdvance();
        }
        return;
      }
      typewriter.start(scene.text, () => {
        showPrompt();
        if (state.auto && !skipAuto) {
          scheduleAutoAdvance();
        }
      });
    }

    function renderSMSScene(scene, options = {}) {
      const { skipAuto = false, skipAppend = false } = options;
      setSpeaker(scene.speaker);
      applyCG(null);
      hideSprite();
      refs.smsContact.textContent = scene.speaker || '';
      if (!skipAppend) {
        appendSMSBubble(scene);
      }
      if (state.auto && !skipAuto) {
        scheduleAutoAdvance();
      }
    }

    function renderVideoScene(scene) {
      // 显示立绘与背景（视频界面不隐藏立绘）
      setSpeaker(scene.speaker);
      applyBackgroundFromScene(scene.bg);
      applyCG(null);
      applySpriteForScene(scene);
      if (refs.videoContact) {
        refs.videoContact.textContent = scene.speaker || '';
      }
      // 文本以气泡形式展示在挂断按钮上方，并启用打字机效果
      const text = (scene.text || '').trim();
      if (refs.videoBubble) {
        if (text) {
          refs.videoBubble.style.display = 'inline-block';
          typewriter.setTarget(refs.videoBubble);
          typewriter.start(text);
        } else {
          refs.videoBubble.textContent = '';
          refs.videoBubble.style.display = 'none';
        }
      }
      if (refs.videoPanel) {
        refs.videoPanel.setAttribute('aria-hidden', 'false');
      }
    }

    function appendSMSBubble(scene) {
      if (!refs.smsThread) return;
      const li = document.createElement('li');
      const speakerName = (scene?.speaker || '').trim();
      const isNarration = speakerName === '旁白';
      const isPlayer = !isNarration && isPlayerSpeaker(scene.speaker);
      li.className = isNarration
        ? 'sms-bubble sms-narration'
        : `sms-bubble ${isPlayer ? 'outgoing' : 'incoming'}`;
      if (!isNarration) {
        li.dataset.speakerRaw = speakerName;
      }
      if (scene?.isCustom) {
        li.dataset.role = 'custom-sms';
        if (scene.id) {
          li.dataset.messageId = scene.id;
        }
      }

      let contentElement = null;
      const voicePayload = getSceneVoicePayload(scene);
      const imagePayload = getSceneImagePayload(scene);
      const redPayload = getSceneRedEnvelopePayload(scene);
      const transferPayload = getSceneTransferPayload(scene);
      const videoPayload = getSceneVideoInvitePayload(scene);
      if (isNarration) {
        const body = document.createElement('div');
        body.className = 'bubble-body';
        const narration = document.createElement('div');
        narration.className = 'content';
        narration.textContent = scene.text || '';
        body.appendChild(narration);
        li.appendChild(body);
      } else {
        // 头像容器：如果没有头像资源也保留空间，保证排版稳定
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const customPlayerAvatar = isPlayer ? state.playerAvatarUrl : '';
        if (isPlayer) {
          if (customPlayerAvatar) {
            const img = document.createElement('img');
            img.src = customPlayerAvatar;
            img.alt = '我的头像';
            avatar.appendChild(img);
          } else {
            avatar.classList.add('avatar--empty');
          }
        } else {
          const resolved = resolveContactDisplay(scene.speaker || '', scene.sprite || '');
          if (resolved.avatarUrl) {
            const img = document.createElement('img');
            img.src = resolved.avatarUrl;
            img.alt = (resolved.displayName || scene.speaker || '头像');
            avatar.appendChild(img);
          } else if (scene.sprite) {
            const img = document.createElement('img');
            img.src = scene.sprite;
            img.alt = scene.speaker || '头像';
            avatar.appendChild(img);
          } else {
            avatar.textContent = deriveAvatarInitial(resolved.displayName || scene.speaker, isPlayer);
          }
        }

        // 气泡主体：姓名独立显示在气泡上方，正文自动换行
        const stack = document.createElement('div');
        stack.className = 'bubble-stack';
        const name = document.createElement('div');
        name.className = 'name';
        if (isPlayer) {
          name.textContent = state.playerName || '{{user}}';
        } else {
          const resolved = resolveContactDisplay(scene.speaker || '', scene.sprite || '');
          name.textContent = (resolved.displayName || scene.speaker || '未知联系人');
        }
        const body = document.createElement('div');
        body.className = 'bubble-body';
        if (voicePayload) {
          li.classList.add('sms-bubble--voice');
          const voiceNode = createVoiceBubbleContent(voicePayload);
          body.appendChild(voiceNode);
          contentElement = voiceNode;
        } else if (redPayload) {
          li.classList.add('sms-bubble--red');
          const redNode = createRedEnvelopeBubbleContent(redPayload);
          body.appendChild(redNode);
          contentElement = redNode;
        } else if (transferPayload) {
          li.classList.add('sms-bubble--transfer');
          const transferNode = createTransferBubbleContent(transferPayload);
          body.appendChild(transferNode);
          contentElement = transferNode;
        } else if (videoPayload) {
          li.classList.add('sms-bubble--video');
          const videoNode = createVideoInviteBubbleContent(videoPayload);
          body.appendChild(videoNode);
          contentElement = videoNode;
        } else if (imagePayload) {
          li.classList.add('sms-bubble--image');
          const imageNode = createImageBubbleContent(imagePayload);
          body.appendChild(imageNode);
          contentElement = imageNode;
        } else {
          const textNode = document.createElement('div');
          textNode.className = 'content';
          textNode.textContent = scene.text || '';
          body.appendChild(textNode);
          contentElement = textNode;
        }
        stack.appendChild(name);
        stack.appendChild(body);

        li.appendChild(avatar);
        li.appendChild(stack);
      }
      refs.smsThread.appendChild(li);

      // 根据文本行数动态设置头像垂直对齐，解决单行/多行位置问题
      if (!isNarration && contentElement && !li.classList.contains('sms-bubble--voice') && !li.classList.contains('sms-bubble--red') && !li.classList.contains('sms-bubble--image') && !li.classList.contains('sms-bubble--transfer') && !li.classList.contains('sms-bubble--video')) {
        adjustSMSAvatarAlignment(li, contentElement);
      }

      refs.smsThread.scrollTop = refs.smsThread.scrollHeight;
    }

    function getSceneVoicePayload(scene) {
      if (!scene) return null;
      if (scene.voice && typeof scene.voice === 'object') {
        const transcript = typeof scene.voice.transcript === 'string'
          ? scene.voice.transcript.trim()
          : '';
        const display = typeof scene.voice.display === 'string'
          ? scene.voice.display.trim()
          : '';
        const secondsCandidate = scene.voice.seconds;
        const seconds = Number.isFinite(secondsCandidate) && secondsCandidate > 0
          ? Math.round(secondsCandidate)
          : (/^\d+$/.test(display) ? Number(display) : null);
        if (!transcript && !display) return null;
        return {
          transcript,
          display: display || (seconds !== null ? String(seconds) : ''),
          seconds
        };
      }
      const text = typeof scene.text === 'string' ? scene.text.trim() : '';
      if (!text) return null;
      const match = text.match(/^\[语音\]\[(.*?)\]\[(.+?)\]$/);
      if (!match) return null;
      const transcript = (match[1] || '').trim();
      const display = (match[2] || '').trim();
      const seconds = /^\d+$/.test(display) ? Number(display) : null;
      return { transcript, display, seconds };
    }

    function getSceneTransferPayload(scene) {
      if (!scene) return null;
      if (scene.transfer && typeof scene.transfer === 'object') {
        const rawTarget = typeof scene.transfer.target === 'string' ? scene.transfer.target : '';
        const rawAmount = typeof scene.transfer.amount === 'string' ? scene.transfer.amount : '';
        const rawNote = typeof scene.transfer.note === 'string' ? scene.transfer.note : '';
        const target = sanitizeBracketSegment(rawTarget);
        const amount = sanitizeBracketSegment(rawAmount);
        const note = sanitizeBracketSegment(rawNote);
        if (!target && !amount && !note) return null;
        return {
          target,
          amount,
          amountDisplay: amount || '',
          note
        };
      }
      const text = typeof scene.text === 'string' ? scene.text.trim() : '';
      if (!text) return null;
      const match = text.match(/^\[转账\]\[(.*?)\]\[(.+?)\]\[(.*?)\]$/);
      if (!match) return null;
      const rawTarget = sanitizeBracketSegment(match[1] || '');
      const rawAmount = sanitizeBracketSegment(match[2] || '');
      const rawNote = sanitizeBracketSegment(match[3] || '');
      if (!rawTarget && !rawAmount && !rawNote) return null;
      return {
        target: rawTarget,
        amount: rawAmount,
        amountDisplay: rawAmount || '',
        note: rawNote
      };
    }

    function getSceneVideoInvitePayload(scene) {
      if (!scene) return null;
      if (scene.videoInvite && typeof scene.videoInvite === 'object') {
        const rawTarget = sanitizeBracketSegment(scene.videoInvite.target || '');
        if (!rawTarget) return { target: '' };
        return { target: rawTarget };
      }
      const text = typeof scene.text === 'string' ? scene.text.trim() : '';
      if (!text) return null;
      // 支持从文本中解析占位：[视频邀请][与xxx的视频通话邀请]
      const match = text.match(/^\[视频邀请\]\[(.*)\]$/);
      if (!match) return null;
      const raw = sanitizeBracketSegment(match[1] || '');
      return { target: raw };
    }

    function getSceneImagePayload(scene) {
      if (!scene) return null;
      if (scene.image && typeof scene.image === 'object') {
        const description = sanitizeBracketSegment(scene.image.description || scene.image.text || '');
        if (!description) return { description: '' };
        return { description };
      }
      const text = typeof scene.text === 'string' ? scene.text.trim() : '';
      if (!text) return null;
      const match = text.match(/^\[图片\]\[(.*)\]$/);
      if (!match) return null;
      const rawDescription = sanitizeBracketSegment(match[1] || '');
      return { description: rawDescription };
    }

    function getSceneRedEnvelopePayload(scene) {
      if (!scene) return null;
      if (scene.red && typeof scene.red === 'object') {
        const rawLabel = sanitizeBracketSegment(scene.red.label);
        const rawAmount = sanitizeBracketSegment(scene.red.amount);
        if (!rawLabel && !rawAmount) return null;
        const label = rawLabel || '红包';
        const amount = rawAmount;
        return {
          label,
          amount,
          amountDisplay: amount || ''
        };
      }
      const text = typeof scene.text === 'string' ? scene.text.trim() : '';
      if (!text) return null;
      const match = text.match(/^\[红包\]\[(.*?)\]\[(.+?)\]$/);
      if (!match) return null;
      const rawLabel = sanitizeBracketSegment(match[1] || '');
      const rawAmount = sanitizeBracketSegment(match[2] || '');
      if (!rawLabel && !rawAmount) return null;
      const label = rawLabel || '红包';
      const amount = rawAmount;
      return {
        label,
        amount,
        amountDisplay: amount || ''
      };
    }

    function createRedEnvelopeBubbleContent(payload) {
      const wrapper = document.createElement('div');
      wrapper.className = 'sms-red-envelope';

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'sms-red-envelope-button';
      button.setAttribute('aria-pressed', 'false');

      const icon = document.createElement('div');
      icon.className = 'sms-red-envelope-icon';
      icon.textContent = '¥';
      button.appendChild(icon);

      const info = document.createElement('div');
      info.className = 'sms-red-envelope-info';

      const title = document.createElement('div');
      title.className = 'sms-red-envelope-title';
      title.textContent = payload.label || '红包';
      info.appendChild(title);

      const hint = document.createElement('div');
      hint.className = 'sms-red-envelope-hint';
      hint.textContent = '点击拆开红包';
      info.appendChild(hint);

      button.appendChild(info);

      const amount = document.createElement('div');
      amount.className = 'sms-red-envelope-amount';
      amount.textContent = '¥--';
      button.appendChild(amount);

      wrapper.appendChild(button);

      const resolvedAmount = payload.amountDisplay ? `¥${payload.amountDisplay}` : '¥--';
      let opened = false;
      button.addEventListener('click', () => {
        if (opened) return;
        opened = true;
        wrapper.classList.add('open');
        button.setAttribute('aria-pressed', 'true');
        amount.textContent = resolvedAmount;
        hint.textContent = payload.amountDisplay ? '已领取' : '已拆开';
      });

      return wrapper;
    }

    function createImageBubbleContent(payload) {
      const wrapper = document.createElement('div');
      wrapper.className = 'sms-image-message';

      const card = document.createElement('div');
      card.className = 'sms-image-card';

      const description = document.createElement('div');
      description.className = 'sms-image-card__description';
      const resolvedText = payload.description
        ? `图片描述：${payload.description}`
        : '图片描述：未填写';
      description.textContent = resolvedText;

      card.appendChild(description);
      wrapper.appendChild(card);

      return wrapper;
    }

    function createTransferBubbleContent(payload) {
      const wrapper = document.createElement('div');
      wrapper.className = 'sms-transfer-message';

      const card = document.createElement('div');
      card.className = 'sms-transfer-card';

      // “详”按钮（将放入标题行，避免覆盖右侧金额）
      const moreBtn = document.createElement('button');
      moreBtn.type = 'button';
      moreBtn.className = 'sms-transfer-more';
      moreBtn.setAttribute('aria-label', '查看转账详情');
      moreBtn.title = '详';
      moreBtn.textContent = '详';

      const info = document.createElement('div');
      info.className = 'sms-transfer-info';

      const title = document.createElement('div');
      title.className = 'sms-transfer-title';

      // SVG icon placed on the left of the word "转账"
      const titleIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      titleIcon.setAttribute('width', '20');
      titleIcon.setAttribute('height', '20');
      titleIcon.setAttribute('viewBox', '0 0 24 24');
      const titlePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      titlePath.setAttribute('fill', 'currentColor');
      titlePath.setAttribute('d', 'M19.379 15.106A8.001 8.001 0 0 0 8.035 5.056l-.993-1.737a10 10 0 0 1 9.962.023c4.49 2.593 6.21 8.143 4.118 12.77l1.342.775l-4.166 2.214l-.165-4.714zM4.629 8.9a8.001 8.001 0 0 0 11.345 10.05l.992 1.737a10 10 0 0 1-9.962-.024c-4.49-2.593-6.21-8.142-4.117-12.77L1.545 7.12L5.71 4.905l.165 4.714zm8.375 4.638h3v2h-3v2h-2v-2h-3v-2h3v-1h-3v-2h2.586L8.469 8.417l1.414-1.414l2.121 2.121l2.122-2.121l1.414 1.414l-2.122 2.121h2.586v2h-3z');
      titleIcon.appendChild(titlePath);

      const titleText = document.createElement('span');
      titleText.className = 'sms-transfer-title-text';
      titleText.textContent = '转账';

      title.appendChild(titleIcon);
      title.appendChild(titleText);
      // 将“详”按钮放到标题行右侧
      title.appendChild(moreBtn);
      info.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'sms-transfer-meta';
      meta.textContent = payload.target ? `对象：${payload.target}` : '对象：—';
      info.appendChild(meta);

      if (payload.note) {
        const note = document.createElement('div');
        note.className = 'sms-transfer-note';
        note.textContent = `备注：${payload.note}`;
        info.appendChild(note);
      }

      card.appendChild(info);

      const amount = document.createElement('div');
      amount.className = 'sms-transfer-amount';
      amount.textContent = payload.amountDisplay ? `¥${payload.amountDisplay}` : '¥--';
      card.appendChild(amount);

      wrapper.appendChild(card);

      // 接受转账交互：仅对收到的（incoming）信息允许“接受”
      let accepted = false;
      card.addEventListener('click', () => {
        if (accepted) return;
        const bubble = card.closest('.sms-bubble');
        const isIncoming = bubble?.classList.contains('incoming');
        if (!isIncoming) return;
        if (!isUserPlaceholder(payload.target)) return;
        accepted = true;
        card.classList.add('accepted');
        title.textContent = '已收款';
        // 生成旁白：[{{user}}接受了转账]
        appendSmsNarration(`[${payload.target}接受了转账]`);
      });

      // 弹出详情：包含 对象/备注/金额
      const openDetails = () => {
        // 构建覆盖层
        const overlay = document.createElement('div');
        overlay.className = 'sms-transfer-overlay open';
        overlay.setAttribute('role', 'dialog');
        overlay.setAttribute('aria-modal', 'true');

        const panel = document.createElement('div');
        panel.className = 'sms-transfer-dialog';

        const heading = document.createElement('h3');
        heading.textContent = '转账详情';
        panel.appendChild(heading);

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'sms-transfer-close';
        closeBtn.setAttribute('aria-label', '关闭');
        panel.appendChild(closeBtn);

        const details = document.createElement('div');
        details.className = 'sms-transfer-details';

        const rowTarget = document.createElement('div');
        rowTarget.className = 'sms-transfer-row';
        const labelTarget = document.createElement('div');
        labelTarget.className = 'sms-transfer-label';
        labelTarget.textContent = '对象';
        const valueTarget = document.createElement('div');
        valueTarget.className = 'sms-transfer-value';
        valueTarget.textContent = payload.target ? String(payload.target) : '—';
        rowTarget.appendChild(labelTarget);
        rowTarget.appendChild(valueTarget);
        details.appendChild(rowTarget);

        const rowNote = document.createElement('div');
        rowNote.className = 'sms-transfer-row';
        const labelNote = document.createElement('div');
        labelNote.className = 'sms-transfer-label';
        labelNote.textContent = '备注';
        const valueNote = document.createElement('div');
        valueNote.className = 'sms-transfer-value';
        valueNote.textContent = payload.note ? String(payload.note) : '—';
        rowNote.appendChild(labelNote);
        rowNote.appendChild(valueNote);
        details.appendChild(rowNote);

        const rowAmount = document.createElement('div');
        rowAmount.className = 'sms-transfer-row';
        const labelAmount = document.createElement('div');
        labelAmount.className = 'sms-transfer-label';
        labelAmount.textContent = '金额';
        const valueAmount = document.createElement('div');
        valueAmount.className = 'sms-transfer-value';
        valueAmount.textContent = payload.amountDisplay ? `¥${payload.amountDisplay}` : '—';
        rowAmount.appendChild(labelAmount);
        rowAmount.appendChild(valueAmount);
        details.appendChild(rowAmount);

        panel.appendChild(details);
        overlay.appendChild(panel);

        const host = document.getElementById('content-wrapper') || document.body;
        host.appendChild(overlay);

        const close = () => {
          overlay.classList.remove('open');
          // 延迟移除与过渡匹配
          setTimeout(() => {
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
          }, 200);
        };
        const onBackdrop = (e) => {
          if (e.target === overlay) close();
        };
        const onKey = (e) => {
          if (e.key === 'Escape') {
            e.stopPropagation();
            close();
          }
        };
        overlay.addEventListener('click', onBackdrop);
        closeBtn.addEventListener('click', close);
        document.addEventListener('keydown', onKey, { once: true });
      };

      const handleMoreClick = (e) => { e?.stopPropagation?.(); e?.preventDefault?.(); openDetails(); };
      const handleMoreTouch = (e) => { e?.stopPropagation?.(); e?.preventDefault?.(); openDetails(); };
      moreBtn.addEventListener('click', handleMoreClick);
      moreBtn.addEventListener('touchend', handleMoreTouch, { passive: false });

      return wrapper;
    }

    function createVideoInviteBubbleContent(payload) {
      const wrapper = document.createElement('div');
      wrapper.className = 'sms-video-invite';

      const card = document.createElement('div');
      card.className = 'sms-video-card';

      const icon = document.createElement('div');
      icon.className = 'sms-video-icon';
      icon.textContent = '📹';
      card.appendChild(icon);

      const info = document.createElement('div');
      info.className = 'sms-video-info';

      const title = document.createElement('div');
      title.className = 'sms-video-title';
      title.textContent = '视频邀请';
      info.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'sms-video-meta';
      const toLabel = (payload && payload.target) ? String(payload.target) : '';
      meta.textContent = toLabel ? `你向${toLabel}发起了视频通话请求` : '发起了一个视频通话请求';
      info.appendChild(meta);

      card.appendChild(info);
      wrapper.appendChild(card);

      return wrapper;
    }

    function isUserPlaceholder(name) {
      const normalized = (name || '').trim();
      return normalized === '{{user}}';
    }

    function createVoiceBubbleContent(payload) {
      const wrapper = document.createElement('div');
      wrapper.className = 'sms-voice-message';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'sms-voice-button';
      button.setAttribute('aria-expanded', 'false');

      const icon = document.createElement('div');
      icon.className = 'sms-voice-icon';
      button.appendChild(icon);

      const wave = document.createElement('div');
      wave.className = 'sms-voice-wave';
      for (let i = 0; i < 14; i += 1) {
        const bar = document.createElement('span');
        wave.appendChild(bar);
      }
      button.appendChild(wave);

      const duration = document.createElement('div');
      duration.className = 'sms-voice-duration';
      duration.textContent = payload.display || (payload.seconds !== null ? String(payload.seconds) : '');
      button.appendChild(duration);

      const transcript = document.createElement('div');
      transcript.className = 'sms-voice-transcript';
      transcript.textContent = payload.transcript || '';

      button.addEventListener('click', () => {
        const open = wrapper.classList.toggle('open');
        button.setAttribute('aria-expanded', open ? 'true' : 'false');
      });

      wrapper.appendChild(button);
      wrapper.appendChild(transcript);
      return wrapper;
    }

    function isPlayerSpeaker(name) {
      // 约定“{{user}}/我/玩家/主角/用户”或用户自定义昵称代表自己的短信
      const normalized = (name || '').trim();
      if (!normalized) return false;
      if (normalized === '{{user}}') return true;
      if (normalized === (state.playerName || '')) return true;
      return ['我', '玩家', '主角', '用户'].includes(normalized);
    }

    function deriveAvatarInitial(name, isPlayer) {
      const fallback = isPlayer ? '我' : '？';
      const source = (name || '').trim();
      if (!source) {
        return fallback;
      }
      const [firstChar] = Array.from(source);
      if (!firstChar) {
        return fallback;
      }
      if (/[a-z]/i.test(firstChar)) {
        return firstChar.toUpperCase();
      }
      return firstChar;
    }

    function adjustSMSAvatarAlignment(item, content) {
      if (!content) return;
      const computed = window.getComputedStyle(content);
      const lineHeight = parseFloat(computed.lineHeight) || 24;
      const lines = Math.round(content.scrollHeight / lineHeight);
      item.classList.toggle('single-line', lines <= 1);
    }

    function recalcSMSAvatarAlignments() {
      if (!refs.smsThread) return;
      refs.smsThread.querySelectorAll('.sms-bubble').forEach(bubble => {
        if (bubble.classList.contains('sms-bubble--voice')) return;
        if (bubble.classList.contains('sms-bubble--red')) return;
        if (bubble.classList.contains('sms-bubble--image')) return;
        if (bubble.classList.contains('sms-bubble--transfer')) return;
        if (bubble.classList.contains('sms-bubble--video')) return;
        const content = bubble.querySelector('.content');
        adjustSMSAvatarAlignment(bubble, content);
      });
    }

    function autoResizeSMSInput() {
      if (!refs.smsInput) return;
      const field = refs.smsInput;
      field.style.height = 'auto';
      const maxHeight = 120;
      field.style.height = `${Math.min(maxHeight, field.scrollHeight)}px`;
    }

    function parseVoiceDurationInput(raw) {
      if (typeof raw !== 'string') return null;
      const trimmed = raw.trim();
      if (!trimmed) return null;
      if (!/^\d+$/.test(trimmed)) return null;
      const seconds = Number(trimmed);
      if (!Number.isFinite(seconds) || seconds <= 0) return null;
      return {
        seconds,
        display: trimmed
      };
    }

    function formatVoiceSceneText(transcript, displayDuration) {
      const safeTranscript = (transcript ?? '').replace(/\]/g, '】');
      const safeDuration = (displayDuration ?? '').replace(/\]/g, '】');
      return `[语音][${safeTranscript}][${safeDuration}]`;
    }

    function formatImageSceneText(description) {
      const safeDescription = sanitizeBracketSegment(description);
      return `[图片][${safeDescription}]`;
    }

    function formatTransferSceneText(target, amount, note) {
      const safeTarget = sanitizeBracketSegment(target);
      const safeAmount = sanitizeBracketSegment(amount);
      const safeNote = sanitizeBracketSegment(note);
      return `[转账][${safeTarget}][${safeAmount}][${safeNote}]`;
    }

    function sanitizeBracketSegment(value) {
      if (typeof value !== 'string') return '';
      return value.replace(/\]/g, '】').trim();
    }

    function formatRedEnvelopeSceneText(label, amount) {
      const safeLabel = sanitizeBracketSegment(label);
      const safeAmount = sanitizeBracketSegment(amount);
      return `[红包][${safeLabel}][${safeAmount}]`;
    }

    function formatRedEnvelopeAmount(raw) {
      const trimmed = typeof raw === 'string' ? raw.trim() : '';
      if (!trimmed) return '';
      const normalized = trimmed.replace(/^[¥￥]\s*/, '');
      if (/^\d+(\.\d+)?$/.test(normalized)) {
        const value = Number(normalized);
        if (Number.isFinite(value)) {
          const fractional = normalized.includes('.') ? normalized.split('.')[1] : '';
          const digits = Math.min(2, fractional.length);
          return value.toFixed(digits);
        }
      }
      return trimmed;
    }

    function formatTransferAmount(raw) {
      return formatRedEnvelopeAmount(raw);
    }

    function setSmsActionMenuOpen(open) {
      state.smsActionMenuOpen = Boolean(open);
      if (refs.smsActionMenu) {
        refs.smsActionMenu.classList.toggle('open', state.smsActionMenuOpen);
        refs.smsActionMenu.setAttribute('aria-hidden', state.smsActionMenuOpen ? 'false' : 'true');
      }
      if (refs.smsAttachToggle) {
        refs.smsAttachToggle.setAttribute('aria-expanded', state.smsActionMenuOpen ? 'true' : 'false');
      }
    }

    function toggleSmsActionMenu() {
      setSmsActionMenuOpen(!state.smsActionMenuOpen);
    }

    function handleSmsAttachToggleClick(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      toggleSmsActionMenu();
    }

    function handleSmsActionMenuClick(event) {
      const button = event?.target instanceof Element
        ? event.target.closest('.sms-action-btn')
        : null;
      if (!button) return;
      const action = button.dataset.action;
      if (!action) return;
      if (action === 'voice') {
        event?.preventDefault?.();
        openVoiceComposer();
        return;
      }
      if (action === 'red') {
        event?.preventDefault?.();
        openRedEnvelopeComposer();
        return;
      }
      if (action === 'transfer') {
        event?.preventDefault?.();
        openTransferComposer();
        return;
      }
      if (action === 'video') {
        event?.preventDefault?.();
        openVideoConfirm();
        return;
      }
      if (action === 'image') {
        event?.preventDefault?.();
        openImageComposer();
        return;
      }
      const template = SMS_ACTION_TEMPLATES[action];
      if (template && refs.smsInput) {
        refs.smsInput.value = template;
        autoResizeSMSInput();
        refs.smsInput.focus();
      }
      setSmsActionMenuOpen(false);
      event?.preventDefault?.();
    }

    function openImageComposer() {
      setSmsActionMenuOpen(false);
      if (!refs.smsImageOverlay || !refs.smsImageForm) return;
      resetImageComposerState();
      state.imageComposer.open = true;
      refs.smsImageOverlay.classList.add('open');
      refs.smsImageOverlay.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleImageComposerEscape, true);
      requestAnimationFrame(() => refs.smsImageTextarea?.focus());
    }

    function closeImageComposer() {
      if (!state.imageComposer.open) return;
      state.imageComposer.open = false;
      if (refs.smsImageOverlay) {
        refs.smsImageOverlay.classList.remove('open');
        refs.smsImageOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleImageComposerEscape, true);
      resetImageComposerState();
    }

    function resetImageComposerState() {
      state.imageComposer.description = '';
      if (refs.smsImageTextarea) {
        refs.smsImageTextarea.value = '';
        refs.smsImageTextarea.classList.remove('error');
      }
    }

    function handleImageComposerSubmit(event) {
      event?.preventDefault?.();
      if (!state.imageComposer.open || !refs.smsImageTextarea) return;
      const raw = (refs.smsImageTextarea.value || '').trim();
      if (!raw) {
        refs.smsImageTextarea.classList.add('error');
        requestAnimationFrame(() => refs.smsImageTextarea?.focus());
        return;
      }
      const sanitized = sanitizeBracketSegment(raw);
      appendPlayerImageMessage(sanitized);
      closeImageComposer();
    }

    function handleImageComposerCancel(event) {
      event?.preventDefault?.();
      closeImageComposer();
    }

    function handleImageComposerOverlayBackdrop(event) {
      if (event.target === refs.smsImageOverlay) {
        closeImageComposer();
      }
    }

    function handleImageComposerEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeImageComposer();
    }

    function openTransferComposer() {
      setSmsActionMenuOpen(false);
      if (!refs.smsTransferOverlay || !refs.smsTransferForm) return;
      resetTransferComposerState();
      state.transferComposer.open = true;
      refs.smsTransferOverlay.classList.add('open');
      refs.smsTransferOverlay.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleTransferComposerEscape, true);
      requestAnimationFrame(() => refs.smsTransferTarget?.focus());
    }

    function closeTransferComposer() {
      if (!state.transferComposer.open) return;
      state.transferComposer.open = false;
      if (refs.smsTransferOverlay) {
        refs.smsTransferOverlay.classList.remove('open');
        refs.smsTransferOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleTransferComposerEscape, true);
      resetTransferComposerState();
    }

    function resetTransferComposerState() {
      state.transferComposer.step = 'target';
      state.transferComposer.target = '';
      state.transferComposer.amountInput = '';
      state.transferComposer.note = '';
      clearTransferComposerErrors();
      if (refs.smsTransferTarget) refs.smsTransferTarget.value = '';
      if (refs.smsTransferAmount) refs.smsTransferAmount.value = '';
      if (refs.smsTransferNote) refs.smsTransferNote.value = '';
      setTransferComposerStep('target', { focus: false });
    }

    function clearTransferComposerErrors() {
      refs.smsTransferTarget?.classList.remove('error');
      refs.smsTransferAmount?.classList.remove('error');
    }

    function setTransferComposerStep(step, options = {}) {
      const { focus = true } = options;
      state.transferComposer.step = step;
      if (refs.smsTransferForm) {
        const stages = refs.smsTransferForm.querySelectorAll('.sms-transfer-stage');
        stages.forEach(stage => {
          const targetStep = stage.dataset.step;
          stage.classList.toggle('active', targetStep === step);
        });
      }
      if (!focus) return;
      if (step === 'target') {
        requestAnimationFrame(() => refs.smsTransferTarget?.focus());
      } else if (step === 'amount') {
        requestAnimationFrame(() => refs.smsTransferAmount?.focus());
      } else if (step === 'note') {
        requestAnimationFrame(() => refs.smsTransferNote?.focus());
      }
    }

    function handleTransferComposerSubmit(event) {
      event?.preventDefault?.();
      if (!state.transferComposer.open) return;
      clearTransferComposerErrors();
      if (state.transferComposer.step === 'target') {
        const target = (refs.smsTransferTarget?.value || '').trim();
        if (!target) {
          refs.smsTransferTarget?.classList.add('error');
          requestAnimationFrame(() => refs.smsTransferTarget?.focus());
          return;
        }
        state.transferComposer.target = target;
        setTransferComposerStep('amount');
        return;
      }
      if (state.transferComposer.step === 'amount') {
        const rawAmount = (refs.smsTransferAmount?.value || '').trim();
        if (!rawAmount) {
          refs.smsTransferAmount?.classList.add('error');
          requestAnimationFrame(() => refs.smsTransferAmount?.focus());
          return;
        }
        state.transferComposer.amountInput = formatTransferAmount(rawAmount);
        setTransferComposerStep('note');
        return;
      }
      if (state.transferComposer.step === 'note') {
        const note = (refs.smsTransferNote?.value || '').trim();
        state.transferComposer.note = note;
        const { target, amountInput } = state.transferComposer;
        closeTransferComposer();
        appendPlayerTransfer(target, amountInput, note);
      }
    }

    function handleTransferComposerCancel(event) {
      event?.preventDefault?.();
      closeTransferComposer();
    }

    function handleTransferComposerBack(event) {
      event?.preventDefault?.();
      clearTransferComposerErrors();
      if (!state.transferComposer.open) return;
      if (state.transferComposer.step === 'amount') {
        setTransferComposerStep('target');
      } else if (state.transferComposer.step === 'note') {
        setTransferComposerStep('amount');
      }
    }

    function handleTransferComposerOverlayBackdrop(event) {
      if (event.target === refs.smsTransferOverlay) {
        closeTransferComposer();
      }
    }

    function handleTransferComposerEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeTransferComposer();
    }

    // 视频邀请确认弹窗逻辑
    function openVideoConfirm() {
      setSmsActionMenuOpen(false);
      const name = getCurrentSmsContactName();
      const saved = (localStorage.getItem(SMS_VIDEO_TARGET_KEY) || '').trim();
      const target = saved || name || '{{char}}';
      if (refs.smsVideoTargetInput) {
        refs.smsVideoTargetInput.value = target;
      }
      if (refs.smsVideoPrompt) {
        refs.smsVideoPrompt.textContent = `你是否要拨打给${target}？`;
      }
      if (refs.smsVideoOverlay) {
        refs.smsVideoOverlay.classList.add('open');
        refs.smsVideoOverlay.setAttribute('aria-hidden', 'false');
        state.videoConfirmOpen = true;
        document.addEventListener('keydown', handleSmsVideoEscape, true);
        requestAnimationFrame(() => refs.smsVideoTargetInput?.focus());
      }
    }

    function closeVideoConfirm() {
      if (!state.videoConfirmOpen) return;
      state.videoConfirmOpen = false;
      if (refs.smsVideoOverlay) {
        refs.smsVideoOverlay.classList.remove('open');
        refs.smsVideoOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleSmsVideoEscape, true);
    }

    function handleSmsVideoOverlayBackdrop(event) {
      if (event.target === refs.smsVideoOverlay) {
        closeVideoConfirm();
      }
    }

    function handleSmsVideoEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeVideoConfirm();
    }

    function handleSmsVideoCancel(event) {
      event?.preventDefault?.();
      closeVideoConfirm();
    }

    function handleSmsVideoConfirm(event) {
      event?.preventDefault?.();
      const inputVal = (refs.smsVideoTargetInput?.value || '').trim();
      const fallback = getCurrentSmsContactName() || '{{char}}';
      const target = inputVal || fallback;
      const safe = sanitizeBracketSegment(target);
      try { localStorage.setItem(SMS_VIDEO_TARGET_KEY, safe); } catch {}
      closeVideoConfirm();
      appendPlayerVideoInvite(target);
    }

    function updateSmsVideoPromptByInput() {
      if (!refs.smsVideoPrompt) return;
      const inputVal = (refs.smsVideoTargetInput?.value || '').trim();
      const fallback = getCurrentSmsContactName() || '{{char}}';
      const target = inputVal || fallback;
      refs.smsVideoPrompt.textContent = `你是否要拨打给${target}？`;
    }

    function getCurrentSmsContactName() {
      const uiName = (refs.smsContact?.textContent || '').trim();
      if (uiName) return uiName;
      // 从历史场景中回溯最近的非玩家短信联系人
      for (let i = scenes.length - 1; i >= 0; i -= 1) {
        const s = scenes[i];
        if (!s || s.mode !== 'sms') continue;
        const name = (s.speaker || '').trim();
        if (name && name !== '旁白' && !isPlayerSpeaker(name)) {
          return name;
        }
      }
      return '';
    }
    function openRedEnvelopeComposer() {
      setSmsActionMenuOpen(false);
      if (!refs.smsRedOverlay || !refs.smsRedForm) return;
      resetRedComposerState();
      state.redComposer.open = true;
      refs.smsRedOverlay.classList.add('open');
      refs.smsRedOverlay.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleRedComposerEscape, true);
      requestAnimationFrame(() => refs.smsRedLabel?.focus());
    }

    function closeRedEnvelopeComposer() {
      if (!state.redComposer.open) return;
      state.redComposer.open = false;
      if (refs.smsRedOverlay) {
        refs.smsRedOverlay.classList.remove('open');
        refs.smsRedOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleRedComposerEscape, true);
      resetRedComposerState();
    }

    function resetRedComposerState() {
      state.redComposer.step = 'label';
      state.redComposer.label = '';
      state.redComposer.amountInput = '';
      clearRedComposerErrors();
      if (refs.smsRedLabel) {
        refs.smsRedLabel.value = '';
      }
      if (refs.smsRedAmount) {
        refs.smsRedAmount.value = '';
      }
      setRedComposerStep('label', { focus: false });
    }

    function clearRedComposerErrors() {
      refs.smsRedLabel?.classList.remove('error');
      refs.smsRedAmount?.classList.remove('error');
    }

    function setRedComposerStep(step, options = {}) {
      const { focus = true } = options;
      state.redComposer.step = step;
      if (refs.smsRedForm) {
        const stages = refs.smsRedForm.querySelectorAll('.sms-red-stage');
        stages.forEach(stage => {
          const targetStep = stage.dataset.step;
          stage.classList.toggle('active', targetStep === step);
        });
      }
      if (!focus) return;
      if (step === 'label') {
        requestAnimationFrame(() => refs.smsRedLabel?.focus());
      } else if (step === 'amount') {
        requestAnimationFrame(() => refs.smsRedAmount?.focus());
      }
    }

    function handleRedComposerSubmit(event) {
      event?.preventDefault?.();
      if (!state.redComposer.open) return;
      clearRedComposerErrors();
      if (state.redComposer.step === 'label') {
        const label = (refs.smsRedLabel?.value || '').trim();
        if (!label) {
          refs.smsRedLabel?.classList.add('error');
          requestAnimationFrame(() => refs.smsRedLabel?.focus());
          return;
        }
        state.redComposer.label = label;
        setRedComposerStep('amount');
        return;
      }
      if (state.redComposer.step === 'amount') {
        const rawAmount = (refs.smsRedAmount?.value || '').trim();
        if (!rawAmount) {
          refs.smsRedAmount?.classList.add('error');
          requestAnimationFrame(() => refs.smsRedAmount?.focus());
          return;
        }
        const normalizedAmount = formatRedEnvelopeAmount(rawAmount);
        state.redComposer.amountInput = normalizedAmount;
        const label = state.redComposer.label;
        closeRedEnvelopeComposer();
        appendPlayerRedEnvelope(label, normalizedAmount);
      }
    }

    function handleRedComposerCancel(event) {
      event?.preventDefault?.();
      closeRedEnvelopeComposer();
    }

    function handleRedComposerBack(event) {
      event?.preventDefault?.();
      clearRedComposerErrors();
      if (!state.redComposer.open) return;
      setRedComposerStep('label');
    }

    function handleRedComposerOverlayBackdrop(event) {
      if (event.target === refs.smsRedOverlay) {
        closeRedEnvelopeComposer();
      }
    }

    function handleRedComposerEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeRedEnvelopeComposer();
    }

    function openVoiceComposer() {
      setSmsActionMenuOpen(false);
      if (!refs.smsVoiceOverlay || !refs.smsVoiceForm) return;
      resetVoiceComposerState();
      state.voiceComposer.open = true;
      refs.smsVoiceOverlay.classList.add('open');
      refs.smsVoiceOverlay.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleVoiceComposerEscape, true);
      requestAnimationFrame(() => refs.smsVoiceContent?.focus());
    }

    function closeVoiceComposer() {
      if (!state.voiceComposer.open) return;
      state.voiceComposer.open = false;
      if (refs.smsVoiceOverlay) {
        refs.smsVoiceOverlay.classList.remove('open');
        refs.smsVoiceOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleVoiceComposerEscape, true);
      resetVoiceComposerState();
    }

    function resetVoiceComposerState() {
      state.voiceComposer.step = 'content';
      state.voiceComposer.content = '';
      state.voiceComposer.durationInput = '';
      state.voiceComposer.durationSeconds = 0;
      clearVoiceComposerErrors();
      if (refs.smsVoiceContent) {
        refs.smsVoiceContent.value = '';
      }
      if (refs.smsVoiceDuration) {
        refs.smsVoiceDuration.value = '';
      }
      setVoiceComposerStep('content');
    }

    function clearVoiceComposerErrors() {
      refs.smsVoiceContent?.classList.remove('error');
      refs.smsVoiceDuration?.classList.remove('error');
    }

    function setVoiceComposerStep(step) {
      state.voiceComposer.step = step;
      if (!refs.smsVoiceForm) return;
      const stages = refs.smsVoiceForm.querySelectorAll('.sms-voice-stage');
      stages.forEach(stage => {
        const targetStep = stage.dataset.step;
        stage.classList.toggle('active', targetStep === step);
      });
      if (step === 'content') {
        if (refs.smsVoiceContent) {
          refs.smsVoiceContent.value = state.voiceComposer.content || '';
        }
        requestAnimationFrame(() => refs.smsVoiceContent?.focus());
      } else if (step === 'duration') {
        if (refs.smsVoiceDuration) {
          refs.smsVoiceDuration.value = state.voiceComposer.durationInput || '';
        }
        requestAnimationFrame(() => refs.smsVoiceDuration?.focus());
      }
    }

    function handleVoiceComposerSubmit(event) {
      event?.preventDefault?.();
      if (!state.voiceComposer.open) return;
      if (state.voiceComposer.step === 'content') {
        const value = (refs.smsVoiceContent?.value || '').trim();
        if (!value) {
          refs.smsVoiceContent?.classList.add('error');
          requestAnimationFrame(() => refs.smsVoiceContent?.focus());
          return;
        }
        state.voiceComposer.content = value;
        if (refs.smsVoiceContent) {
          refs.smsVoiceContent.classList.remove('error');
        }
        setVoiceComposerStep('duration');
        return;
      }
      if (state.voiceComposer.step === 'duration') {
        const raw = (refs.smsVoiceDuration?.value || '').trim();
        const parsed = parseVoiceDurationInput(raw);
        if (!parsed) {
          refs.smsVoiceDuration?.classList.add('error');
          requestAnimationFrame(() => refs.smsVoiceDuration?.focus());
          return;
        }
        if (refs.smsVoiceDuration) {
          refs.smsVoiceDuration.classList.remove('error');
        }
        state.voiceComposer.durationInput = parsed.display;
        state.voiceComposer.durationSeconds = parsed.seconds;
        appendPlayerVoiceMessage(state.voiceComposer.content, parsed);
        closeVoiceComposer();
      }
    }

    function handleVoiceComposerCancel(event) {
      event?.preventDefault?.();
      closeVoiceComposer();
    }

    function handleVoiceComposerBack(event) {
      event?.preventDefault?.();
      if (!state.voiceComposer.open) return;
      setVoiceComposerStep('content');
    }

    function handleVoiceComposerOverlayBackdrop(event) {
      if (event.target === refs.smsVoiceOverlay) {
        closeVoiceComposer();
      }
    }

    function handleVoiceComposerEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeVoiceComposer();
    }

    function handleSMSSubmit(event) {
      event?.preventDefault?.();
      submitSMSMessage();
    }

    function handleSMSKeydown(event) {
      if (!event) return;
      if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
        event.preventDefault();
        submitSMSMessage();
      }
    }

    function submitSMSMessage() {
      if (!refs.smsInput) return;
      setSmsActionMenuOpen(false);
      const value = (refs.smsInput.value || '').trim();
      if (!value) {
        const wrap = refs.smsInput.closest('.sms-input');
        if (wrap) {
          wrap.classList.add('error');
          setTimeout(() => wrap.classList.remove('error'), 320);
        }
        return;
      }
      appendPlayerSMSMessage(value);
      refs.smsInput.value = '';
      autoResizeSMSInput();
    }

    function appendPlayerSMSMessage(text, options = {}) {
      const insertIndex = Math.min(state.index + 1, scenes.length);
      // Insert the player's reply as a scene so it is tracked with the scripted flow.
      const messageScene = {
        speaker: state.playerName || '{{user}}',
        text,
        mode: 'sms',
        isCustom: true
      };
      let normalizedText = text;
      let voiceInfo = null;
      let redInfo = null;
      let imageInfo = null;
      let transferInfo = null;
      if (options.voice) {
        voiceInfo = {
          transcript: options.voice.transcript,
          display: options.voice.display,
          seconds: options.voice.seconds
        };
        messageScene.voice = { ...voiceInfo };
      }
      if (options.red) {
        redInfo = {
          label: options.red.label,
          amount: options.red.amount
        };
        messageScene.red = { ...redInfo };
      }
      if (options.image) {
        imageInfo = {
          description: options.image.description
        };
        messageScene.image = { ...imageInfo };
      }
      if (options.transfer) {
        transferInfo = {
          target: options.transfer.target,
          amount: options.transfer.amount,
          note: options.transfer.note
        };
        messageScene.transfer = { ...transferInfo };
      }
      if (!voiceInfo && !redInfo && !imageInfo) {
        const imageMatch = typeof text === 'string'
          ? text.match(/^\[图片\]\[(.*)\]$/)
          : null;
        if (imageMatch) {
          const desc = sanitizeBracketSegment(imageMatch[1] || '');
          imageInfo = { description: desc };
          messageScene.image = { ...imageInfo };
        }
        const transferMatch = typeof text === 'string'
          ? text.match(/^\[转账\]\[(.*?)\]\[(.+?)\]\[(.*?)\]$/)
          : null;
        if (transferMatch) {
          const target = sanitizeBracketSegment(transferMatch[1] || '');
          const amount = sanitizeBracketSegment(transferMatch[2] || '');
          const note = sanitizeBracketSegment(transferMatch[3] || '');
          transferInfo = { target, amount, note };
          messageScene.transfer = { ...transferInfo };
        }
      }
      if (voiceInfo) {
        normalizedText = formatVoiceSceneText(voiceInfo.transcript, voiceInfo.display);
      } else if (redInfo) {
        normalizedText = formatRedEnvelopeSceneText(redInfo.label, redInfo.amount);
      } else if (imageInfo) {
        normalizedText = formatImageSceneText(imageInfo.description);
      } else if (transferInfo) {
        normalizedText = formatTransferSceneText(transferInfo.target, transferInfo.amount, transferInfo.note);
      }
      messageScene.text = normalizedText;
      scenes.splice(insertIndex, 0, messageScene);
      if (!Array.isArray(state.pendingSmsMessages)) {
        state.pendingSmsMessages = [];
      }
      const messageType = voiceInfo ? 'voice' : redInfo ? 'red' : imageInfo ? 'image' : transferInfo ? 'transfer' : 'text';
      state.pendingSmsMessages.push({
        text: normalizedText,
        timestamp: Date.now(),
        type: messageType,
        voice: voiceInfo ? { ...voiceInfo } : null,
        red: redInfo ? { ...redInfo } : null,
        image: imageInfo ? { ...imageInfo } : null,
        transfer: transferInfo ? { ...transferInfo } : null
      });
      loadScene(insertIndex);
    }

    function formatVideoInviteSceneText(target) {
      const safeTarget = sanitizeBracketSegment(target);
      return `[与${safeTarget}的视频通话邀请]`;
    }

    function appendPlayerVideoInvite(target) {
      const insertIndex = Math.min(state.index + 1, scenes.length);
      const messageScene = {
        speaker: state.playerName || '{{user}}',
        text: `[视频邀请][${formatVideoInviteSceneText(target)}]`,
        mode: 'sms',
        isCustom: true,
        videoInvite: { target }
      };
      scenes.splice(insertIndex, 0, messageScene);
      if (!Array.isArray(state.pendingSmsMessages)) {
        state.pendingSmsMessages = [];
      }
      state.pendingSmsMessages.push({
        text: messageScene.text,
        timestamp: Date.now(),
        type: 'video',
        video: { target }
      });
      loadScene(insertIndex);
    }

    function appendPlayerImageMessage(description) {
      const sanitized = sanitizeBracketSegment(description);
      const text = formatImageSceneText(sanitized);
      appendPlayerSMSMessage(text, {
        image: {
          description: sanitized
        }
      });
    }

    function appendPlayerRedEnvelope(label, amount) {
      const safeLabel = sanitizeBracketSegment(label) || '红包';
      const safeAmount = sanitizeBracketSegment(amount) || '0';
      const payload = {
        label: safeLabel,
        amount: safeAmount
      };
      const text = formatRedEnvelopeSceneText(payload.label, payload.amount);
      appendPlayerSMSMessage(text, { red: payload });
    }

    function appendPlayerTransfer(target, amount, note) {
      const safeTarget = sanitizeBracketSegment(target) || '';
      const safeAmount = sanitizeBracketSegment(formatTransferAmount(amount) || amount) || '';
      const safeNote = sanitizeBracketSegment(note) || '';
      const payload = { target: safeTarget, amount: safeAmount, note: safeNote };
      const text = formatTransferSceneText(payload.target, payload.amount, payload.note);
      appendPlayerSMSMessage(text, { transfer: payload });
    }

    function appendPlayerVoiceMessage(transcript, durationPayload) {
      const voice = {
        transcript,
        display: durationPayload.display,
        seconds: durationPayload.seconds
      };
      const text = formatVoiceSceneText(transcript, durationPayload.display);
      appendPlayerSMSMessage(text, { voice });
    }

    function appendSmsNarration(text) {
      // 直接在短信线程追加旁白，不改变联系人标题
      const scene = {
        speaker: '旁白',
        text: text,
        mode: 'sms',
        isCustom: true
      };
      appendSMSBubble(scene);
      // 聚合到待发送（长按发送）
      if (!Array.isArray(state.pendingSmsMessages)) {
        state.pendingSmsMessages = [];
      }
      state.pendingSmsMessages.push({
        text,
        timestamp: Date.now(),
        type: 'narration'
      });
    }

    function handleSmsSendClick(event) {
      const fromLongPress = state.smsLongPressHandled;
      if (fromLongPress) {
        event?.preventDefault?.();
        event?.stopPropagation?.();
        state.smsLongPressHandled = false;
        return;
      }
      const clickCount = Number(event?.detail) || 1;
      if (clickCount >= 2) {
        event?.preventDefault?.();
        event?.stopPropagation?.();
        triggerPendingSmsDispatch();
        return;
      }
      submitSMSMessage();
    }

    function handleSmsSendPointerDown(event) {
      if (!event) return;
      if (event.button !== undefined && event.button !== 0) return;
      clearTimeout(state.smsLongPressTimer);
      state.smsLongPressHandled = false;
      state.smsLongPressTimer = setTimeout(() => {
        state.smsLongPressTimer = null;
        state.smsLongPressHandled = true;
        triggerPendingSmsDispatch();
      }, SMS_LONG_PRESS_THRESHOLD);
    }

    function handleSmsSendPointerUp(event) {
      clearTimeout(state.smsLongPressTimer);
      state.smsLongPressTimer = null;
      if (state.smsLongPressHandled) {
        event?.preventDefault?.();
        event?.stopPropagation?.();
      }
    }

    function handleSmsSendPointerCancel() {
      clearTimeout(state.smsLongPressTimer);
      state.smsLongPressTimer = null;
      state.smsLongPressHandled = false;
    }

    // 将已发送（聚合中的）短信格式化为合并文本；可选择是否包含旁白
    function buildPendingSmsCombinedText({ includeNarration = true } = {}) {
      if (!Array.isArray(state.pendingSmsMessages) || state.pendingSmsMessages.length === 0) return '';
      const items = includeNarration
        ? state.pendingSmsMessages
        : state.pendingSmsMessages.filter(item => item && item.type !== 'narration');
      if (!items.length) return '';
      return items
        .map(item => {
          if (item.type === 'voice' && item.voice) {
            const voiceText = formatVoiceSceneText(item.voice.transcript, item.voice.display);
            return `{{user}}发送了短信：${voiceText}`;
          }
          if (item.type === 'red' && item.red) {
            const redText = formatRedEnvelopeSceneText(item.red.label, item.red.amount);
            return `{{user}}发送了短信：${redText}`;
          }
          if (item.type === 'transfer' && item.transfer) {
            const transferText = formatTransferSceneText(item.transfer.target, item.transfer.amount, item.transfer.note);
            return `{{user}}发送了短信：${transferText}`;
          }
          if (item.type === 'image' && item.image) {
            const imageText = formatImageSceneText(item.image.description);
            return `{{user}}发送了短信：${imageText}`;
          }
          if (item.type === 'video' && item.video) {
            const videoText = formatVideoInviteSceneText(item.video.target);
            return `{{user}}发送了短信：${videoText}`;
          }
          if (item.type === 'narration') {
            return item.text || '';
          }
          return `<user>发送短信：${item.text}`;
        })
        .join('\n');
    }

    function triggerPendingSmsDispatch() {
      if (!refs.smsInput) return;
      const draft = (refs.smsInput.value || '').trim();
      if (draft) {
        appendPlayerSMSMessage(draft);
        refs.smsInput.value = '';
        autoResizeSMSInput();
      }
      if (!Array.isArray(state.pendingSmsMessages) || state.pendingSmsMessages.length === 0) {
        indicateNoPendingSms();
        return;
      }
      const combinedText = buildPendingSmsCombinedText({ includeNarration: true });
      sendChoice(combinedText);
      state.pendingSmsMessages = [];
    }

    function indicateNoPendingSms() {
      const wrap = refs.smsInput?.closest('.sms-input');
      if (!wrap) return;
      wrap.classList.add('error');
      setTimeout(() => wrap.classList.remove('error'), 320);
    }

    function openSmsSettingsOverlay(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      if (!refs.smsSettingsOverlay) return;
      refs.smsSettingsOverlay.classList.add('open');
      refs.smsSettingsOverlay.setAttribute('aria-hidden', 'false');
      if (refs.smsAvatarInput) {
        refs.smsAvatarInput.value = state.playerAvatarUrl;
      }
      if (refs.smsNicknameInput) {
        refs.smsNicknameInput.value = state.playerName || '{{user}}';
      }
      // Mount and render contact manager
      ensureContactManagerMounted();
      renderContactOverridesList();
      requestAnimationFrame(() => (refs.smsNicknameInput || refs.smsAvatarInput)?.focus());
      document.addEventListener('keydown', handleSmsSettingsEscape, true);
    }

    function closeSmsSettingsOverlay() {
      if (!refs.smsSettingsOverlay) return;
      refs.smsSettingsOverlay.classList.remove('open');
      refs.smsSettingsOverlay.setAttribute('aria-hidden', 'true');
      document.removeEventListener('keydown', handleSmsSettingsEscape, true);
    }

    function handleSmsSettingsOverlayBackdrop(event) {
      if (event.target === refs.smsSettingsOverlay) {
        closeSmsSettingsOverlay();
      }
    }

    function handleSmsSettingsEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeSmsSettingsOverlay();
    }

    function handleSmsAvatarSubmit(event) {
      event?.preventDefault?.();
      if (!refs.smsAvatarInput && !refs.smsNicknameInput) {
        closeSmsSettingsOverlay();
        return;
      }
      if (refs.smsAvatarInput) {
        setPlayerAvatarUrl(refs.smsAvatarInput.value);
      }
      if (refs.smsNicknameInput) {
        setPlayerName(refs.smsNicknameInput.value);
      }
      closeSmsSettingsOverlay();
    }

    function handleSmsAvatarClear(event) {
      event?.preventDefault?.();
      setPlayerAvatarUrl('');
      if (refs.smsAvatarInput) {
        refs.smsAvatarInput.value = '';
      }
      closeSmsSettingsOverlay();
    }

    function handleSmsNicknameClear(event) {
      event?.preventDefault?.();
      setPlayerName('{{user}}');
      if (refs.smsNicknameInput) {
        refs.smsNicknameInput.value = '{{user}}';
      }
      // Do not close overlay to allow quick adjustments
    }

    // —— 短信设置内：联系人管理 ——
    function ensureContactManagerMounted() {
      if (!refs.smsSettingsOverlay) return;
      const dialog = refs.smsSettingsOverlay.querySelector('.sms-settings-dialog') || refs.smsSettingsOverlay;
      let root = dialog.querySelector('#contact-manager-root');
      if (!root) {
        root = document.createElement('section');
        root.id = 'contact-manager-root';
        root.className = 'contact-manager';
        root.innerHTML = `
          <div class="contact-header">
            <h4>联系人管理</h4>
            <button type="button" class="sms-avatar-btn sms-avatar-btn--secondary cm-add">添加</button>
          </div>
          <form class="sms-avatar-form contact-form" autocomplete="off">
            <label>角色原名（与剧情中出现的名字一致）
              <input id="cm-original" type="text" placeholder="如：张三" required />
            </label>
            <label>显示昵称（可选）
              <input id="cm-nickname" type="text" placeholder="如：老三/某某" />
            </label>
            <label>头像 URL（可选）
              <input id="cm-avatar" type="url" placeholder="http(s) 或 data:image/... 或相对路径" />
            </label>
            <div class="sms-avatar-actions">
              <button type="button" class="sms-avatar-btn sms-avatar-btn--secondary cm-cancel">取消</button>
              <button type="submit" class="sms-avatar-btn sms-avatar-btn--primary cm-save">保存</button>
            </div>
          </form>
          <ul class="contact-list" aria-live="polite"></ul>
        `;
        dialog.appendChild(root);

        // Cache refs
        refs.cmRoot = root;
        refs.cmList = root.querySelector('.contact-list');
        refs.cmForm = root.querySelector('.contact-form');
        refs.cmOriginal = root.querySelector('#cm-original');
        refs.cmNickname = root.querySelector('#cm-nickname');
        refs.cmAvatar = root.querySelector('#cm-avatar');
        refs.cmAdd = root.querySelector('.cm-add');
        refs.cmCancel = root.querySelector('.cm-cancel');
        refs.cmSave = root.querySelector('.cm-save');

        // Delegated events
        refs.cmAdd.addEventListener('click', () => openContactForm());
        refs.cmCancel.addEventListener('click', () => closeContactForm());
        refs.cmForm.addEventListener('submit', handleContactFormSubmit);
        refs.cmList.addEventListener('click', handleContactListClick);
      } else {
        // refresh refs if already mounted
        refs.cmRoot = root;
        refs.cmList = root.querySelector('.contact-list');
        refs.cmForm = root.querySelector('.contact-form');
        refs.cmOriginal = root.querySelector('#cm-original');
        refs.cmNickname = root.querySelector('#cm-nickname');
        refs.cmAvatar = root.querySelector('#cm-avatar');
        refs.cmAdd = root.querySelector('.cm-add');
        refs.cmCancel = root.querySelector('.cm-cancel');
        refs.cmSave = root.querySelector('.cm-save');
      }
    }

    function openContactForm(entry, index) {
      if (!refs.cmForm) return;
      refs.cmForm.classList.add('open');
      refs.cmForm.dataset.editingIndex = Number.isInteger(index) ? String(index) : '';
      const original = (entry?.original || '').trim();
      refs.cmOriginal.value = original;
      refs.cmOriginal.disabled = Number.isInteger(index); // 原名作为主键，编辑时不允许改
      refs.cmNickname.value = (entry?.nickname || '').trim();
      refs.cmAvatar.value = (entry?.avatar || '').trim();
      requestAnimationFrame(() => refs.cmOriginal?.focus());
    }
    function closeContactForm() {
      if (!refs.cmForm) return;
      refs.cmForm.classList.remove('open');
      refs.cmForm.dataset.editingIndex = '';
      if (refs.cmOriginal) refs.cmOriginal.disabled = false;
    }
    function handleContactFormSubmit(event) {
      event?.preventDefault?.();
      if (!refs.cmForm) return;
      const list = loadContactOverrides();
      const idx = refs.cmForm.dataset.editingIndex ? Number(refs.cmForm.dataset.editingIndex) : -1;
      const original = normalizeContactKey(refs.cmOriginal?.value || '');
      if (!original) {
        refs.cmOriginal?.focus();
        return;
      }
      const nickname = (refs.cmNickname?.value || '').trim().slice(0, 24);
      const avatar = sanitizeAvatarUrl(refs.cmAvatar?.value || '');
      if (idx >= 0 && idx < list.length) {
        list[idx] = { ...list[idx], original, nickname, avatar, enabled: true };
      } else {
        // 若已存在原名，覆盖该条
        const existIndex = list.findIndex(i => normalizeContactKey(i.original) === original);
        const entry = { original, nickname, avatar, enabled: true };
        if (existIndex >= 0) list[existIndex] = entry; else list.unshift(entry);
      }
      saveContactOverrides(list);
      renderContactOverridesList();
      // 重新渲染短信列表以应用覆盖
      if (refs.smsThread) {
        rebuildSMSThread(state.index);
      }
      closeContactForm();
    }
    function handleContactListClick(event) {
      const target = event.target;
      if (!(target instanceof Element)) return;
      const item = target.closest('.contact-item');
      if (!item || !refs.cmList) return;
      const index = Number(item.getAttribute('data-index'));
      const list = loadContactOverrides();
      if (target.classList.contains('cm-edit')) {
        const entry = list[index];
        if (!entry) return;
        openContactForm(entry, index);
        return;
      }
      if (target.classList.contains('cm-delete')) {
        const entry = list[index];
        if (!entry) return;
        const ok = confirm(`删除联系人“${entry.original}”的覆盖？`);
        if (!ok) return;
        list.splice(index, 1);
        saveContactOverrides(list);
        renderContactOverridesList();
        if (refs.smsThread) rebuildSMSThread(state.index);
        return;
      }
      if (target.classList.contains('cm-toggle')) {
        const entry = list[index];
        if (!entry) return;
        entry.enabled = entry.enabled === false ? true : false;
        saveContactOverrides(list);
        renderContactOverridesList();
        if (refs.smsThread) rebuildSMSThread(state.index);
      }
    }
    function renderContactOverridesList() {
      if (!refs.cmList) return;
      const list = loadContactOverrides();
      refs.cmList.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'contact-item';
        empty.innerHTML = '<div class="contact-name">暂无联系人覆盖，点击“添加”来创建。</div>';
        refs.cmList.appendChild(empty);
        return;
      }
      list.forEach((entry, index) => {
        const li = document.createElement('li');
        li.className = 'contact-item';
        li.setAttribute('data-index', String(index));
        const avatar = document.createElement('div');
        avatar.className = 'contact-avatar';
        if (entry.avatar) {
          const img = document.createElement('img');
          img.src = entry.avatar;
          img.alt = (entry.nickname || entry.original || '头像');
          avatar.appendChild(img);
        } else {
          avatar.textContent = deriveAvatarInitial(entry.nickname || entry.original, false);
        }
        const name = document.createElement('div');
        name.className = 'contact-name';
        const display = (entry.nickname || '').trim() ? `${entry.original} → ${entry.nickname}` : entry.original;
        name.textContent = display;
        const meta = document.createElement('div');
        meta.className = 'contact-meta';
        meta.textContent = entry.enabled === false ? '已禁用' : '已启用';
        const actions = document.createElement('div');
        actions.className = 'contact-actions';
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'cm-toggle';
        toggleBtn.textContent = entry.enabled === false ? '启用' : '禁用';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'cm-edit';
        editBtn.textContent = '编辑';
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'cm-delete';
        delBtn.textContent = '删除';
        actions.appendChild(toggleBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        li.appendChild(avatar);
        li.appendChild(name);
        li.appendChild(meta);
        li.appendChild(actions);
        refs.cmList.appendChild(li);
      });
    }

    function setPlayerName(value) {
      const sanitized = sanitizeNickname(value);
      if (sanitized === state.playerName) {
        localStorage.setItem(PLAYER_NAME_STORAGE_KEY, sanitized);
        return;
      }
      state.playerName = sanitized;
      localStorage.setItem(PLAYER_NAME_STORAGE_KEY, sanitized);
      applyPlayerNameToBubbles();
    }

    function applyPlayerNameToBubbles() {
      if (!refs.smsThread) return;
      const current = state.playerName || '{{user}}';
      // Update name labels on existing outgoing bubbles
      refs.smsThread.querySelectorAll('.sms-bubble.outgoing .name').forEach(el => {
        if (el instanceof HTMLElement) {
          el.textContent = current;
        }
      });
    }

    function setPlayerAvatarUrl(value) {
      const sanitized = sanitizeAvatarUrl(value);
      if (sanitized === state.playerAvatarUrl) {
        if (sanitized) {
          localStorage.setItem(PLAYER_AVATAR_STORAGE_KEY, sanitized);
        } else {
          localStorage.removeItem(PLAYER_AVATAR_STORAGE_KEY);
        }
        return;
      }
      state.playerAvatarUrl = sanitized;
      if (sanitized) {
        localStorage.setItem(PLAYER_AVATAR_STORAGE_KEY, sanitized);
      } else {
        localStorage.removeItem(PLAYER_AVATAR_STORAGE_KEY);
      }
      applyPlayerAvatarToBubbles();
    }

    function applyPlayerAvatarToBubbles() {
      if (!refs.smsThread) return;
      const avatarUrl = state.playerAvatarUrl;
      refs.smsThread.querySelectorAll('.sms-bubble.outgoing .avatar').forEach(avatar => {
        if (!(avatar instanceof HTMLElement)) return;
        const image = avatar.querySelector('img');
        if (avatarUrl) {
          if (image) {
            image.src = avatarUrl;
          } else {
            avatar.textContent = '';
            const newImage = document.createElement('img');
            newImage.src = avatarUrl;
            newImage.alt = '我的头像';
            avatar.appendChild(newImage);
          }
          avatar.classList.remove('avatar--empty');
        } else {
          if (image) {
            image.remove();
          }
          avatar.textContent = '';
          avatar.classList.add('avatar--empty');
        }
      });
    }

    function handleControlToggle(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      setControlBarExpanded(!state.controlBarExpanded);
    }

    function handleControlBarMediaChange(event) {
      const shouldExpand = Boolean(event?.matches);
      setControlBarExpanded(shouldExpand);
    }

    function setControlBarExpanded(expanded) {
      const nextValue = Boolean(expanded);
      state.controlBarExpanded = nextValue;
      if (!refs.controlBar) return;
      refs.controlBar.classList.toggle('control-bar--expanded', nextValue);
      if (refs.controlToggle) {
        refs.controlToggle.setAttribute('aria-expanded', nextValue ? 'true' : 'false');
        refs.controlToggle.setAttribute('title', nextValue ? '收起控制栏' : '展开控制栏');
      }
    }

    function applyCG(url) {
      if (!url) {
        refs.cg.classList.remove('visible');
        refs.cg.style.opacity = 0;
        delete refs.cg.dataset.src;
        refs.cg.removeAttribute('src');
        return;
      }
      swapImage(refs.cg, url, () => refs.cg.classList.add('visible'));
    }

    function applySprite(url, speaker) {
      if (!url) {
        refs.sprite.classList.remove('visible');
        return;
      }
      swapImage(refs.sprite, url, () => refs.sprite.classList.add('visible'));
    }

    function applyBackgroundFromScene(bgValue) {
      if (bgValue === null) {
        state.lastBackground = null;
        swapImage(refs.background, null);
        if (refs.backgroundFill) {
          refs.backgroundFill.style.backgroundImage = '';
        }
        return;
      }
      if (bgValue !== undefined) {
        state.lastBackground = bgValue;
      }
      const target = state.lastBackground;
      if (target !== undefined) {
        swapImage(refs.background, target);
        if (refs.backgroundFill) {
          refs.backgroundFill.style.backgroundImage = `url("${target}")`;
        }
      }
    }

    function applySpriteForScene(scene) {
      const spriteValue = scene.sprite;
      if (spriteValue === null) {
        state.lastSprite = null;
      } else if (spriteValue !== undefined) {
        state.lastSprite = spriteValue;
      }
      if (scene.cg) {
        hideSprite();
        return;
      }
      const target = state.lastSprite;
      if (!target) {
        applySprite(null, scene.speaker);
        return;
      }
      applySprite(target, scene.speaker);
    }

    function hideSprite() {
      applySprite(null);
    }

    function swapImage(img, src, after) {
      if (!src) {
        img.classList.remove('visible');
        img.style.opacity = 0;
        delete img.dataset.src;
        img.removeAttribute('src');
        return;
      }
      if (img.dataset.src === src) {
        img.classList.add('visible');
        after && after();
        return;
      }
      img.style.opacity = 0;
      const loader = new Image();
      loader.onload = () => {
        img.dataset.src = src;
        img.src = src;
        requestAnimationFrame(() => {
          img.classList.add('visible');
          img.style.opacity = 1;
          after && after();
        });
      };
      loader.src = src;
    }

    function setSpeaker(name) {
      const text = name || '';
      refs.name.textContent = text;
      if (!text) {
        refs.nameplate.classList.remove('visible');
      } else {
        refs.nameplate.classList.add('visible');
      }
    }

    function showPrompt() {
      refs.prompt.classList.add('show');
    }

    function hidePrompt() {
      refs.prompt.classList.remove('show');
    }

    function handleAdvance(event) {
      const target = event?.target;
      if (target instanceof Element) {
        if (target.closest('.sms-composer')) {
          return;
        }
        if (target.closest('#control-bar')) {
          return;
        }
        if (target.closest('#choice-overlay')) {
          return;
        }
        if (target.closest('.sms-voice-message')) {
          return;
        }
        if (target.closest('.sms-red-envelope')) {
          return;
        }
        if (target.closest('.sms-transfer-message')) {
          return;
        }
        if (target.closest('#sms-video-overlay')) {
          return;
        }
        // 视频界面中的控制按钮不触发跳过
        if (target.closest('.video-controls') || target.closest('.video-btn')) {
          return;
        }
      }
      if (isLeftHalfTap(event)) {
        goToPreviousScene();
        return;
      }
      if (state.awaitingChoice) {
        refs.choiceInput?.focus();
        return;
      }
      if (refs.container.classList.contains('sms-mode')) {
        if (state.manualSmsOpen) {
          return;
        }
        nextScene();
        return;
      }
      if (typewriter.isRunning) {
        typewriter.finish();
        showPrompt();
      } else {
        nextScene();
      }
    }

    function isLeftHalfTap(event) {
      if (!event) return false;
      const point = getPointerFromEvent(event);
      if (!point || typeof point.clientX !== 'number') return false;
      const source = (event.currentTarget instanceof Element)
        ? event.currentTarget
        : refs.dialogueBox;
      if (!source || !(source instanceof Element)) return false;
      const rect = source.getBoundingClientRect();
      if (!rect || !Number.isFinite(rect.width) || rect.width <= 0) return false;
      return point.clientX < rect.left + rect.width / 2;
    }

    function getPointerFromEvent(event) {
      if (!event) return null;
      if (event.touches && event.touches.length) return event.touches[0];
      if (event.changedTouches && event.changedTouches.length) return event.changedTouches[0];
      if (typeof event.clientX === 'number') return event;
      return null;
    }

    function jumpToSceneAt(targetIndex, options = {}) {
      if (!Array.isArray(scenes) || !Number.isInteger(targetIndex)) return;
      if (targetIndex < 0 || targetIndex >= scenes.length) return;
      const { closeHistory = false } = options;
      clearTimeout(state.autoTimer);
      state.autoTimer = null;
      if (state.awaitingChoice) {
        hideChoices();
      }
      typewriter.stop();
      hidePrompt();
      state.awaitingChoice = false;

      const context = buildSceneContext(targetIndex);
      state.lastBackground = context.background;
      state.lastSprite = context.sprite;
      rebuildSMSThread(targetIndex);

      loadScene(targetIndex, { instant: true, skipAuto: true, skipSMSAppend: true });
      if (scenes[targetIndex]?.mode === 'sms') {
        requestAnimationFrame(() => {
          refs.smsThread && (refs.smsThread.scrollTop = refs.smsThread.scrollHeight);
        });
      }
      if (closeHistory) {
        refs.historyPanel?.classList.remove('panel-open');
      }
    }

    function nextScene() {
      hidePrompt();
      clearTimeout(state.autoTimer);
      state.autoTimer = null;
      const nextIndex = state.index + 1;
      if (nextIndex >= scenes.length) {
        state.awaitingChoice = true;
        showChoices();
        if (!Array.isArray(state.choices) || state.choices.length === 0) {
          setAutoMode(false);
        }
        return;
      }
      loadScene(nextIndex);
    }

    function goToPreviousScene() {
      if (!Array.isArray(scenes) || state.index <= 0) return;
      jumpToSceneAt(state.index - 1);
    }

    function jumpToFinalScene() {
      if (!Array.isArray(scenes) || scenes.length === 0) return;
      const lastIndex = scenes.length - 1;
      if (lastIndex < 0) return;
      const alreadyAtEnd = state.index === lastIndex && !typewriter.isRunning;
      clearTimeout(state.autoTimer);
      state.autoTimer = null;
      if (state.awaitingChoice) {
        hideChoices();
      }
      if (alreadyAtEnd) {
        refs.smsThread && (refs.smsThread.scrollTop = refs.smsThread.scrollHeight);
        return;
      }
      jumpToSceneAt(lastIndex);
      if (typewriter.isRunning) {
        typewriter.finish();
      }
      refs.smsThread && (refs.smsThread.scrollTop = refs.smsThread.scrollHeight);
    }

    function buildSceneContext(targetIndex) {
      const context = {
        background: undefined,
        sprite: undefined
      };
      for (let i = 0; i <= targetIndex; i += 1) {
        const scene = scenes[i];
        if (!scene) continue;
        if (scene.bg === null) {
          context.background = null;
        } else if (scene.bg !== undefined) {
          context.background = scene.bg;
        }
        if (scene.sprite === null) {
          context.sprite = null;
        } else if (scene.sprite !== undefined) {
          context.sprite = scene.sprite;
        }
      }
      return context;
    }

    function rebuildSMSThread(targetIndex) {
      if (!refs.smsThread) return;
      refs.smsThread.innerHTML = '';
      let lastSpeaker = '';
      let lastContact = '';
      for (let i = 0; i <= targetIndex; i += 1) {
        const scene = scenes[i];
        if (scene && scene.mode === 'sms') {
          appendSMSBubble(scene);
          const speaker = (scene.speaker || '').trim();
          if (speaker) {
            lastSpeaker = speaker;
            if (!isPlayerSpeaker(speaker) && speaker !== '旁白') {
              lastContact = speaker;
            }
          }
        }
      }
      if (refs.smsContact) {
        const raw = lastContact || lastSpeaker || '';
        const resolved = raw ? resolveContactDisplay(raw, '') : { displayName: raw };
        refs.smsContact.textContent = resolved.displayName || raw;
      }
    }

    function scheduleAutoAdvance() {
      clearTimeout(state.autoTimer);
      const seconds = clamp(Number(settings.autoPauseSeconds) || DEFAULT_SETTINGS.autoPauseSeconds, 0, 10);
      settings.autoPauseSeconds = seconds;
      state.autoTimer = setTimeout(() => nextScene(), seconds * 1000);
    }

    function togglePanel(panel) {
      const isOpen = panel.classList.contains('panel-open');
      [refs.settingsPanel, refs.historyPanel, refs.cgPanel].forEach(p => p.classList.remove('panel-open'));
      if (!isOpen) panel.classList.add('panel-open');
    }

    function handleAutoToggle() {
      setAutoMode(!state.auto);
    }

    function setAutoMode(enabled) {
      const nextValue = Boolean(enabled);
      state.auto = nextValue;
      localStorage.setItem('vn.autoEnabled', nextValue ? 'true' : 'false');
      if (!nextValue) {
        clearTimeout(state.autoTimer);
        state.autoTimer = null;
      } else if (!typewriter.isRunning) {
        scheduleAutoAdvance();
      }
      updateAutoToggleUI();
    }

    function updateAutoToggleUI() {
      if (!refs.autoToggleBtn) return;
      const isAuto = Boolean(state.auto);
      refs.autoToggleBtn.classList.toggle('active', isAuto);
      const label = `自动播放：${isAuto ? '开启' : '关闭'}`;
      refs.autoToggleBtn.setAttribute('aria-pressed', isAuto ? 'true' : 'false');
      refs.autoToggleBtn.setAttribute('title', label);
      refs.autoToggleBtn.setAttribute('aria-label', label);
    }

    function setAspectMode(isDesktop) {
      state.desktopMode = Boolean(isDesktop);
      if (!refs.container) return;
      refs.container.classList.toggle('desktop-mode', state.desktopMode);
      const storedValue = state.desktopMode ? 'desktop' : 'mobile';
      if (localStorage.getItem('vn.aspectMode') !== storedValue) {
        localStorage.setItem('vn.aspectMode', storedValue);
      }
    }

    function toggleAspect() {
      setAspectMode(!state.desktopMode);
    }

    function handleSMSButtonClick(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      if (!refs.container) return;
      if (refs.container.classList.contains('sms-mode') && !state.manualSmsOpen) {
        return;
      }
      if (state.manualSmsOpen) {
        closeSMSPanel();
      } else {
        openManualSMSPanel();
      }
    }

    function openManualSMSPanel() {
      if (!refs.container) return;
      setManualSMSOpen(true);
      refs.container.classList.add('sms-mode');
      setControlBarExpanded(false);
      [refs.settingsPanel, refs.historyPanel, refs.cgPanel].forEach(panel => {
        panel?.classList?.remove('panel-open');
      });
      rebuildSMSThread(state.index);
      requestAnimationFrame(() => {
        refs.smsThread && (refs.smsThread.scrollTop = refs.smsThread.scrollHeight);
      });
    }

    function setManualSMSOpen(enabled) {
      const active = Boolean(enabled);
      state.manualSmsOpen = active;
      if (refs.smsBtn) {
        refs.smsBtn.classList.toggle('active', active);
        refs.smsBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
      }
    }

    function closeSMSPanel() {
      setManualSMSOpen(false);
      refs.container.classList.remove('sms-mode');
      setSmsActionMenuOpen(false);
      const fallbackExpanded = state.controlBarMediaQuery?.matches ?? true;
      setControlBarExpanded(fallbackExpanded);
    }

    // 视频通话交互
    function handleVideoHangup(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      // 停止视频气泡的打字
      typewriter.stop();
      // 关闭用户小预览并重置摄像头按钮状态
      hideUserPreview();
      if (refs.videoCamBtn) refs.videoCamBtn.setAttribute('aria-pressed', 'false');
      refs.container.classList.remove('video-mode');
      if (refs.videoPanel) {
        refs.videoPanel.setAttribute('aria-hidden', 'true');
      }
      if (refs.videoBubble) {
        refs.videoBubble.textContent = '';
        refs.videoBubble.style.display = 'none';
      }
      const fallbackExpanded = state.controlBarMediaQuery?.matches ?? true;
      setControlBarExpanded(fallbackExpanded);
      nextScene();
    }

    function toggleVideoMic() {
      if (!refs.videoMicBtn) return;
      const pressed = refs.videoMicBtn.getAttribute('aria-pressed') === 'true';
      refs.videoMicBtn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
    }

    function toggleVideoCam() {
      if (!refs.videoCamBtn) return;
      const pressed = refs.videoCamBtn.getAttribute('aria-pressed') === 'true';
      const next = !pressed;
      refs.videoCamBtn.setAttribute('aria-pressed', next ? 'true' : 'false');
      if (next) {
        showUserPreview();
      } else {
        hideUserPreview();
      }
    }

    // —— 用户小预览（左上角） ——
    function showUserPreview() {
      state.userPreview.visible = true;
      if (!refs.videoUserPreview) return;
      refs.videoUserPreview.classList.add('show');
      recalcVideoUserPreviewSize();
      if (Array.isArray(state.userPreview.images) && state.userPreview.images.length > 0) {
        applyUserPreviewImageSmooth(state.userPreview.images[state.userPreview.index] || state.userPreview.images[0]);
        startUserPreviewRotation();
      } else {
        refs.videoUserPreview.classList.remove('has-image');
        refs.videoUserPreview.style.backgroundImage = 'none';
      }
    }

    function hideUserPreview() {
      state.userPreview.visible = false;
      stopUserPreviewRotation();
      if (!refs.videoUserPreview) return;
      refs.videoUserPreview.classList.remove('show');
    }

    function recalcVideoUserPreviewSize() {
      if (!refs.videoUserPreview || !refs.videoPanel) return;
      const rect = refs.videoPanel.getBoundingClientRect();
      const preferred = rect?.width ? rect.width * 0.28 : window.innerWidth * 0.28; // 约 28% 面板宽度
      const width = Math.min(Math.max(Math.round(preferred), 0), 260);
      refs.videoUserPreview.style.width = `${width}px`;
    }

    // 预加载用户头像，减少切换时的空白
    function preloadUserImage(url) {
      return new Promise((resolve) => {
        if (!url) { resolve(); return; }
        const cache = state.userPreview.cache || (state.userPreview.cache = {});
        const rec = cache[url];
        if (rec && rec.loaded) { resolve(rec.img); return; }
        const img = new Image();
        img.onload = () => { cache[url] = { loaded: true, img }; resolve(img); };
        img.onerror = () => { cache[url] = { loaded: false, img: null }; resolve(); };
        cache[url] = { loaded: false, img };
        img.src = url;
      });
    }

    function preloadUserImages(urls) {
      const list = Array.isArray(urls) ? urls : [];
      list.forEach(u => { if (u) preloadUserImage(u); });
    }

    function applyUserPreviewImageSmooth(url) {
      if (!refs.videoUserPreview) return;
      if (typeof url === 'string' && url) {
        const targetUrl = url;
        preloadUserImage(targetUrl).then(() => {
          state.userPreview.currentUrl = targetUrl;
          refs.videoUserPreview.style.backgroundImage = `url("${targetUrl.replace(/"/g, '\\"')}")`;
          refs.videoUserPreview.classList.add('has-image');
        });
      } else {
        refs.videoUserPreview.style.backgroundImage = 'none';
        refs.videoUserPreview.classList.remove('has-image');
        state.userPreview.currentUrl = '';
      }
    }

    function applyUserPreviewImage(url) {
      if (!refs.videoUserPreview) return;
      if (typeof url === 'string' && url) {
        refs.videoUserPreview.style.backgroundImage = `url("${url.replace(/"/g, '\\"')}")`;
        refs.videoUserPreview.classList.add('has-image');
      } else {
        refs.videoUserPreview.style.backgroundImage = 'none';
        refs.videoUserPreview.classList.remove('has-image');
      }
    }

    function startUserPreviewRotation() {
      stopUserPreviewRotation();
      const list = state.userPreview.images || [];
      if (!Array.isArray(list) || list.length <= 1) return; // 单张不轮播
      state.userPreview.timer = setInterval(() => {
        const n = state.userPreview.images?.length || 0;
        if (n === 0) return;
        state.userPreview.index = (state.userPreview.index + 1) % n;
        applyUserPreviewImageSmooth(state.userPreview.images[state.userPreview.index]);
      }, state.userPreview.intervalMs || 3000);
    }

    function stopUserPreviewRotation() {
      if (state.userPreview.timer) {
        clearInterval(state.userPreview.timer);
        state.userPreview.timer = null;
      }
    }

    function setUserPreviewImages(urls) {
      const list = Array.isArray(urls) ? urls : [];
      const cleaned = list
        .map(u => (typeof u === 'string' ? u.trim() : ''))
        .filter(Boolean)
        .filter(u => /^(https?:)?\/\//i.test(u) || /^data:image\//i.test(u) || /^(\.{0,2}\/|\/)/.test(u));
      try { localStorage.setItem(VIDEO_USER_IMAGES_KEY, JSON.stringify(cleaned)); } catch {}
      preloadUserImages(cleaned);
      state.userPreview.images = cleaned;
      state.userPreview.index = 0;
      if (state.userPreview.visible) {
        if (cleaned.length > 0) {
          applyUserPreviewImageSmooth(cleaned[0]);
          startUserPreviewRotation();
        } else {
          stopUserPreviewRotation();
          applyUserPreviewImageSmooth('');
        }
      }
    }

    // —— 视频头像设置弹窗 ——
    function openVideoUserOverlay() {
      if (!refs.videoUserOverlay || !refs.videoUserForm) return;
      state.videoUserComposer.open = true;
      // 预填当前数据
      if (refs.videoUserTextarea) {
        const lines = (state.userPreview.images || []).join('\n');
        refs.videoUserTextarea.value = lines;
      }
      if (refs.videoUserInterval) {
        const sec = Math.max(1, Math.round((state.userPreview.intervalMs || 3000) / 1000));
        refs.videoUserInterval.value = String(sec);
      }
      refs.videoUserOverlay.classList.add('open');
      refs.videoUserOverlay.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', handleVideoUserEscape, true);
      requestAnimationFrame(() => refs.videoUserTextarea?.focus());
    }

    function closeVideoUserOverlay() {
      if (!state.videoUserComposer.open) return;
      state.videoUserComposer.open = false;
      if (refs.videoUserOverlay) {
        refs.videoUserOverlay.classList.remove('open');
        refs.videoUserOverlay.setAttribute('aria-hidden', 'true');
      }
      document.removeEventListener('keydown', handleVideoUserEscape, true);
    }

    async function handleVideoUserSubmit(event) {
      event?.preventDefault?.();
      if (!state.videoUserComposer.open) return;
      const raw = (refs.videoUserTextarea?.value || '').trim();
      const urls = raw ? raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean) : [];
      setUserPreviewImages(urls);
      const secInput = (refs.videoUserInterval?.value || '').trim();
      const sec = Number(secInput);
      if (!Number.isNaN(sec) && sec >= 1 && sec <= 60) {
        state.userPreview.intervalMs = Math.round(sec * 1000);
        try { localStorage.setItem(VIDEO_USER_INTERVAL_KEY, String(state.userPreview.intervalMs)); } catch {}
        if (state.userPreview.visible) startUserPreviewRotation();
      }
      closeVideoUserOverlay();
      // 若当前预览可见且设置了图片，立即应用
      if (state.userPreview.visible && state.userPreview.images.length > 0) {
        applyUserPreviewImageSmooth(state.userPreview.images[0]);
        startUserPreviewRotation();
      }
    }

    function handleVideoUserClear(event) {
      event?.preventDefault?.();
      // 清空内存列表
      state.userPreview.images = [];
      state.userPreview.index = 0;
      try { localStorage.setItem(VIDEO_USER_IMAGES_KEY, JSON.stringify([])); } catch {}
      // 立即停止轮播并清空预览
      stopUserPreviewRotation();
      applyUserPreviewImageSmooth('');
      // 清空表单输入
      if (refs.videoUserTextarea) refs.videoUserTextarea.value = '';
    }

    function handleVideoUserCancel(event) {
      event?.preventDefault?.();
      event?.stopPropagation?.();
      closeVideoUserOverlay();
    }

    function handleVideoUserOverlayBackdrop(event) {
      if (event.target === refs.videoUserOverlay) {
        event?.stopPropagation?.();
        closeVideoUserOverlay();
      }
    }

    function handleVideoUserEscape(event) {
      if (event.key !== 'Escape') return;
      event.preventDefault();
      event.stopPropagation();
      closeVideoUserOverlay();
    }

    function updateHistory() {
      if (!Array.isArray(scenes) || state.index < 0) return;
      const items = [];
      for (let i = 0; i <= state.index && i < scenes.length; i += 1) {
        const scene = scenes[i];
        if (!scene || !scene.text) continue;
        items.push({
          speaker: scene.speaker,
          text: scene.text,
          index: i
        });
      }
      state.history = items;
      renderHistory();
    }

    function renderHistory() {
      if (!refs.historyList) return;
      refs.historyList.innerHTML = state.history.map(item => {
        const speaker = item.speaker || '旁白';
        const text = item.text || '';
        const targetIndex = typeof item.index === 'number' ? item.index : -1;
        const isCurrent = targetIndex === state.index;
        const ariaLabel = targetIndex >= 0 ? `跳转到第${targetIndex + 1}句` : '跳转到此句';
        return `
        <li class="history-item${isCurrent ? ' current' : ''}">
          <button type="button" class="history-jump" data-index="${targetIndex}" aria-label="${ariaLabel}"></button>
          <div class="history-content">
            <div class="history-speaker"><strong>${speaker}</strong></div>
            <div class="history-text">${text}</div>
          </div>
        </li>
      `;
      }).join('');
    }

    function handleHistoryClick(event) {
      const target = event?.target;
      if (!(target instanceof Element)) return;
      const button = target.closest('.history-jump');
      if (!button || !refs.historyList?.contains(button)) return;
      event.preventDefault();
      const targetIndex = Number.parseInt(button.dataset.index || '', 10);
      if (!Number.isInteger(targetIndex) || targetIndex < 0) return;
      jumpToSceneAt(targetIndex, { closeHistory: true });
    }

    function showChoices() {
      if (!refs.choiceOverlay || !refs.choiceList) return;
      const hasPreset = Array.isArray(state.choices) && state.choices.length > 0;
      refs.choiceList.innerHTML = '';
      if (hasPreset) {
        state.choices.forEach(choice => {
          const item = document.createElement('li');
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'choice-button';
          button.textContent = choice;
          button.addEventListener('click', () => commitChoice(choice));
          item.appendChild(button);
          refs.choiceList.appendChild(item);
        });
      }
      refs.choiceOverlay.classList.toggle('choice-overlay--custom-only', !hasPreset);
      refs.choiceOverlay.classList.add('choice-overlay--show');
      if (refs.choiceInput) {
        refs.choiceInput.value = '';
        refs.choiceInput.classList.remove('error');
        requestAnimationFrame(() => refs.choiceInput?.focus());
      }
    }

    function hideChoices() {
      refs.choiceOverlay?.classList.remove('choice-overlay--show');
      refs.choiceOverlay?.classList.remove('choice-overlay--custom-only');
      if (refs.choiceList) {
        refs.choiceList.innerHTML = '';
      }
      if (refs.choiceInput) {
        refs.choiceInput.value = '';
        refs.choiceInput.classList.remove('error');
      }
      state.awaitingChoice = false;
    }

    function handleChoiceSubmit(event) {
      event.preventDefault();
      const value = refs.choiceInput?.value ?? '';
      commitChoice(value);
    }

    function handleChoiceSend(event) {
      event.preventDefault();
      const value = refs.choiceInput?.value ?? '';
      commitChoice(value);
    }

    function handleChoiceClose(event) {
      event.preventDefault();
      event.stopPropagation();
      hideChoices();
    }

    // 点击遮罩空白处关闭回复面板
    function handleChoiceOverlayBackdropClick(event) {
      // 只有点到遮罩本身（而非面板内元素）才关闭
      if (event?.target === refs.choiceOverlay) {
        event.preventDefault();
        hideChoices();
      }
    }

    function commitChoice(raw) {
      const text = (raw || '').trim();
      if (!text) {
        if (refs.choiceInput) {
          refs.choiceInput.classList.add('error');
          refs.choiceInput.focus();
          setTimeout(() => refs.choiceInput?.classList.remove('error'), 320);
        }
        return;
      }
      // 将“已发送短信”与最终回复一并发送（不包含输入框草稿）
      let payload = text;
      if (Array.isArray(state.pendingSmsMessages) && state.pendingSmsMessages.length > 0) {
        // 这里默认包含旁白聚合项；如需排除可传 includeNarration: false
        const combined = buildPendingSmsCombinedText({ includeNarration: true });
        if (combined) {
          payload = `${combined}\n${text}`;
        }
        // 清空以避免重复再次发送
        state.pendingSmsMessages = [];
      }
      sendChoice(payload);
      hideChoices();
    }

    function sendChoice(text) {
      const command = `/send ${text}|/trigger`;
      if (typeof window.triggerSlash === 'function') {
        window.triggerSlash(command);
      } else {
        console.log('发送指令:', command);
      }
    }

    function unlockCG(url, note) {
      if (!url || state.unlockedCG.has(url)) return;
      state.unlockedCG.add(url);
      localStorage.setItem('vn.cgUnlocked', JSON.stringify(Array.from(state.unlockedCG)));
      renderCGGallery();
    }

    function getUnlockedCGItems() {
      return Array.from(state.unlockedCG);
    }

    function renderCGGallery() {
      if (!refs.cgList) return;
      const items = getUnlockedCGItems();
      if (!items.length) {
        refs.cgList.innerHTML = '<li>没有图片 CG</li>';
        syncCGOverlayAfterRender();
        return;
      }
      refs.cgList.innerHTML = items.map((src, idx) => `
        <li>
          <button type="button" class="cg-thumb" data-index="${idx}" aria-label="查看第 ${idx + 1} 张 CG">
            <img src="${src}" alt="CG 缩略图">
          </button>
          <span>${src.split('/').pop()}</span>
        </li>
      `).join('');
      syncCGOverlayAfterRender();
    }

    function syncCGOverlayAfterRender() {
      if (!state.cgOverlayOpen) return;
      const items = getUnlockedCGItems();
      if (!items.length) {
        closeCGOverlay();
        return;
      }
      state.cgOverlayIndex = clamp(state.cgOverlayIndex, 0, items.length - 1);
      updateCGOverlayUI();
    }

    function handleCGThumbClick(event) {
      const target = event.target.closest('.cg-thumb');
      if (!target || !refs.cgList?.contains(target)) return;
      const index = Number(target.dataset.index);
      if (!Number.isFinite(index)) return;
      openCGOverlay(index);
    }

    function handleCGOverlayBackdropClick(event) {
      if (!state.cgOverlayOpen) return;
      if (event.target === refs.cgOverlay) {
        closeCGOverlay();
      }
    }

    function openCGOverlay(targetIndex = 0) {
      const items = getUnlockedCGItems();
      if (!items.length) return;
      const index = clamp(Number(targetIndex) || 0, 0, items.length - 1);
      state.cgOverlayIndex = index;
      if (!state.cgOverlayOpen) {
        state.cgOverlayOpen = true;
        refs.cgOverlay?.classList.add('cg-overlay--open');
        refs.cgOverlay?.setAttribute('aria-hidden', 'false');
        document.body?.classList.add('no-scroll');
        document.addEventListener('keydown', handleCGOverlayKeydown);
      }
      updateCGOverlayUI();
    }

    function closeCGOverlay() {
      if (!state.cgOverlayOpen) return;
      state.cgOverlayOpen = false;
      refs.cgOverlay?.classList.remove('cg-overlay--open');
      refs.cgOverlay?.setAttribute('aria-hidden', 'true');
      document.body?.classList.remove('no-scroll');
      document.removeEventListener('keydown', handleCGOverlayKeydown);
    }

    function stepCGOverlay(offset) {
      if (!state.cgOverlayOpen) return;
      const items = getUnlockedCGItems();
      if (!items.length) {
        closeCGOverlay();
        return;
      }
      const nextIndex = clamp(state.cgOverlayIndex + Number(offset || 0), 0, items.length - 1);
      if (nextIndex === state.cgOverlayIndex) return;
      state.cgOverlayIndex = nextIndex;
      updateCGOverlayUI();
    }

    function updateCGOverlayUI() {
      if (!state.cgOverlayOpen) return;
      const items = getUnlockedCGItems();
      if (!items.length) {
        closeCGOverlay();
        return;
      }
      const index = clamp(state.cgOverlayIndex, 0, items.length - 1);
      state.cgOverlayIndex = index;
      const current = items[index];
      if (refs.cgOverlayImage) {
        refs.cgOverlayImage.src = current;
        const name = current.split('/').pop() || 'CG';
        refs.cgOverlayImage.alt = `CG 预览：${name}`;
      }
      if (refs.cgOverlayPrev) {
        refs.cgOverlayPrev.disabled = index === 0;
      }
      if (refs.cgOverlayNext) {
        refs.cgOverlayNext.disabled = index >= items.length - 1;
      }
      refs.cgOverlay?.setAttribute('aria-hidden', 'false');
    }

    function handleCGOverlayKeydown(event) {
      if (!state.cgOverlayOpen) return;
      if (event.key === 'Escape') {
        event.preventDefault();
        closeCGOverlay();
        return;
      }
      if (event.key === 'ArrowLeft') {
        event.preventDefault();
        stepCGOverlay(-1);
        return;
      }
      if (event.key === 'ArrowRight') {
        event.preventDefault();
        stepCGOverlay(1);
      }
    }

    function handleTypingSlider(event) {
      const value = clamp(toNumber(event.target.value, DEFAULT_SETTINGS.typeSpeedValue), 0, 100);
      settings.typeSpeedValue = value;
      event.target.value = value;
      localStorage.setItem('vn.typeSpeedValue', value);
      const delay = mapSliderToDelay(value);
      typewriter.setSpeed(delay);
      refs.typingLabel.textContent = describeSpeed(value);
    }

    function handleFontInput(event) {
      const input = event.target;
      const raw = toNumber(input.value, settings.fontSize ?? DEFAULT_SETTINGS.fontSize);
      const value = clamp(Math.round(raw), 12, 64);
      settings.fontSize = value;
      input.value = value;
      localStorage.setItem('vn.fontSize', value);
      document.documentElement.style.setProperty('--dialogue-font-size', `${value}px`);
      recalcSMSAvatarAlignments();
    }

    function handleDialogueColor(event) {
      const value = normalizeHexColor(event.target.value, settings.dialogueTextColor);
      settings.dialogueTextColor = value;
      event.target.value = value;
      localStorage.setItem('vn.dialogueTextColor', value);
      document.documentElement.style.setProperty('--dialogue-text-color', value);
    }

    function handleDialogueBgColor(event) {
      const format = event.target.dataset.format || 'rgb';
      const value = normalizeColorValue(event.target.value, settings.dialogueBgColor, format);
      settings.dialogueBgColor = value;
      event.target.value = value;
      localStorage.setItem('vn.dialogueBgColor', value);
      updateDialogueBackground();
    }

    function handlePanelTextColor(event) {
      const value = normalizeHexColor(event.target.value, settings.panelTextColor);
      settings.panelTextColor = value;
      event.target.value = value;
      localStorage.setItem('vn.panelTextColor', value);
      document.documentElement.style.setProperty('--panel-text-color', value);
    }

    function handlePanelBgColor(event) {
      const format = event.target.dataset.format || 'rgb';
      const value = normalizeColorValue(event.target.value, settings.panelBgColor, format);
      settings.panelBgColor = value;
      event.target.value = value;
      localStorage.setItem('vn.panelBgColor', value);
      updatePanelBackground();
    }

    function handleControlIconColor(event) {
      const value = normalizeHexColor(event.target.value, settings.controlIconColor);
      settings.controlIconColor = value;
      event.target.value = value;
      localStorage.setItem('vn.controlIconColor', value);
      updateControlIconStyles();
    }

    function handleControlIconBgColor(event) {
      const format = event.target.dataset.format || 'rgb';
      const value = normalizeColorValue(event.target.value, settings.controlIconBgColor, format);
      settings.controlIconBgColor = value;
      event.target.value = value;
      localStorage.setItem('vn.controlIconBgColor', value);
      updateControlIconStyles();
    }

    function handleControlSizeChange(event) {
      const raw = toNumber(event.target.value, settings.controlButtonSize ?? DEFAULT_SETTINGS.controlButtonSize);
      const value = clamp(Math.round(raw), 32, 80);
      settings.controlButtonSize = value;
      event.target.value = value;
      localStorage.setItem('vn.controlButtonSize', value);
      updateControlButtonSize();
    }

    function handleDialogueBlurChange(event) {
      const raw = toNumber(event.target.value, settings.dialogueBlur ?? DEFAULT_SETTINGS.dialogueBlur);
      const value = clamp(Math.round(raw), 0, 100);
      settings.dialogueBlur = value;
      event.target.value = value;
      localStorage.setItem('vn.dialogueBlur', value);
      updateDialogueBlur();
    }

    function handlePanelBlurChange(event) {
      const raw = toNumber(event.target.value, settings.panelBlur ?? DEFAULT_SETTINGS.panelBlur);
      const value = clamp(Math.round(raw), 0, 100);
      settings.panelBlur = value;
      event.target.value = value;
      localStorage.setItem('vn.panelBlur', value);
      updatePanelBlur();
    }

    function handleAutoPauseChange(event) {
      const input = event.target;
      const numeric = Number(input.value);
      const value = clamp(Number.isFinite(numeric) ? numeric : settings.autoPauseSeconds, 0, 10);
      settings.autoPauseSeconds = Number(value.toFixed(2));
      input.value = settings.autoPauseSeconds;
      localStorage.setItem('vn.autoPauseSeconds', settings.autoPauseSeconds);
      if (state.auto) {
        scheduleAutoAdvance();
      }
    }

    function applySettings() {
      const speed = clamp(Number(settings.typeSpeedValue) || DEFAULT_SETTINGS.typeSpeedValue, 0, 100);
      settings.typeSpeedValue = speed;
      refs.typingSlider.value = speed;
      refs.typingLabel.textContent = describeSpeed(speed);
      typewriter.setSpeed(mapSliderToDelay(speed));

      const fontSize = clamp(Math.round(Number(settings.fontSize) || DEFAULT_SETTINGS.fontSize), 12, 64);
      settings.fontSize = fontSize;
      refs.fontInput.value = fontSize;
      document.documentElement.style.setProperty('--dialogue-font-size', `${fontSize}px`);
      recalcSMSAvatarAlignments();

      settings.dialogueTextColor = normalizeHexColor(settings.dialogueTextColor, DEFAULT_SETTINGS.dialogueTextColor);
      refs.dialogueColor.value = settings.dialogueTextColor;
      document.documentElement.style.setProperty('--dialogue-text-color', settings.dialogueTextColor);

      settings.dialogueBgColor = normalizeRgbaColor(settings.dialogueBgColor, DEFAULT_SETTINGS.dialogueBgColor);
      refs.dialogueBgColor.value = settings.dialogueBgColor;
      updateDialogueBackground();

      settings.panelTextColor = normalizeHexColor(settings.panelTextColor, DEFAULT_SETTINGS.panelTextColor);
      refs.panelColor.value = settings.panelTextColor;
      document.documentElement.style.setProperty('--panel-text-color', settings.panelTextColor);

      settings.panelBgColor = normalizeRgbaColor(settings.panelBgColor, DEFAULT_SETTINGS.panelBgColor);
      refs.panelBgColor.value = settings.panelBgColor;
      updatePanelBackground();

      settings.controlIconColor = normalizeHexColor(settings.controlIconColor, DEFAULT_SETTINGS.controlIconColor);
      refs.controlIconColor.value = settings.controlIconColor;
      settings.controlIconBgColor = normalizeRgbaColor(settings.controlIconBgColor, DEFAULT_SETTINGS.controlIconBgColor);
      refs.controlIconBgColor.value = settings.controlIconBgColor;
      updateControlIconStyles();
      updateControlButtonSize();
      updateDialogueBlur();
      updatePanelBlur();

      const autoPause = clamp(Number(settings.autoPauseSeconds) || DEFAULT_SETTINGS.autoPauseSeconds, 0, 10);
      settings.autoPauseSeconds = Number(autoPause.toFixed(2));
      refs.autoWaitInput.value = settings.autoPauseSeconds;
    }

    function resetSettings() {
      [
        'vn.typeSpeedValue',
        'vn.fontSize',
        'vn.dialogueTextColor',
        'vn.dialogueBgColor',
        'vn.dialogueBgOpacity',
        'vn.panelTextColor',
        'vn.panelBgColor',
        'vn.panelBgOpacity',
        'vn.controlIconColor',
        'vn.controlIconBgColor',
        'vn.controlIconBgOpacity',
        'vn.controlButtonSize',
        'vn.dialogueBlur',
        'vn.panelBlur',
        'vn.autoPauseSeconds',
        'vn.aspectMode',
        'vn.autoEnabled',
        'vn.smsPlayerName'
      ].forEach(key => localStorage.removeItem(key));
      Object.assign(settings, DEFAULT_SETTINGS);
      applySettings();
      setAutoMode(false);
      localStorage.removeItem('vn.autoEnabled');
      state.desktopMode = false;
      refs.container?.classList.remove('desktop-mode');
      // Reset nickname to default and refresh UI
      state.playerName = '{{user}}';
      applyPlayerNameToBubbles();
    }

    function updateDialogueBackground() {
      const color = normalizeRgbaColor(settings.dialogueBgColor, DEFAULT_SETTINGS.dialogueBgColor);
      settings.dialogueBgColor = color;
      document.documentElement.style.setProperty('--dialogue-background', color);
    }

    function updatePanelBackground() {
      const color = normalizeRgbaColor(settings.panelBgColor, DEFAULT_SETTINGS.panelBgColor);
      settings.panelBgColor = color;
      document.documentElement.style.setProperty('--panel-bg', color);
    }

    function updateControlIconStyles() {
      // 将用户选择的颜色转成 CSS 变量，按钮即时响应
      const iconColor = normalizeHexColor(settings.controlIconColor, DEFAULT_SETTINGS.controlIconColor);
      document.documentElement.style.setProperty('--control-icon-color', iconColor);
      const bgColor = normalizeRgbaColor(settings.controlIconBgColor, DEFAULT_SETTINGS.controlIconBgColor);
      settings.controlIconBgColor = bgColor;
      document.documentElement.style.setProperty('--control-icon-bg', bgColor);
    }

    function updateControlButtonSize() {
      const numeric = toNumber(settings.controlButtonSize, DEFAULT_SETTINGS.controlButtonSize);
      const size = clamp(Math.round(numeric), 32, 80);
      settings.controlButtonSize = size;
      document.documentElement.style.setProperty('--control-button-size', `${size}px`);
      const svgSize = Math.max(16, Math.round(size * 0.5));
      document.documentElement.style.setProperty('--control-icon-svg-size', `${svgSize}px`);
      if (refs.controlSizeInput) {
        refs.controlSizeInput.value = size;
      }
      if (refs.controlSizeLabel) {
        refs.controlSizeLabel.textContent = `${size}px`;
      }
    }

    function updateDialogueBlur() {
      const numeric = toNumber(settings.dialogueBlur, DEFAULT_SETTINGS.dialogueBlur);
      const value = clamp(Math.round(numeric), 0, 100);
      settings.dialogueBlur = value;
      document.documentElement.style.setProperty('--dialogue-blur', `${value}px`);
      if (refs.dialogueBlurInput) {
        refs.dialogueBlurInput.value = value;
      }
      if (refs.dialogueBlurLabel) {
        refs.dialogueBlurLabel.textContent = `${value}px`;
      }
    }

    function updatePanelBlur() {
      const numeric = toNumber(settings.panelBlur, DEFAULT_SETTINGS.panelBlur);
      const value = clamp(Math.round(numeric), 0, 100);
      settings.panelBlur = value;
      document.documentElement.style.setProperty('--panel-blur', `${value}px`);
      const strong = value > 0 ? value + 2 : 0;
      document.documentElement.style.setProperty('--panel-blur-strong', `${strong}px`);
      if (refs.panelBlurInput) {
        refs.panelBlurInput.value = value;
      }
      if (refs.panelBlurLabel) {
        refs.panelBlurLabel.textContent = `${value}px`;
      }
    }

    function normalizeHexColor(value, fallback) {
      const defaultValue = /^#([0-9a-fA-F]{6})$/.test(fallback ?? '') ? fallback.toLowerCase() : '#ffffff';
      if (typeof value !== 'string') return defaultValue;
      const trimmed = value.trim();
      const long = trimmed.match(/^#([0-9a-fA-F]{6})$/);
      if (long) {
        return `#${long[1].toLowerCase()}`;
      }
      const short = trimmed.match(/^#([0-9a-fA-F]{3})$/);
      if (short) {
        return '#' + short[1].toLowerCase().split('').map(ch => ch + ch).join('');
      }
      return defaultValue;
    }

    function normalizeRgbaColor(value, fallback, overrideAlpha) {
      const parsedValue = parseColorValue(value);
      const parsed = parsedValue || parseColorValue(fallback);
      const safe = parsed || { r: 255, g: 255, b: 255, a: 1 };
      const hasRgbaSyntax = typeof value === 'string' && value.toLowerCase().includes('rgba');
      const hasExplicitAlpha = Boolean(parsedValue && ((typeof parsedValue.a === 'number' && parsedValue.a !== 1) || hasRgbaSyntax));
      const r = clamp(Math.round(safe.r), 0, 255);
      const g = clamp(Math.round(safe.g), 0, 255);
      const b = clamp(Math.round(safe.b), 0, 255);
      const useOverride = typeof overrideAlpha === 'number' && !hasExplicitAlpha;
      const sourceAlpha = useOverride ? overrideAlpha : safe.a;
      const alphaNumber = clamp(Number(sourceAlpha), 0, 1);
      const alpha = alphaNumber === 1 ? '1' : (Math.round(alphaNumber * 100) / 100).toString();
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function normalizeColorValue(value, fallback, format) {
      return (format || 'hex') === 'rgb'
        ? normalizeRgbaColor(value, fallback)
        : normalizeHexColor(value, fallback);
    }

    function readLegacyOpacity(key) {
      const raw = localStorage.getItem(key);
      if (raw === null) return undefined;
      const numeric = Number(raw);
      if (!Number.isFinite(numeric)) return undefined;
      return clamp(numeric / 100, 0, 1);
    }

    function parseColorValue(input) {
      if (typeof input !== 'string') return null;
      const trimmed = input.trim();
      if (!trimmed) return null;
      const hexShort = trimmed.match(/^#([0-9a-fA-F]{3})$/);
      if (hexShort) {
        const expanded = '#' + hexShort[1].split('').map(ch => ch + ch).join('');
        return parseColorValue(expanded);
      }
      const hexLong = trimmed.match(/^#([0-9a-fA-F]{6})$/);
      if (hexLong) {
        const value = hexLong[1];
        return {
          r: parseInt(value.slice(0, 2), 16),
          g: parseInt(value.slice(2, 4), 16),
          b: parseInt(value.slice(4, 6), 16),
          a: 1
        };
      }
      const hexWithAlpha = trimmed.match(/^#([0-9a-fA-F]{8})$/);
      if (hexWithAlpha) {
        const value = hexWithAlpha[1];
        return {
          r: parseInt(value.slice(0, 2), 16),
          g: parseInt(value.slice(2, 4), 16),
          b: parseInt(value.slice(4, 6), 16),
          a: parseInt(value.slice(6, 8), 16) / 255
        };
      }
      const rgbMatch = trimmed.match(/^rgba?\(([^)]+)\)$/);
      if (rgbMatch) {
        const parts = rgbMatch[1].split(',').map(part => part.trim()).filter(Boolean);
        if (parts.length < 3) {
          return null;
        }
        const r = parseColorChannel(parts[0]);
        const g = parseColorChannel(parts[1]);
        const b = parseColorChannel(parts[2]);
        if (r === null || g === null || b === null) {
          return null;
        }
        const a = parts[3] !== undefined ? parseColorAlpha(parts[3]) : 1;
        if (a === null) {
          return null;
        }
        return { r, g, b, a };
      }
      return null;
    }

    function parseColorChannel(value) {
      if (typeof value !== 'string') return null;
      const trimmed = value.trim();
      if (!trimmed) return null;
      if (trimmed.endsWith('%')) {
        const numeric = Number(trimmed.slice(0, -1));
        if (!Number.isFinite(numeric)) return null;
        return clamp(Math.round((numeric / 100) * 255), 0, 255);
      }
      const numeric = Number(trimmed);
      if (!Number.isFinite(numeric)) return null;
      return clamp(Math.round(numeric), 0, 255);
    }

    function parseColorAlpha(value) {
      if (typeof value !== 'string') return 1;
      const trimmed = value.trim();
      if (!trimmed) return 1;
      if (trimmed.endsWith('%')) {
        const numeric = Number(trimmed.slice(0, -1));
        if (!Number.isFinite(numeric)) return 1;
        return clamp(numeric / 100, 0, 1);
      }
      const numeric = Number(trimmed);
      if (!Number.isFinite(numeric)) return 1;
      return clamp(numeric, 0, 1);
    }

    function clamp(value, min, max) {
      if (!Number.isFinite(value)) return min;
      return Math.min(max, Math.max(min, value));
    }

    function toNumber(value, fallback) {
      const num = Number(value);
      return Number.isFinite(num) ? num : fallback;
    }

    function getStoredNumber(key, fallback) {
      const raw = localStorage.getItem(key);
      if (raw === null) return fallback;
      return toNumber(raw, fallback);
    }

    function mapSliderToDelay(value) {
      const slow = 160;
      const fast = 28;
      return slow - (slow - fast) * (value / 100);
    }

    function describeSpeed(value) {
      if (value <= 15) return '很慢';
      if (value <= 45) return '偏慢';
      if (value <= 65) return '中等';
      if (value <= 85) return '偏快';
      return '很快';
    }

    function loadJSON(key, fallback) {
      try {
        return JSON.parse(localStorage.getItem(key)) ?? fallback;
      } catch {
        return fallback;
      }
    }</script><script defer="defer" src="main.33348cd273a9f22c79bd.js"></script><script defer="defer" src="main.33348cd273a9f22c79bd.js"></script><script defer="defer" src="main.33348cd273a9f22c79bd.js"></script><style>/*全屏无黑边*/body.vn-fullscreen-mode #responsive-container{width:100vw!important;height:100vh!important;max-width:none!important;border:none!important;border-radius:0!important;margin:0!important;box-shadow:none!important}/*防盗图:禁止长按右键拖拽*/img{-webkit-touch-callout:none!important;-webkit-user-select:none!important;user-select:none!important;-webkit-user-drag:none!important;pointer-events:auto!important}div{-webkit-tap-highlight-color:transparent!important}/*全屏按钮样式*/#fullscreen-toggle-btn .icon-exit{display:none}#fullscreen-toggle-btn.is-active .icon-exit{display:block}#fullscreen-toggle-btn.is-active .icon-enter{display:none}/*布局修复*/#control-bar .control-group{max-width:none!important;flex-wrap:nowrap!important}#control-bar{max-width:100%;overflow-x:auto}#control-bar::-webkit-scrollbar{display:none}</style><script>document.addEventListener('DOMContentLoaded',()=>{/*防盗:禁右键*/document.addEventListener('contextmenu',e=>{if(e.target.tagName==='IMG'||e.target.closest('.cg-overlay-content')||e.target.closest('#cg-list')){e.preventDefault();e.stopPropagation()}},{passive:false});/*界面按钮逻辑*/const g=document.getElementById('control-group');if(!g)return;const b=document.createElement('button');b.id='fullscreen-toggle-btn';b.title='进入全屏';/*图标:进入(向外扩)和退出(向内收)*/b.innerHTML='<span class=\"icon-enter\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"128\" height=\"128\" viewBox=\"0 0 24 24\"><path fill=\"currentColor\" d=\"M5 5h5v2H7v3H5V5zm5 14H5v-5h2v3h3v2zm9-5h2v5h-5v-2h3v-3zm-2-9h5v5h-2V7h-3V5z\"/></svg></span><span class=\"icon-exit\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"128\" height=\"128\" viewBox=\"0 0 24 24\"><path fill=\"currentColor\" d=\"M10 17H7v-2h5v5h-2v-3zm-3-5V7h2v3h3v2H7zm10 0h-5V7h2v3h3v2zm-2 5v3h-2v-5h5v2h-3z\"/></svg></span>';/*点击:切换全屏状态*/b.addEventListener('click',e=>{e.stopPropagation();if(!document.fullscreenElement){document.documentElement.requestFullscreen().catch(()=>{})}else{if(document.exitFullscreen)document.exitFullscreen()}});g.insertBefore(b,g.firstChild);/*监听状态变化切换图标*/document.addEventListener('fullscreenchange',()=>{if(document.fullscreenElement){document.body.classList.add('vn-fullscreen-mode');b.classList.add('is-active');b.title='退出全屏'}else{document.body.classList.remove('vn-fullscreen-mode');b.classList.remove('is-active');b.title='进入全屏'}})});</script>
<script>document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){var h=document.querySelector("#cg-gallery h3");if(h){var b=document.createElement("button");b.innerText="🗑️ 清空";b.style.cssText="float:right;font-size:13px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:inherit;border-radius:6px;cursor:pointer;padding:4px 8px;margin-top:-2px;";b.onclick=function(){if(confirm("确定要清空所有已解锁的CG吗？此操作无法撤销。")){localStorage.removeItem("vn.cgUnlocked");location.reload()}};h.appendChild(b)}},1000)});</script><!-- === 终极视觉小说系统 (分段 1/3：样式与基础) === -->
<style>
  /* 立绘容器基础样式 */
  .vn-sprite-slot {
    position: absolute;
    bottom: 0;
    max-height: 100%;
    max-width: 85%;
    /* 平滑过渡：透明度和滤镜 */
    transition: opacity 0.3s ease, filter 0.3s ease, transform 0s;
    pointer-events: none;
    transform-origin: bottom center;
  }
  /* 活跃状态：高亮、层级高、微微放大 */
  .vn-sprite-active {
    filter: brightness(1.05) grayscale(0);
    z-index: 10;
    transform: scale(1.02);
  }
  /* 非活跃状态：变暗、层级低 */
  .vn-sprite-inactive {
    filter: brightness(0.5) grayscale(0.1);
    z-index: 5;
  }
  /* 普通状态（单人模式用）：无滤镜 */
  .vn-sprite-normal {
    filter: none;
    z-index: 10;
  }
</style>

<script>
(function() {
  // 1. 初始化舞台结构
  // 把原来的单个立绘位置，改造成两个固定槽位 (Slot 1 和 Slot 2)
  var layer = document.getElementById('character-layer');
  if (layer) {
    layer.innerHTML = ''; // 清空原有内容
    var s1 = document.createElement('img');
    s1.id = 'char-slot-1';
    s1.className = 'vn-sprite-slot';
    layer.appendChild(s1);

    var s2 = document.createElement('img');
    s2.id = 'char-slot-2';
    s2.className = 'vn-sprite-slot';
    layer.appendChild(s2);
  }

  // 2. 配置与状态变量
  var KEY = 'vn.spriteSystem_v3';
  // 默认配置
  var cfg = {
    dualMode: true, // 核心开关：默认开启双人模式
    dual: {
      s1: { x: -250, y: 0, s: 1 }, // 左位默认参数
      s2: { x: 250, y: 0, s: 1 }   // 右位默认参数
    },
    single: { x: 0, y: 0, s: 1 },  // 单人模式默认居中
    activeTab: 'slot1'
  };
  // 读取本地存储
  try {
    var saved = JSON.parse(localStorage.getItem(KEY));
    if (saved) {
      // 简单的浅合并
      if (saved.dualMode !== undefined) cfg.dualMode = saved.dualMode;
      if (saved.dual) cfg.dual = saved.dual;
      if (saved.single) cfg.single = saved.single;
    }
  } catch (e) {}

  // 运行时状态记录
  var state = { activeSlot: 1, slot1Key: null, slot2Key: null };
// (第一段结束，请继续复制第二段)
  // === 分段 2/3：核心逻辑函数 ===

  // 3. 渲染逻辑 (双模式分流)
  window.applySpriteForScene = function(scene) {
    var raw = scene.sprite;

    // undefined: 这一行没有立绘指令 -> 保持画面，仅更新说话人高亮
    if (raw === undefined) {
      if (cfg.dualMode) updateDimming(scene.speaker);
      return;
    }

    // null: 脚本明确要求清空立绘 -> 隐藏所有
    if (raw === null) {
      fadeOut(1); fadeOut(2);
      state.slot1Key = null; state.slot2Key = null;
      return;
    }

    // 解析立绘链接 (兼容旧代码逻辑)
    var url = '';
    if (window.立绘URL) url = window.立绘URL(raw, scene.index || 0);
    // 兜底：如果是文件名则拼接链接
    if (!url) url = (raw.includes('/') ? raw : 'https://files.catbox.moe/' + raw + '.png');

    // === 核心分支 ===
    if (!cfg.dualMode) {
      // --- 单人模式 ---
      // 强制使用 Slot 1，隐藏 Slot 2
      fadeIn(1, url);
      fadeOut(2);
      // 清除可能残留的双人模式滤镜
      var el = document.getElementById('char-slot-1');
      if (el) el.className = 'vn-sprite-slot vn-sprite-normal';
      // 重置状态
      state.slot1Key = url; state.slot2Key = null;
    } else {
      // --- 双人模式 ---
      // 检查：该角色是否已在台上？
      if (state.slot1Key === url) {
        state.activeSlot = 1;
        updateDimming(scene.speaker);
      } else if (state.slot2Key === url) {
        state.activeSlot = 2;
        updateDimming(scene.speaker);
      } else {
        // 新角色登场：顶替掉当前“非焦点”的那个位置
        var target = (state.activeSlot === 1) ? 2 : 1;
        // 如果有空位，优先填空位
        if (!state.slot1Key) target = 1;
        else if (!state.slot2Key) target = 2; // 修正逻辑：优先填空

        fadeIn(target, url);
        state.activeSlot = target;
        // 更新记录
        if (target === 1) state.slot1Key = url; else state.slot2Key = url;
        updateDimming(scene.speaker);
      }
    }
  };

  // 辅助函数：显示图片
  function fadeIn(idx, url) {
    var img = document.getElementById('char-slot-' + idx);
    if (!img) return;
    // 如果图片完全没变且已显示，直接跳过
    if (img.dataset.src === url && img.style.opacity === '1') return;

    img.style.opacity = '0';
    img.src = url;
    img.dataset.src = url;
    img.onload = function() {
      img.style.opacity = '1';
      window.updateSpritePositions(); // 确保位置正确
    };
  }

  // 辅助函数：隐藏图片
  function fadeOut(idx) {
    var img = document.getElementById('char-slot-' + idx);
    if (img) {
      img.style.opacity = '0';
      img.dataset.src = '';
    }
  }

  // 辅助函数：更新高亮 (仅双人模式有效)
  function updateDimming(speaker) {
    if (!cfg.dualMode) return;
    var s1 = document.getElementById('char-slot-1');
    var s2 = document.getElementById('char-slot-2');
    if (state.activeSlot === 1) { hl(s1, 1); hl(s2, 0); }
    else { hl(s1, 0); hl(s2, 1); }
  }

  function hl(el, on) {
    if (!el) return;
    if (on) {
      el.classList.remove('vn-sprite-inactive');
      el.classList.add('vn-sprite-active');
    } else {
      el.classList.remove('vn-sprite-active');
      el.classList.add('vn-sprite-inactive');
    }
  }

  // 4. 位置应用引擎
  window.updateSpritePositions = function() {
    var s1 = document.getElementById('char-slot-1');
    var s2 = document.getElementById('char-slot-2');

    if (!cfg.dualMode) {
      // 单人模式：应用 single 配置
      if (s1) s1.style.transform = 'translateX(calc(-50% + ' + cfg.single.x + 'px)) translateY(' + cfg.single.y + 'px) scale(' + cfg.single.s + ')';
      if (s2) s2.style.visibility = 'hidden'; // 强制隐藏右位
    } else {
      // 双人模式：应用 dual 配置
      if (s1) {
        s1.style.visibility = 'visible';
        s1.style.transform = 'translateX(calc(-50% + ' + cfg.dual.s1.x + 'px)) translateY(' + cfg.dual.s1.y + 'px) scale(' + cfg.dual.s1.s + ')';
      }
      if (s2) {
        s2.style.visibility = 'visible';
        s2.style.transform = 'translateX(calc(-50% + ' + cfg.dual.s2.x + 'px)) translateY(' + cfg.dual.s2.y + 'px) scale(' + cfg.dual.s2.s + ')';
      }
    }
  };
// (第二段结束，请继续复制第三段)
  // === 分段 3/3：界面与交互 ===

  // 5. 构建 UI
  setTimeout(function() {
    // 清理旧按钮
    var oldB = document.getElementById('dual-adj-btn'); if(oldB) oldB.remove();
    var oldP = document.getElementById('dual-adj-panel'); if(oldP) oldP.remove();

    var gr = document.querySelector('#control-bar .control-group');
    if (!gr) return; // 没找到控制栏则退出

    // 创建按钮
    var btn = document.createElement('button');
    btn.id = 'dual-adj-btn';
    btn.title = '立绘设置';
    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-6 8a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V12z"/></svg>';
    var ref = document.getElementById('auto-toggle');
    if (ref) gr.insertBefore(btn, ref); else gr.appendChild(btn);

    // 创建面板
    var p = document.createElement('div');
    p.id = 'dual-adj-panel';
    p.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;padding:20px;border-radius:16px;background:var(--panel-bg);color:var(--panel-text-color);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 30px 60px rgba(0,0,0,0.6);z-index:10000;display:none;flex-direction:column;gap:15px;font-size:14px;';

    p.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong style="font-size:16px;">立绘设置</strong>
        <span id="ds-close" style="cursor:pointer;font-size:20px;">×</span>
      </div>
      <label style="background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
        <span>开启双人演出模式</span>
        <input type="checkbox" id="ds-mode-toggle" style="width:20px;height:20px;accent-color:#165dff;">
      </label>
      <div id="ds-tabs" style="display:flex;background:rgba(255,255,255,0.08);border-radius:8px;padding:2px;">
        <div id="t-s1" style="flex:1;text-align:center;padding:6px;cursor:pointer;border-radius:6px;">左位</div>
        <div id="t-s2" style="flex:1;text-align:center;padding:6px;cursor:pointer;border-radius:6px;opacity:0.5;">右位</div>
      </div>
      <div id="ds-single-label" style="text-align:center;opacity:0.7;font-size:12px;display:none;">(当前调整：唯一角色位置)</div>
      <div style="display:flex;gap:10px;"><span style="width:30px;">缩放</span><input id="ds-s" type="range" min="0.5" max="1.5" step="0.05" style="flex:1"><span id="v-s" style="width:30px;text-align:right;">1.0</span></div>
      <div style="display:flex;gap:10px;"><span style="width:30px;">水平</span><input id="ds-x" type="range" min="-1200" max="1200" step="10" style="flex:1"><span id="v-x" style="width:30px;text-align:right;">0</span></div>
      <div style="display:flex;gap:10px;"><span style="width:30px;">垂直</span><input id="ds-y" type="range" min="-500" max="500" step="10" style="flex:1"><span id="v-y" style="width:30px;text-align:right;">0</span></div>
      <button id="ds-reset" style="padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:inherit;cursor:pointer;">重置位置</button>
    `;
    document.body.appendChild(p);

    var els = {
      mode: document.getElementById('ds-mode-toggle'),
      tabs: document.getElementById('ds-tabs'),
      sLabel: document.getElementById('ds-single-label'),
      t1: document.getElementById('t-s1'), t2: document.getElementById('t-s2'),
      s: document.getElementById('ds-s'), x: document.getElementById('ds-x'), y: document.getElementById('ds-y'),
      ls: document.getElementById('v-s'), lx: document.getElementById('v-x'), ly: document.getElementById('v-y')
    };

    function refUI() {
      els.mode.checked = cfg.dualMode;
      if (cfg.dualMode) {
        els.tabs.style.display = 'flex'; els.sLabel.style.display = 'none';
        els.t1.style.background = cfg.activeTab==='slot1'?'rgba(255,255,255,0.15)':'transparent';
        els.t1.style.opacity = cfg.activeTab==='slot1'?1:0.5;
        els.t2.style.background = cfg.activeTab==='slot2'?'rgba(255,255,255,0.15)':'transparent';
        els.t2.style.opacity = cfg.activeTab==='slot2'?1:0.5;
        bindVals((cfg.activeTab==='slot1') ? cfg.dual.s1 : cfg.dual.s2);
      } else {
        els.tabs.style.display = 'none'; els.sLabel.style.display = 'block';
        bindVals(cfg.single);
      }
    }
    function bindVals(d) {
      els.s.value = d.s; els.ls.textContent = d.s;
      els.x.value = d.x; els.lx.textContent = d.x;
      els.y.value = d.y; els.ly.textContent = d.y;
    }
    function save() { localStorage.setItem(KEY, JSON.stringify(cfg)); window.updateSpritePositions(); }
    function setD(k, v) {
      if(cfg.dualMode) {
        if(cfg.activeTab==='slot1') cfg.dual.s1[k]=v; else cfg.dual.s2[k]=v;
      } else { cfg.single[k]=v; }
      save();
    }

    els.mode.onchange = function(e) {
      cfg.dualMode = e.target.checked;
      refUI(); save();
      // 切换到单人时清理战场
      if(!cfg.dualMode) {
        var s2=document.getElementById('char-slot-2'); if(s2) s2.style.opacity='0';
        var s1=document.getElementById('char-slot-1'); if(s1) s1.className='vn-sprite-slot vn-sprite-normal';
      }
    };
    els.t1.onclick = function() { cfg.activeTab='slot1'; refUI(); };
    els.t2.onclick = function() { cfg.activeTab='slot2'; refUI(); };
    els.s.oninput = function(e) { setD('s', parseFloat(e.target.value)); els.ls.textContent=e.target.value; };
    els.x.oninput = function(e) { setD('x', parseInt(e.target.value)); els.lx.textContent=e.target.value; };
    els.y.oninput = function(e) { setD('y', parseInt(e.target.value)); els.ly.textContent=e.target.value; };
    document.getElementById('ds-reset').onclick = function() {
      if(cfg.dualMode) {
        if(cfg.activeTab==='slot1') cfg.dual.s1={x:-250,y:0,s:1}; else cfg.dual.s2={x:250,y:0,s:1};
      } else { cfg.single={x:0,y:0,s:1}; }
      refUI(); save();
    };

    btn.onclick = function(e) { e.stopPropagation(); p.style.display='flex'; refUI(); };
    document.getElementById('ds-close').onclick = function() { p.style.display='none'; };
    document.addEventListener('click', function(e) {
      if(p.style.display==='flex' && !p.contains(e.target) && e.target!==btn) p.style.display='none';
    });

    window.updateSpritePositions();
  }, 1000);
})();
</script>
<!-- === 代码结束 === -->
</body></html>
```